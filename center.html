<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ศูนย์กู้ภัยแห่งชาติ • แผนที่เต็มจอ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#000}
  #map{width:100%;height:100%}
  .header{position:fixed;top:0;left:0;right:0;background:#c62828;color:#fff;padding:12px 16px;font-size:1.4rem;font-weight:bold;text-align:center;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,0.5)}
  #alert{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:#ff1744;color:#fff;padding:16px 40px;border-radius:12px;font-size:1.8rem;font-weight:900;z-index:9999;display:none;animation:shake 0.5s infinite;box-shadow:0 0 30px #ff1744}
  @keyframes shake{0%,100%{transform:translateX(-50%) rotate(0)}25%{transform:translateX(-52%) rotate(-3deg)}75%{transform:translateX(-48%) rotate(3deg)}}
  #stopAlert{position:fixed;top:160px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:10px 30px;border:2px solid #ff1744;border-radius:10px;font-weight:bold;z-index:9999;cursor:pointer;display:none}
</style>
</head>
<body>

<div class="header">ศูนย์กู้ภัยแห่งชาติ • แผนที่ปฏิบัติการจริง</div>
<div id="alert">เคสด่วนระดับ 5 เข้ามา!</div>
<button id="stopAlert" onclick="stop()">หยุดเสียงแจ้งเตือน</button>

<div id="map"></div>

<audio id="alarm" src="https://cdn.jsdelivr.net/gh/nzbin/three-dots@master/dist/audio/alert-critical.mp3" loop></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.2/dist/leaflet.markercluster.js"></script>

<script>
firebase.initializeApp({databaseURL:"https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app"});
const db = firebase.database().ref("sos_requests");

const map = L.map('map').setView([13.7563, 100.5018], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

const markers = L.markerClusterGroup({
  maxClusterRadius: 50,
  iconCreateFunction: function(cluster) {
    const count = cluster.getChildCount();
    return L.divIcon({
      html: `<div style="background:#c62828;color:#fff;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:3px solid #fff">${count}</div>`,
      className: 'cluster',
      iconSize: [40, 40]
    });
  }
});
map.addLayer(markers);

function getColor(p) {
  if (p >= 5) return '#ff1744';
  if (p >= 4) return '#ff9100';
  return '#43a047';
}

db.on('child_added', snap => {
  const d = snap.val();
  if (!d?.location?.lat || !d?.location?.lng) return;

  const prio = d.priority || 3;
  const status = d.status || 'pending';

  if (status === 'completed') return;

  const icon = L.divIcon({
    html: `<div style="background:${getColor(prio)};color:#fff;width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px;border:3px solid #fff;box-shadow:0 0 15px #000">${prio}</div>`,
    iconSize: [44, 44],
    iconAnchor: [22, 22],
    className: ''
  });

  const marker = L.marker([d.location.lat, d.location.lng], {icon});
  
  const types = Array.isArray(d.types) ? d.types.join(', ') : 'ไม่ระบุ';

  marker.bindPopup(`
    <div style="font-family:Arial,sans-serif;min-width:200px">
      <b style="font-size:1.3rem;color:${getColor(prio)}">ด่วนระดับ ${prio}</b><br>
      <b>${d.name || 'ไม่ระบุชื่อ'}</b><br>
      ${d.phone ? `โทร: <a href="tel:${d.phone}">${d.phone}</a><br>` : ''}
      ประเภท: ${types}<br>
      เวลา: ${new Date(d.timestamp).toLocaleString('th-TH')}<br>
      <hr style="margin:8px 0">
      <button onclick="window.open('https://maps.google.com/maps?daddr=${d.location.lat},${d.location.lng}')" 
              style="background:#1565c0;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer">
        นำทางไปยังจุด
      </button>
    </div>
  `, {maxWidth: 300});

  markers.addLayer(marker);

  // แจ้งเตือนทันทีถ้า priority 4-5
  if (prio >= 4) {
    document.getElementById('alert').style.display = 'block';
    document.getElementById('stopAlert').style.display = 'block';
    document.getElementById('alarm').play().catch(() => {});
    if (navigator.vibrate) navigator.vibrate([1000,500,1000]);
  }
});

function stop() {
  document.getElementById('alarm').pause();
  document.getElementById('alert').style.display = 'none';
  document.getElementById('stopAlert').style.display = 'none';
}
</script>
</body>
</html>

