<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ศูนย์กู้ภัยแห่งชาติ • ครบทุกเคส 100%</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.2/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.2/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    :root{--red:#c62828;--p5:#ff1744;--p4:#ff9800;--p3:#4caf50;--bg:#0d1117;--card:#161b22}
    *{margin:0;padding:0;box-sizing:border-box}
    body,html{height:100%;background:var(--bg);color:#fff;font-family:'Prompt',sans-serif;overflow:hidden}
    .container{display:flex;height:100vh;position:relative}

    .sidebar{width:430px;background:var(--bg);border-right:6px solid var(--red);display:flex;flex-direction:column;z-index:1000;transition:0.4s}
    .sidebar.hidden{transform:translateX(-100%)}

    .header{background:var(--red);padding:14px 0;text-align:center;font-size:1.9rem;font-weight:900;color:#fff}
    .stats-bar{background:#111;padding:8px 12px;font-size:0.95rem;display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px}
    .stats-bar span{color:#0f0;font-weight:900}

    .controls{padding:8px;background:#111;display:flex;gap:6px;flex-wrap:wrap}
    .btn-sm{padding:8px 12px;background:#333;border:none;border-radius:8px;font-size:0.9rem;cursor:pointer}
    .btn-sm.active{background:var(--red);color:#fff}

    .list{flex:1;overflow-y:auto;padding:6px 8px}
    .card{background:var(--card);margin:6px 4px;padding:10px;border-radius:10px;
      border-left:5px solid #555;box-shadow:0 3px 10px rgba(0,0,0,0.5);
      transition:0.2s;cursor:pointer;font-size:0.93rem;position:relative}
    .card:hover{background:#1e1e2e;transform:translateY(-2px)}
    .card.p5{border-left-color:var(--p5);background:#330011}
    .card.p4{border-left-color:var(--p4)}
    .card.p3{border-left-color:var(--p3)}

    .card-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:0.98rem}
    .prio{font-size:1.35rem;font-weight:900}
    .time{font-size:0.8rem;color:#aaa}
    .location{font-size:0.9rem;margin:4px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .types{display:flex;flex-wrap:wrap;gap:4px;margin:4px 0}
    .type{font-size:0.75rem;background:rgba(255,255,255,0.15);padding:2px 8px;border-radius:8px}
    .actions{margin-top:6px;display:flex;gap:4px;font-size:0.8rem}
    .btn-tiny{padding:6px 8px;border:none;border-radius:6px;cursor:pointer;flex:1;font-weight:700}

    .small-marker{width:40px;height:40px;margin-left:-20px!important;margin-top:-20px!important}
    .small-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      font-size:18px;font-weight:900;color:#fff;border:4px solid #fff;box-shadow:0 0 15px #000}
    .small-icon.p5{background:var(--p5)}
    .small-icon.p4{background:var(--p4)}
    .small-icon.p3{background:var(--p3)}

    #map{flex:1}
    .status-bar{position:absolute;bottom:0;left:0;width:100%;background:rgba(0,0,0,0.9);padding:8px;text-align:center;font-weight:700;z-index:1000}
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar" id="sidebar">
      <div class="header">ศูนย์กู้ภัยแห่งชาติ</div>
      
      <div class="stats-bar">
        <div>ในระบบ: <span id="total-all">0</span> เคส</div>
        <div>แสดงอยู่: <span id="total-show">0</span> เคส</div>
        <button class="btn-sm" style="background:#ff9800" onclick="forceReload()">รีเฟรชทั้งหมด</button>
      </div>

      <div class="controls">
        <button class="btn-sm active" id="tab-active">กำลังช่วย <span id="c1">0</span></button>
        <button class="btn-sm" id="tab-urgent">ด่วน 4-5 <span id="c2">0</span></button>
        <button class="btn-sm" id="tab-done">เสร็จแล้ว <span id="c3">0</span></button>
        <button class="btn-sm" id="toggle-sidebar">ซ่อน Sidebar</button>
      </div>

      <div class="list" id="list"></div>
    </div>
    <div id="map"></div>
  </div>

  <div class="status-bar">
    <span id="clock"></span> | ทั้งหมด <span id="total">0</span> • ดำเนินการ <span id="activeCount">0</span> • ด่วน <span id="urgentCount">0</span>
  </div>

  <audio id="a5" src="https://cdn.jsdelivr.net/gh/nzbin/three-dots@master/dist/audio/alert-critical.mp3" preload="auto"></audio>
  <audio id="a4" src="https://cdn.jsdelivr.net/gh/nzbin/three-dots@master/dist/audio/alert-high.mp3" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.2/dist/leaflet.markercluster.js"></script>

  <script>
    firebase.initializeApp({databaseURL:"https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app"});
    const db = firebase.database().ref("sos_requests");

    const map = L.map('map').setView([13.7563, 100.5018], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = {};           // เก็บทุกเคสตลอดไป (ไม่ลบออกจาก object)
    const cluster = L.markerClusterGroup({maxClusterRadius: 50});
    map.addLayer(cluster);

    let currentTab = 'active';

    // นาฬิกา
    setInterval(()=>document.getElementById('clock').innerText = new Date().toLocaleString('th-TH'),1000);

    // ปุ่มต่าง ๆ
    document.getElementById('tab-active').onclick = () => { currentTab='active'; render(); highlight('tab-active'); }
    document.getElementById('tab-urgent').onclick = () => { currentTab='urgent'; render(); highlight('tab-urgent'); }
    document.getElementById('tab-done').onclick   = () => { currentTab='done';   render(); highlight('tab-done'); }
    function highlight(id){ document.querySelectorAll('.btn-sm').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    document.getElementById('toggle-sidebar').onclick = () => {
      document.getElementById('sidebar').classList.toggle('hidden');
    };

    // บังคับรีโหลดทั้งหมด
    window.forceReload = () => {
      location.reload();
    };

    const addrCache = {};
    async function getAddr(lat,lng){
      const key = `${lat.toFixed(5)},${lng.toFixed(5)}`;
      if(addrCache[key]) return addrCache[key];
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&accept-language=th`);
        const d = await r.json();
        const addr = [d.address?.village||d.address?.suburb, d.address?.town||d.address?.city, d.address?.state].filter(Boolean).join(', ');
        addrCache[key] = addr || 'พิกัด GPS';
        return addrCache[key];
      }catch(e){return 'พิกัด GPS'}
    }

    function createMarker(lat,lng,prio,id,data){
      const cls = prio>=5?'p5':prio>=4?'p4':'p3';
      const icon = L.divIcon({
        html:`<div class="small-marker"><div class="small-icon ${cls}">${prio}</div></div>`,
        iconSize:[40,40], iconAnchor:[20,20]
      });
      const m = L.marker([lat,lng],{icon});
      m.bindPopup(`<b>ด่วน ${prio}</b> • ${data.name||'ไม่ระบุ'}<br>กำลังโหลดที่อยู่...`);
      getAddr(lat,lng).then(addr=>m.bindPopup(`<b>ด่วน ${prio}</b> • ${data.name||'ไม่ระบุ'}<br>${addr}<br>${new Date(data.timestamp).toLocaleString('th-TH')}`));
      return m;
    }

    function createCard(id,data,addr){
      const card = document.createElement('div');
      card.className = `card p${data.priority}`;
      card.onclick = () => map.setView([data.location.lat,data.location.lng],18);
      card.innerHTML = `
        <div class="card-header">
          <div class="prio">${data.priority}</div>
          <div>${data.name||'ไม่ระบุ'}</div>
          <div class="time">${new Date(data.timestamp).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</div>
        </div>
        <div class="location">ที่ตั้ง ${addr}</div>
        <div class="types">${data.types.map(t=>`<span class="type">${t}</span>`).join('')}</div>
        <div class="actions">
          ${data.phone?`<button class="btn-tiny" style="background:#1b5e20" onclick="event.stopPropagation();location.href='tel:${data.phone}'">โทร</button>`:''}
          <button class="btn-tiny" style="background:#1565c0" onclick="event.stopPropagation();window.open('https://maps.google.com/maps/dir/?api=1&destination=${data.location.lat},${data.location.lng}')">นำทาง</button>
          <button class="btn-tiny" style="background:#6a1b9a" onclick="event.stopPropagation();if(confirm('เสร็จสิ้น?'))db.child('${id}').update({status:'completed'})">เสร็จ</button>
        </div>
      `;
      return card;
    }

    async function render(){
      const list = document.getElementById('list');
      list.innerHTML = '';

      const filtered = Object.entries(markers)
        .filter(([_,v]) => {
          if(currentTab==='done') return v.data.status==='completed';
          if(currentTab==='urgent') return v.data.priority>=4 && v.data.status!=='completed';
          return v.data.status!=='completed';
        })
        .sort(([_,a],[__,b]) => b.data.priority - a.data.priority || b.data.timestamp - a.data.timestamp);

      document.getElementById('total-show').textContent = filtered.length;

      for(const [id,item] of filtered){
        const addr = await getAddr(item.data.location.lat,item.data.location.lng);
        list.appendChild(createCard(id,item.data,addr));
      }
    }

    function updateAllCounters(){
      let all=0, active=0, urgent=0, done=0;
      Object.values(markers).forEach(m=>{
        all++;
        if(m.data.status==='completed') done++;
        else{ active++; if(m.data.priority>=4) urgent++; }
      });
      document.getElementById('total-all').textContent = all;
      document.getElementById('total').textContent = all;
      document.getElementById('c1').textContent = active;
      document.getElementById('c2').textContent = urgent;
      document.getElementById('c3').textContent = done;
      document.getElementById('activeCount').textContent = active;
      document.getElementById('urgentCount').textContent = urgent;
    }

    // รับข้อมูลทุกครั้งที่ Firebase มีการเปลี่ยนแปลง
    db.on('child_added', s => {
      const d = s.val();
      if(d.location && d.location.lat && d.location.lng){
        const m = createMarker(d.location.lat, d.location.lng, d.priority, s.key, d);
        markers[s.key] = {marker:m, data:d};
        if(d.status!=='completed') cluster.addLayer(m);
        if(d.priority===5) document.getElementById('a5').play();
        else if(d.priority===4) document.getElementById('a4').play();
      }
      render(); updateAllCounters();
    });

    db.on('child_changed', s => {
      const d = s.val();
      if(markers[s.key]){
        markers[s.key].data = d;
        if(d.status==='completed'){
          cluster.removeLayer(markers[s.key].marker);
        }else{
          cluster.addLayer(markers[s.key].marker);
        }
      }
      render(); updateAllCounters();
    });

    // เริ่มต้น
    render(); updateAllCounters();
  </script>
</body>
</html>
