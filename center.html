<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}

        .header{
            position:fixed;top:0;left:0;right:0;height:55px;background:#c41e3a;z-index:1000;
            display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;color:#fff;
        }

        .sidebar{
            position:fixed;top:55px;left:0;bottom:0;width:440px;background:#0a0a0a;
            border-right:5px solid #c41e3a;z-index:999;overflow-y:auto;padding:12px;
        }

        .stats{
            background:#111;padding:12px;border-radius:10px;margin-bottom:12px;text-align:center;
            font-weight:700;font-size:1rem;color:#fff;
        }

        .filter-bar{
            display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;
        }
        .filter-btn{
            flex:1;padding:10px;font-size:0.95rem;border-radius:8px;
            background:rgba(255,255,255,0.1);color:#fff;font-weight:600;cursor:pointer;
        }
        .filter-btn.active{background:#c41e3a;}

        /* การ์ดขาวสะอาดตา */
        .case{
            background:#fff;color:#000;border-radius:12px;padding:16px;
            margin-bottom:12px;box-shadow:0 4px 20px rgba(0,0,0,0.5);
            cursor:pointer;transition:.3s;
        }
        .case:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(196,30,58,0.4);}
        .case.active{border:3px solid #c41e3a;padding:13px;}

        .req-id{font-size:1.2rem;font-weight:700;color:#c41e3a;margin-bottom:8px;}
        .line{display:flex;margin:7px 0;font-size:0.98rem;}
        .label{color:#444;font-weight:600;width:140px;flex-shrink:0;}
        .value{flex:1;}

        .status-tag{
            display:inline-block;padding:6px 14px;border-radius:20px;
            font-weight:700;font-size:0.9rem;color:#fff;margin-top:8px;
        }
        .pending{background:#e74c3c}.going{background:#2980b9}
        .acknowledged{background:#e67e22}.completed{background:#27ae60}
    </style>
</head>
<body>

<div class="header">ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</div>

<div class="sidebar">
    <div class="stats" id="stats">กำลังโหลด...</div>
    <div class="filter-bar">
        <div class="filter-btn active" data-filter="all">ทั้งหมด</div>
        <div class="filter-btn" data-filter="pending">รอช่วย</div>
        <div class="filter-btn" data-filter="going">กำลังไป</div>
        <div class="filter-btn" data-filter="acknowledged">รับทราบ</div>
        <div class="filter-btn" data-filter="completed">เสร็จแล้ว</div>
    </div>
    <div id="list"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    const map = L.map('map').setView([13.94678, 100.56125], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // ใช้ MarkerCluster เพื่อแก้ปัญหาจุดซ้อนกัน
    const markers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        maxClusterRadius: 60
    });
    map.addLayer(markers);

    const cards = {}, list = document.getElementById('list');
    const statsEl = document.getElementById('stats');
    let currentFilter = 'all';

    const DB_URL = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests.json';

    function formatDate(ts){
        const d = new Date(ts);
        const now = Date.now();
        const diffDay = Math.floor((now - ts)/86400000);
        const dayText = diffDay===0 ? 'วันนี้' : diffDay===1 ? 'เมื่อวาน' : `${diffDay} วันที่แล้ว`;
        const thaiYear = d.getFullYear() + 543;
        return `${d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})} ${d.getDate()}/${d.getMonth()+1}/${thaiYear} (${dayText})`;
    }

    function getStatusClass(s){ return s||'pending'; }
    function getStatusText(s){
        return {pending:'รอการช่วยเหลือ', going:'กำลังไป', acknowledged:'รับทราบแล้ว', completed:'เสร็จสิ้น'}[s||'pending'];
    }

    async function load(){
        let data = {};
        try{ data = await (await fetch(DB_URL+'?t='+Date.now())).json() || {}; }
        catch{ list.innerHTML='<div style="color:#f66;padding:80px;text-align:center">เชื่อมต่อไม่ได้</div>'; return; }

        const counts = {all:0,pending:0,going:0,acknowledged:0,completed:0};
        const frag = document.createDocumentFragment();
        markers.clearLayers(); // ล้าง marker เก่าทั้งหมด

        const sorted = Object.entries(data).sort((a,b)=> b[1].timestamp - a[1].timestamp);

        sorted.forEach(([id,r])=>{
            const status = r.status || 'pending';
            counts.all++; counts[status]++;

            const lat = r.location?.lat;
            const lng = r.location?.lng;
            const hasLoc = lat && lng;

            const reqId = r.requestId || id.slice(-12).toUpperCase();

            // สร้างการ์ด
            const card = document.createElement('div');
            card.className = 'case';
            card.dataset.status = status;
            card.innerHTML = `
                <div class="req-id">เลขคำขอ: ${reqId}</div>
                <div class="line"><span class="label">รับแจ้งเมื่อ:</span><span class="value">${formatDate(r.timestamp)}</span></div>
                <div class="line"><span class="label">สถานะ:</span><span class="value"><span class="status-tag ${getStatusClass(status)}">${getStatusText(status)}</span></span></div>
                <div class="line"><span class="label">ความต้องการ:</span><span class="value">${(r.types||[]).join(', ') || '-'}</span></div>
                <div class="line"><span class="label">ผู้แจ้ง:</span><span class="value">${r.name || r.fullname || '-'}</span></div>
                <div class="line"><span class="label">ข้อความ:</span><span class="value">${r.note || '-'}</span></div>
                <div class="line"><span class="label">อัปเดตล่าสุด:</span><span class="value">${formatDate(r.timestamp)}</span></div>
            `;

            card.onclick = ()=>{
                document.querySelectorAll('.case').forEach(c=>c.classList.remove('active'));
                card.classList.add('active');
                if(hasLoc) map.setView([lat,lng], 18);
            };

            frag.appendChild(card);
            cards[id] = card;

            // เพิ่ม Marker (ใช้ cluster)
            if(hasLoc){
                const color = status==='completed'?'#27ae60':(r.priority>=5?'#c41e3a':'#e74c3c');
                const icon = L.divIcon({
                    html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:3px solid #fff;box-shadow:0 0 8px #000;"></div>`,
                    className: 'tiny-marker',
                    iconSize: [22,22]
                });

                const m = L.marker([lat,lng], {icon});
                m.bindPopup(`
                    <div style="font-size:0.95rem;line-height:1.8">
                        <b>เลขคำขอ:</b> ${reqId}<br>
                        <b>ชื่อ:</b> ${r.name||'-'}<br>
                        <b>โทร:</b> ${r.phone?`<a href="tel:${r.phone}" style="color:#0ff">${r.phone}</a>`:'-'}<br>
                        <b>ความต้องการ:</b> ${(r.types||[]).join(', ')}<br>
                        <b>ข้อความ:</b> ${r.note||'-'}<br>
                        <b>พิกัด:</b> ${lat.toFixed(5)}, ${lng.toFixed(5)}<br><br>
                        <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${lat},${lng}')" 
                                style="width:100%;padding:10px;background:#c41e3a;color:#fff;border:none;border-radius:8px;font-weight:bold">
                            นำทางด่วน
                        </button>
                    </div>
                `, {maxWidth: 300});

                markers.addLayer(m);
            }
        });

        // ลบการ์ดเก่าที่หายไป
        Object.keys(cards).forEach(k=>{ if(!data[k]){ cards[k].remove(); delete cards[k]; }});

        list.innerHTML=''; list.appendChild(frag);

        statsEl.innerHTML = `ทั้งหมด ${counts.all} | รอช่วย ${counts.pending} | กำลังไป ${counts.going} | รับทราบ ${counts.acknowledged} | เสร็จ ${counts.completed}`;

        // Filter
        document.querySelectorAll('.filter-btn').forEach(btn=>{
            btn.onclick = ()=>{
                document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                document.querySelectorAll('.case').forEach(c=>{
                    c.style.display = (currentFilter==='all' || c.dataset.status===currentFilter) ? 'block' : 'none';
                });
            };
        });
    }

    load();
    setInterval(load, 8000);
    setTimeout(()=>map.invalidateSize(),500);
</script>
</body>
</html>
