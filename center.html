<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}

        .header{
            position:fixed;top:0;left:0;right:0;height:58px;background:#c41e3a;
            z-index:1000;display:flex;align-items:center;justify-content:center;
            font-size:1.6rem;font-weight:800;color:#fff;box-shadow:0 4px 20px rgba(0,0,0,0.6);
        }

        .sidebar{
            position:fixed;top:58px;left:0;bottom:0;width:480px;
            background:#0c0c0c;border-right:6px solid #c41e3a;
            overflow-y:auto;padding:10px;z-index:999;
        }

        .stats{
            display:flex;gap:12px;margin-bottom:12px;padding:5px 0;overflow-x:auto;
        }
        .stat{
            min-width:100px;padding:12px;background:#1a1a1a;border-radius:12px;text-align:center;
            border:2px solid #444;box-shadow:0 4px 15px rgba(0,0,0,0.5);
        }
        .stat-num{font-size:1.9rem;font-weight:800;}
        .stat-label{font-size:0.85rem;margin-top:4px;}

        .case{
            background:#1f1f1f;border-left:5px solid #555;
            border-radius:0 12px 12px 0;padding:12px;margin-bottom:8px;
            cursor:pointer;transition:.25s;position:relative;
        }
        .case:hover{background:#2a2a2a;transform:translateX(6px);}
        .case.active{border-left-color:#c41e3a;background:#2f181b !important;box-shadow:0 0 20px rgba(196,30,58,0.6);}
        .case.new{animation:glow 1.5s infinite alternate;}

        .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
        .req{font-weight:700;color:#c41e3a;font-size:1.05rem;}
        .time{font-size:0.82rem;color:#aaa;}

        .mid{display:flex;align-items:center;gap:12px;margin:6px 0;overflow:hidden;}
        .name{font-weight:600;font-size:0.98rem;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .need{flex:1;font-size:0.9rem;color:#ffeb3b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

        .actions{
            display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center;
        }
        .btn{
            padding:6px 11px;border-radius:8px;font-size:0.8rem;font-weight:700;cursor:pointer;
        }
        .btn-phone{background:#0f0;color:#000;}
        .btn-nav{background:#c41e3a;}
        .btn-status{background:#e67e22;}
        .status-tag{padding:4px 10px;border-radius:12px;font-size:0.78rem;font-weight:700;color:#fff;}

        @keyframes glow{from{box-shadow:0 0 10px #c41e3a} to{box-shadow:0 0 25px #c41e3a}}
    </style>
</head>
<body>

<div class="header">ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</div>

<div class="sidebar">
    <div class="stats" id="stats"></div>
    <div id="list"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    const map = L.map('map').setView([13.75, 100.5], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const cluster = L.markerClusterGroup({maxClusterRadius: 50});
    map.addLayer(cluster);

    const list = document.getElementById('list');
    const statsEl = document.getElementById('stats');
    const cards = {};
    const notified = new Set();

    const DB_URL = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests.json';

    function formatTime(ts){
        const m = Math.floor((Date.now() - ts)/60000);
        return m < 1 ? 'สักครู่' : m < 60 ? m+' น.' : m < 1440 ? Math.floor(m/60)+' ชม.' : Math.floor(m/1440)+' วัน';
    }

    function changeStatus(id, current){
        const menu = document.createElement('div');
        menu.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:99999;display:flex;align-items:center;justify-content:center';
        const box = document.createElement('div');
        box.style = 'background:#111;padding:25px;border:5px solid #c41e3a;border-radius:15px;width:90%;max-width:380px;text-align:center';
        box.innerHTML = '<h3 style="color:#c41e3a;margin-bottom:20px">เปลี่ยนสถานะ</h3>';
        ['pending','going','acknowledged','completed'].forEach(s=>{
            if(s===current) return;
            const b = document.createElement('button');
            b.textContent = s==='pending'?'รอช่วย':s==='going'?'กำลังไป':s==='acknowledged'?'รับทราบ':'เสร็จสิ้น';
            b.style = `display:block;width:100%;margin:10px 0;padding:14px;border:none;border-radius:10px;color:#fff;font-weight:700;background:${s==='completed'?'#27ae60':s==='going'?'#3498db':s==='acknowledged'?'#f39c12':'#e74c3c'};cursor:pointer`;
            b.onclick = ()=>{
                fetch(`https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests/${id}/status.json`,{
                    method:'PUT',body:JSON.stringify(s)
                }).then(()=>{ load(); menu.remove(); });
            };
            box.appendChild(b);
        });
        const close = document.createElement('button');
        close.textContent = 'ปิด';
        close.style = 'margin-top:20px;padding:12px 40px;background:#555;color:#fff;border:none;border-radius:10px;cursor:pointer';
        close.onclick = ()=>menu.remove();
        box.appendChild(close);
        menu.appendChild(box);
        document.body.appendChild(menu);
    }
    window.changeStatus = changeStatus;

    async function load(){
        let data = {};
        try{ data = await (await fetch(DB_URL+'?t='+Date.now())).json() || {}; }
        catch{ list.innerHTML='<div style="text-align:center;padding:120px;color:#f66">เชื่อมต่อไม่ได้</div>'; return; }

        const counts = {all:0,pending:0,going:0,acknowledged:0,completed:0};
        const frag = document.createDocumentFragment();
        cluster.clearLayers();

        const sorted = Object.entries(data).sort((a,b)=> b[1].timestamp - a[1].timestamp);

        sorted.forEach(([id,r])=>{
            const s = r.status || 'pending';
            counts.all++; counts[s]++;

            const hasLoc = r.location?.lat && r.location?.lng;
            const reqId = r.requestId || id.slice(-10).toUpperCase();
            const name = (r.name || r.fullname || 'ไม่ระบุชื่อ').trim();
            const types = (r.types || []).join(', ') || 'ทั่วไป';

            const card = document.createElement('div');
            card.className = `case${s==='pending' && !notified.has(id)?' new':''}`;
            card.dataset.status = s;

            card.innerHTML = `
                <div class="top">
                    <div class="req">#${reqId}</div>
                    <div class="time">${formatTime(r.timestamp)}</div>
                </div>
                <div class="mid">
                    <div class="name">${name}</div>
                    <div class="need">${types}</div>
                </div>
                <div class="actions">
                    ${r.phone?`<button class="btn btn-phone" onclick="event.stopPropagation();location.href='tel:${r.phone}'">โทร ${r.phone}</button>`:''}
                    ${hasLoc?`<button class="btn btn-nav" onclick="event.stopPropagation();window.open('https://maps.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}')">นำทาง</button>`:''}
                    <button class="btn btn-status" onclick="event.stopPropagation();changeStatus('${id}','${s}')">เปลี่ยนสถานะ</button>
                    <span class="status-tag ${s}">${s==='pending'?'รอช่วย':s==='going'?'กำลังไป':s==='acknowledged'?'รับทราบ':'เสร็จ'}</span>
                </div>
            `;

            card.onclick = () => {
                document.querySelectorAll('.case').forEach(c=>c.classList.remove('active'));
                card.classList.add('active');
                if(hasLoc) map.setView([r.location.lat, r.location.lng], 18);
            };

            if(s==='pending' && !notified.has(id)){
                notified.add(id);
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-emergency-alert-loop-2979.mp3').play().catch(()=>{});
                navigator.vibrate?.([300,100,300]);
            }

            frag.appendChild(card);
            cards[id] = card;

            // ===== สำคัญ: แก้สี่เหลี่ยมซ้อน =====
            if(hasLoc){
                const color = s==='completed'?'#27ae60':(r.priority>=5 || (r.types&&r.types.some(t=>/จมน้ำ/.test(t)))?'#c41e3a':'#e74c3c');
                const icon = L.divIcon({
                    html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:3.5px solid #fff;box-shadow:0 0 12px #000;"></div>`,
                    className: '',              // เคลียร์พื้นหลังของ Leaflet
                    iconSize: [23, 23],
                    iconAnchor: [11.5, 11.5]
                });

                const m = L.marker([r.location.lat, r.location.lng], {icon});
                m.bindPopup(`
                    <b style="color:#c41e3a">#${reqId}</b><br>
                    <b>${name}</b><br>
                    ${r.phone?`โทร: <a href="tel:${r.phone}" style="color:#0ff">${r.phone}</a><br>`:''}
                    ${types}<br>${r.note||''}<br><br>
                    <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}')" 
                            style="width:100%;padding:11px;background:#c41e3a;color:#fff;border:none;border-radius:10px;font-weight:bold">
                        นำทางด่วน
                    </button>
                `,{maxWidth:300});
                cluster.addLayer(m);
            }
        });

        Object.keys(cards).forEach(k=>{ if(!data[k]){ cards[k].remove(); delete cards[k]; }});

        list.innerHTML = ''; 
        list.appendChild(frag);

        statsEl.innerHTML = `
            <div class="stat"><div class="stat-num">${counts.all}</div><div class="stat-label">ทั้งหมด</div></div>
            <div class="stat" style="border-color:#e74c3c"><div class="stat-num">${counts.pending}</div><div class="stat-label">รอช่วย</div></div>
            <div class="stat" style="border-color:#3498db"><div class="stat-num">${counts.going}</div><div class="stat-label">กำลังไป</div></div>
            <div class="stat" style="border-color:#27ae60"><div class="stat-num">${counts.completed}</div><div class="stat-label">เสร็จแล้ว</div></div>
        `;
    }

    load();
    setInterval(load, 7000);
    setTimeout(()=>map.invalidateSize(), 500);
</script>
</body>
</html>
