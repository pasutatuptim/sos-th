<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}

        .header{
            position:fixed;top:0;left:0;right:0;height:58px;background:#c41e3a;
            z-index:1000;display:flex;align-items:center;justify-content:center;
            font-size:1.65rem;font-weight:800;color:#fff;box-shadow:0 4px 20px rgba(0,0,0,0.7);
        }

        .sidebar{
            position:fixed;top:58px;left:0;bottom:0;width:480px;
            background:#0c0c0c;border-right:6px solid #c41e3a;
            overflow-y:auto;padding:12px 10px;z-index:999;
        }

        .stats{
            display:flex;gap:12px;margin-bottom:15px;overflow-x:auto;padding-bottom:5px;
        }
        .stat{
            min-width:110px;padding:14px 10px;background:#1a1a1a;border-radius:14px;text-align:center;
            border:2px solid #444;box-shadow:0 6px 20px rgba(0,0,0,0.6);
            cursor:pointer;transition:.3s;
        }
        .stat:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(196,30,58,0.5);}
        .stat.active{border-color:#c41e3a;background:#2a1518;box-shadow:0 0 25px rgba(196,30,58,0.7);}
        .stat-num{font-size:2rem;font-weight:800;}
        .stat-label{font-size:0.88rem;margin-top:5px;opacity:0.9;}

        .case{
            background:#1f1f1f;border-left:5px solid #555;
            border-radius:0 12px 12px 0;padding:13px;margin-bottom:9px;
            cursor:pointer;transition:.25s;position:relative;
        }
        .case:hover{background:#2a2a2a;transform:translateX(8px);}
        .case.active{border-left-color:#c41e3a;background:#2f181b !important;box-shadow:0 0 20px rgba(196,30,58,0.6);}
        .case.new{animation:glow 1.5s infinite alternate;}

        .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
        .req{font-weight:700;color:#c41e3a;font-size:1.05rem;}
        .time{font-size:0.82rem;color:#aaa;}

        .mid{display:flex;align-items:center;gap:12px;overflow:hidden;}
        .name{font-weight:600;max-width:165px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .need{flex:1;color:#ffeb3b;font-size:0.92rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

        .actions{display:flex;gap:7px;margin-top:9px;flex-wrap:wrap;align-items:center;}
        .btn{padding:6px 12px;border-radius:8px;font-size:0.82rem;font-weight:700;cursor:pointer;}
        .btn-phone{background:#0f8;color:#000;}
        .btn-nav{background:#c41e3a;}
        .btn-status{background:#e67e22;}
        .status-tag{padding:4px 11px;border-radius:12px;font-size:0.8rem;font-weight:700;color:#fff;}

        @keyframes glow{0%{box-shadow:0 0 12px #c41e3a}100%{box-shadow:0 0 25px #c41e3a}}
    </style>
</head>
<body>

<div class="header">ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</div>

<div class="sidebar">
    <div class="stats" id="stats"></div>
    <div id="list"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    const map = L.map('map').setView([13.75, 100.5], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // สร้าง cluster ใหม่ทุกครั้งที่โหลดข้อมูล → แก้ปัญหา marker ไม่ขึ้นเด็ดขาด!
    let cluster = L.markerClusterGroup({
        maxClusterRadius: 60,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });
    map.addLayer(cluster);

    const list = document.getElementById('list');
    const statsEl = document.getElementById('stats');
    const cards = {};
    const notified = new Set();
    let currentFilter = 'all';

    const DB_URL = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests.json';

    function formatTime(ts){
        const m = Math.floor((Date.now() - ts)/60000);
        return m < 1 ? 'เมื่อสักครู่' : m < 60 ? m+' นาที' : m < 1440 ? Math.floor(m/60)+' ชม.' : Math.floor(m/1440)+' วัน';
    }

    function changeStatus(id, cur){
        const menu = document.createElement('div');
        menu.style='position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:99999;display:flex;align-items:center;justify-content:center';
        const box = document.createElement('div');
        box.style='background:#111;padding:30px;border:5px solid #c41e3a;border-radius:16px;width:90%;max-width:400px;text-align:center';
        box.innerHTML='<h3 style="color:#c41e3a;margin-bottom:25px">เปลี่ยนสถานะ</h3>';
        ['pending','going','acknowledged','completed'].forEach(s=>{
            if(s===cur) return;
            const b=document.createElement('button');
            b.textContent = s==='pending'?'รอช่วยเหลือ':s==='going'?'กำลังไป':s==='acknowledged'?'รับทราบแล้ว':'เสร็จสิ้น';
            b.style=`width:100%;margin:10px 0;padding:16px;border:none;border-radius:12px;color:#fff;font-weight:700;background:${s==='completed'?'#27ae60':s==='going'?'#3498db':s==='acknowledged'?'#f39c12':'#e74c3c'};cursor:pointer`;
            b.onclick=()=>{fetch(`https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests/${id}/status.json`,{method:'PUT',body:JSON.stringify(s)}).then(()=>{load();menu.remove();});};
            box.appendChild(b);
        });
        const c=document.createElement('button');
        c.textContent='ปิด';c.style='margin-top:20px;padding:12px 50px;background:#555;color:#fff;border:none;border-radius:10px;cursor:pointer';
        c.onclick=()=>menu.remove();
        box.appendChild(c);
        menu.appendChild(box);
        document.body.appendChild(menu);
    }
    window.changeStatus = changeStatus;

    function applyFilter(filter){
        currentFilter = filter;
        document.querySelectorAll('.stat').forEach(s=>s.classList.toggle('active', s.dataset.filter===filter));
        document.querySelectorAll('.case').forEach(c=>{
            c.style.display = (filter==='all' || c.dataset.status===filter) ? 'block' : 'none';
        });
    }

    async function load(){
        let data = {};
        try{ data = await (await fetch(DB_URL+'?t='+Date.now())).json() || {}; }
        catch{ list.innerHTML='<div style="text-align:center;padding:150px;color:#f66;font-size:1.2rem">เชื่อมต่อไม่ได้</div>'; return; }

        const counts = {all:0,pending:0,going:0,acknowledged:0,completed:0};
        const frag = document.createDocumentFragment();

        // ลบ cluster เก่า + สร้างใหม่ทุกครั้ง → แก้ marker ไม่ขึ้นเด็ดขาด!
        map.removeLayer(cluster);
        cluster = L.markerClusterGroup({
            maxClusterRadius: 60,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false
        });

        const sorted = Object.entries(data).sort((a,b)=> b[1].timestamp - a[1].timestamp);

        sorted.forEach(([id,r])=>{
            const s = r.status || 'pending';
            counts.all++; counts[s]++;

            const hasLoc = r.location?.lat && r.location?.lng;
            const reqId = r.requestId || id.slice(-10).toUpperCase();
            const name = (r.name || r.fullname || 'ไม่ระบุชื่อ').trim();
            const types = (r.types || []).join(', ') || 'ทั่วไป';

            // การ์ด
            const card = document.createElement('div');
            card.className = `case${s==='pending' && !notified.has(id)?' new':''}`;
            card.dataset.status = s;
            card.innerHTML = `
                <div class="top"><div class="req">#${reqId}</div><div class="time">${formatTime(r.timestamp)}</div></div>
                <div class="mid"><div class="name">${name}</div><div class="need">${types}</div></div>
                <div class="actions">
                    ${r.phone?`<button class="btn btn-phone" onclick="event.stopPropagation();location.href='tel:${r.phone}'">โทร ${r.phone}</button>`:''}
                    ${hasLoc?`<button class="btn btn-nav" onclick="event.stopPropagation();window.open('https://maps.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}')">นำทาง</button>`:''}
                    <button class="btn btn-status" onclick="event.stopPropagation();changeStatus('${id}','${s}')">เปลี่ยน</button>
                    <span class="status-tag ${s}">${s==='pending'?'รอช่วย':s==='going'?'กำลังไป':s==='acknowledged'?'รับทราบ':'เสร็จ'}</span>
                </div>
            `;
            card.onclick = () => {
                document.querySelectorAll('.case').forEach(c=>c.classList.remove('active'));
                card.classList.add('active');
                if(hasLoc) map.setView([r.location.lat, r.location.lng], 18);
            };

            if(s==='pending' && !notified.has(id)){
                notified.add(id);
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-emergency-alert-loop-2979.mp3').play().catch(()=>{});
                navigator.vibrate?.([300,100,300]);
            }

            frag.appendChild(card);
            cards[id] = card;

            // Marker ขึ้นทันทีแน่นอน!
            if(hasLoc){
                const color = s==='completed'?'#27ae60':(r.priority>=5 || (r.types&&r.types.some(t=>/จมน้ำ/.test(t)))?'#c41e3a':'#e74c3c');
                const icon = L.divIcon({
                    html: `<div style="background:${color};width:17px;height:17px;border-radius:50%;border:4px solid #fff;box-shadow:0 0 12px #000;"></div>`,
                    className: '',
                    iconSize: [25,25],
                    iconAnchor: [12.5,12.5]
                });

                const marker = L.marker([r.location.lat, r.location.lng], {icon});
                marker.bindPopup(`
                    <b style="color:#c41e3a">#${reqId}</b><br>
                    <b>${name}</b><br>
                    ${r.phone?`โทร: <a href="tel:${r.phone}" style="color:#0ff">${r.phone}</a><br>`:''}
                    ${types}<br>${r.note||''}<br><br>
                    <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}')" 
                            style="width:100%;padding:11px;background:#c41e3a;color:#fff;border:none;border-radius:10px;font-weight:bold">
                        นำทางด่วน
                    </button>
                `,{maxWidth:300});

                cluster.addLayer(marker);
            }
        });

        // เพิ่ม cluster ใหม่เข้าแผนที่
        map.addLayer(cluster);

        // ลบการ์ดเก่า
        Object.keys(cards).forEach(k=>{ if(!data[k]){ cards[k].remove(); delete cards[k]; }});

        list.innerHTML=''; 
        list.appendChild(frag);

        // อัปเดตสถิติ + กดได้
        statsEl.innerHTML = `
            <div class="stat active" data-filter="all" onclick="applyFilter('all')">
                <div class="stat-num">${counts.all}</div><div class="stat-label">ทั้งหมด</div>
            </div>
            <div class="stat" data-filter="pending" onclick="applyFilter('pending')">
                <div class="stat-num">${counts.pending}</div><div class="stat-label">รอช่วย</div>
            </div>
            <div class="stat" data-filter="going" onclick="applyFilter('going')">
                <div class="stat-num">${counts.going}</div><div class="stat-label">กำลังไป</div>
            </div>
            <div class="stat" data-filter="completed" onclick="applyFilter('completed')">
                <div class="stat-num">${counts.completed}</div><div class="stat-label">เสร็จแล้ว</div>
            </div>
        `;

        applyFilter(currentFilter);
    }

    load();
    setInterval(load, 7000);
    setTimeout(()=>map.invalidateSize(), 600);
</script>
</body>
</html>
