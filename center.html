<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}
        .header{position:fixed;top:0;left:0;right:0;height:52px;background:#111;border-bottom:4px solid #c41e3a;z-index:1000;display:flex;align-items:center;justify-content:center;font-size:1.45rem;font-weight:700;color:#c41e3a}
        .sidebar{position:fixed;top:52px;left:0;bottom:0;width:460px;background:rgba(8,8,28,0.98);z-index:999;overflow-y:auto;padding:12px 14px;border-right:4px solid #c41e3a}
        
        /* Counter + ปุ่มกรอง */
        .stats-bar{
            background:rgba(196,30,58,0.15);border-radius:12px;padding:12px;margin-bottom:14px;
            border:1px solid rgba(196,30,58,0.4);text-align:center;font-weight:bold;font-size:1rem
        }
        .counter{
            display:inline-block;margin:0 12px;color:#fff
        }
        .counter.pending{color:#e74c3c}
        .counter.going{color:#2980b9}
        .counter.acknowledged{color:#e67e22}
        .counter.completed{color:#27ae60}

        .filter-bar{
            display:flex;flex-wrap:wrap;gap:8px;margin:14px 0;padding-bottom:8px;border-bottom:2px solid rgba(255,255,255,0.1)
        }
        .filter-btn{
            padding:9px 15px;border-radius:9px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
            font-size:0.9rem;font-weight:bold;cursor:pointer;transition:all 0.2s;flex:1;min-width:100px;text-align:center
        }
        .filter-btn.active{
            background:#c41e3a;border-color:#c41e3a;box-shadow:0 0 14px rgba(196,30,58,0.7);color:#fff;transform:scale(1.05)
        }
        .filter-btn:hover:not(.active){background:rgba(255,255,255,0.2)}

        .case{background:rgba(255,255,255,0.07);border-radius:12px;padding:15px;margin-bottom:12px;cursor:pointer;transition:all 0.2s;position:relative;border-left:4px solid transparent}
        .case:hover{background:rgba(255,255,255,0.13)}
        .case.active{background:rgba(196,30,58,0.25);border-left-color:#c41e3a;box-shadow:0 0 14px rgba(196,30,58,0.35)}
        .pri{position:absolute;top:9px;right:9px;background:#c41e3a;color:#fff;padding:4px 10px;border-radius:20px;font-size:0.8rem;font-weight:bold}
        .name{font-weight:700;font-size:1.22rem;margin-bottom:5px}
        .phone{color:#0ff;font-weight:bold;font-size:0.98rem;margin-bottom:7px}
        .details{margin:8px 0;line-height:1.5}
        .detail-item{display:flex;align-items:center;gap:8px;font-size:0.96rem;color:#ffdd00;margin:4px 0}
        .detail-item i{font-size:1.1rem}
        .time{font-size:0.88rem;color:#bbb;margin-top:7px}
        .btn{margin-top:12px;background:#c41e3a;color:#fff;padding:11px;border:none;border-radius:9px;width:100%;font-weight:bold;font-size:0.94rem;cursor:pointer}
        .btn:hover{background:#e74c3c}

        .tiny-marker div{
            background:var(--color)!important;width:16px!important;height:16px!important;border-radius:50%!important;
            border:2.5px solid #fff!important;box-shadow:0 1px 6px #000!important;
            margin-left:-8px!important;margin-top:-8px!important
        }
        .tiny-marker.active div{transform:scale(2.2)!important;box-shadow:0 0 18px rgba(196,30,58,0.9)!important}
        .tiny-marker img{display:none!important}

        .leaflet-popup-content-wrapper{
            background:rgba(15,15,35,0.98)!important;color:#fff!important;border-radius:12px!important;
            box-shadow:0 4px 20px rgba(196,30,58,0.5)!important;border:2px solid #c41e3a!important;padding:0!important
        }
        .leaflet-popup-content{margin:14px!important;line-height:1.5;font-size:0.95rem}
        .leaflet-popup-content b{font-size:1.15rem}
        .leaflet-popup-content a{color:#0ff;text-decoration:none}
        .leaflet-popup-tip{background:#c41e3a!important}
    </style>
</head>
<body>

<div class="header">ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</div>
<div class="sidebar">
    <div class="stats-bar" id="stats">
        กำลังโหลดจำนวนเคส...
    </div>
    <div class="filter-bar">
        <div class="filter-btn active" data-filter="all">ทั้งหมด</div>
        <div class="filter-btn" data-filter="pending">รอช่วยเหลือ</div>
        <div class="filter-btn" data-filter="going">กำลังไป</div>
        <div class="filter-btn" data-filter="acknowledged">รับทราบแล้ว</div>
        <div class="filter-btn" data-filter="completed">เสร็จสิ้น</div>
    </div>
    <div id="list">กำลังโหลด...</div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([13.94678, 100.56125], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = {};
    const cards = {};
    const list = document.getElementById('list');
    const statsEl = document.getElementById('stats');
    const notified = new Set();
    let currentFilter = 'all';

    const DB_URL = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests.json';

    function getColor(r) {
        if (r.types?.some(t => /เสียชีวิต|ตาย|ศพ/.test(t))) return '#000000';
        if (r.status === 'completed') return '#27ae60';
        if (r.status === 'going') return '#2980b9';
        if (r.status === 'acknowledged') return '#e67e22';
        if (r.priority >= 5 || r.types?.some(t => /จมน้ำ/.test(t))) return '#c41e3a';
        return '#e74c3c';
    }

    function getDetail(type) {
        if (/อาหาร/.test(type)) return {icon:'อาหาร', text:'ต้องการอาหารและน้ำดื่ม'};
        if (/ติดอยู่/.test(type)) return {icon:'บ้าน', text:'ติดอยู่ในบ้าน/พื้นที่สูง'};
        if (/เด็ก/.test(type)) return {icon:'เด็ก', text:'มีเด็กเล็ก'};
        if (/สูงอายุ/.test(type)) return {icon:'ผู้สูงอายุ', text:'มีผู้สูงอายุ'};
        if (/ยา|เวช/.test(type)) return {icon:'ยา', text:'ต้องการยาหรือเวชภัณฑ์'};
        if (/สัตว์เลี้ยง/.test(type)) return {icon:'สัตว์', text:'มีสัตว์เลี้ยง'};
        if (/จมน้ำ/.test(type)) return {icon:'น้ำท่วม', text:'กำลังจมน้ำ เร่งด่วนมาก!'};
        if (/เสียชีวิต|ศพ/.test(type)) return {icon:'เสียชีวิต', text:'มีผู้เสียชีวิต'};
        return {icon:'ช่วย', text:type};
    }

    function updateStats(counts) {
        statsEl.innerHTML = `
            ทั้งหมด <strong>${counts.all}</strong> เคส · 
            <span class="counter pending">รอช่วยเหลือ ${counts.pending}</span> · 
            <span class="counter going">กำลังไป ${counts.going}</span> · 
            <span class="counter acknowledged">รับทราบแล้ว ${counts.acknowledged}</span> · 
            <span class="counter completed">เสร็จสิ้น ${counts.completed}</span>
        `;
    }

    function filterCases(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        document.querySelectorAll('.case').forEach(card => {
            const status = card.dataset.status || 'pending';
            card.style.display = (filter === 'all' || status === filter) ? 'block' : 'none';
        });
        Object.keys(markers).forEach(id => {
            const m = markers[id];
            const status = m.options.status || 'pending';
            if (filter === 'all' || status === filter) {
                if (!map.hasLayer(m)) m.addTo(map);
            } else {
                if (map.hasLayer(m)) map.removeLayer(m);
            }
        });
    }

    function highlight(id) {
        document.querySelectorAll('.case').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tiny-marker').forEach(m => m.classList.remove('active'));
        const card = cards[id];
        if (card) {
            card.classList.add('active');
            markers[id]?._icon?.classList.add('active');
            card.scrollIntoView({behavior:'smooth', block:'nearest'});
        }
    }

    async function load() {
        let data = {};
        try {
            const res = await fetch(DB_URL + '?t=' + Date.now());
            data = await res.json() || {};
        } catch(e) {
            list.innerHTML = '<div style="text-align:center;padding:80px;color:#f66">เชื่อมต่อไม่ได้<br><button onclick="location.reload()" style="margin-top:20px;background:#c41e3a;padding:12px 30px;border:none;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer">รีเฟรชใหม่</button></div>';
            statsEl.textContent = 'ไม่สามารถโหลดข้อมูลได้';
            return;
        }

        if (Object.keys(data).length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:100px;color:#888">ยังไม่มีคำขอช่วยเหลือ</div>';
            updateStats({all:0,pending:0,going:0,acknowledged:0,completed:0});
            return;
        }

        const counts = {all:0, pending:0, going:0, acknowledged:0, completed:0};
        const newIds = new Set();
        const fragment = document.createDocumentFragment();

        Object.entries(data).forEach(([id, r]) => {
            if (!r.location?.lat || !r.location?.lng) return;

            const status = r.status || 'pending';
            counts.all++;
            counts[status] = (counts[status] || 0) + 1;

            if (status === 'pending' && !notified.has(id)) {
                notified.add(id);
                newIds.add(id);
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alert-quick-chime-766.mp3').play().catch(()=>{});
            }

            const color = getColor(r);

            let detailsHTML = '';
            if (r.types?.length > 0) {
                r.types.forEach(t => {
                    const d = getDetail(t);
                    detailsHTML += `<div class="detail-item">${d.icon} ${d.text}</div>`;
                });
            } else {
                detailsHTML = '<div class="detail-item">ช่วย ขอความช่วยเหลือทั่วไป</div>';
            }

            const div = document.createElement('div');
            div.className = 'case';
            div.dataset.status = status;
            div.innerHTML = `
                <div class="pri">P${r.priority || '?'}</div>
                <div class="name">${r.name || 'ไม่ระบุชื่อ'}</div>
                ${r.phone ? `<div class="phone">โทร: ${r.phone}</div>` : ''}
                <div class="details">${detailsHTML}</div>
                <div class="time">${new Date(r.timestamp).toLocaleString('th-TH', {hour:'2-digit', minute:'2-digit', day:'numeric', month:'short'})}</div>
                <button class="btn" onclick="event.stopPropagation();changeStatus('${id}', '${status}')">เปลี่ยนสถานะ</button>
            `;

            div.onclick = () => {
                map.setView([r.location.lat, r.location.lng], 17);
                markers[id].openPopup();
                highlight(id);
            };

            fragment.appendChild(div);
            cards[id] = div;

            const icon = L.divIcon({
                className: 'tiny-marker',
                html: `<div style="--color:${color}"></div>`,
                iconSize: [16,16],
                iconAnchor: [8,8],
                popupAnchor: [0, -10]
            });

            if (!markers[id]) {
                markers[id] = L.marker([r.location.lat, r.location.lng], {
                    icon: icon,
                    status: status
                }).addTo(map);
            } else {
                markers[id].setIcon(icon);
                markers[id].options.status = status;
            }

            let popupDetails = r.types ? r.types.map(t => {
                const d = getDetail(t);
                return `${d.icon} ${d.text}`;
            }).join('<br>') : 'ขอความช่วยเหลือทั่วไป';

            markers[id].bindPopup(`
                <b>${r.name || 'ไม่ระบุชื่อ'}</b><br>
                ${r.phone ? `โทร: <a href="tel:${r.phone}">${r.phone}</a><br>` : ''}
                ${popupDetails}<br>
                <small style="color:#aaa">${new Date(r.timestamp).toLocaleString('th-TH')}</small><br><br>
                <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}')" 
                    style="background:#c41e3a;color:#fff;border:none;padding:11px;width:100%;border-radius:9px;font-weight:bold">
                    นำทางด่วน
                </button>
            `, {maxWidth: 300});

            markers[id].on('mouseover', () => highlight(id));
            markers[id].on('click', () => highlight(id));

            if (newIds.has(id)) {
                map.setView([r.location.lat, r.location.lng], 17);
                setTimeout(() => markers[id].openPopup(), 600);
            }
        });

        list.innerHTML = '';
        list.appendChild(fragment);
        updateStats(counts);
        filterCases(currentFilter);
    }

    // ปุ่มกรอง
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => filterCases(btn.dataset.filter));
    });

    // เปลี่ยนสถานะ
    function changeStatus(id, current) {
        const menu = document.createElement('div');
        menu.style = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:25px;border:3px solid #c41e3a;border-radius:12px;z-index:99999;width:300px;text-align:center';
        menu.innerHTML = `<h3 style="color:#c41e3a;margin-bottom:15px">เปลี่ยนสถานะ</h3>`;
        const opts = [
            {s:'going', l:'กำลังไป', c:'#2980b9'},
            {s:'acknowledged', l:'รับทราบแล้ว', c:'#e67e22'},
            {s:'completed', l:'เสร็จสิ้น', c:'#27ae60'},
            {s:'canceled', l:'ยกเลิก', c:'#95a5a6'}
        ];
        opts.forEach(o => {
            if (o.s === current) return;
            const b = document.createElement('button');
            b.textContent = o.l;
            b.style = `background:${o.c};color:#fff;border:none;padding:14px;margin:6px 0;width:100%;border-radius:9px;font-weight:bold;cursor:pointer`;
            b.onclick = () => {
                fetch(`https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests/${id}/status.json`, {
                    method:'PUT', body:JSON.stringify(o.s)
                }).then(() => location.reload());
            };
            menu.appendChild(b);
        });
        const close = document.createElement('button');
        close.textContent = 'ปิด';
        close.style = 'margin-top:15px;background:#444;color:#fff;padding:10px;width:100%;border:none;border-radius:9px;cursor:pointer';
        close.onclick = () => menu.remove();
        menu.appendChild(close);
        document.body.appendChild(menu);
    }

    load();
    setInterval(load, 6000);
    setTimeout(() => map.invalidateSize(), 500);
</script>
</body>
</html>
