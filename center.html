<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        .header{position:fixed;top:0;left:0;right:0;height:55px;background:#c41e3a;z-index:1000;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;box-shadow:0 4px 20px rgba(0,0,0,0.6);}
        .sidebar{position:fixed;top:55px;bottom:0;width:430px;left:0;background:#0f0f0f;border-right:6px solid #c41e3a;z-index:999;overflow-y:auto;padding:14px;transition:left 0.4s ease-in-out;}
        .sidebar.hidden { left:-436px; }
        #map{height:100vh;margin-left:436px;width:calc(100% - 436px);transition:margin-left 0.4s ease-in-out, width 0.4s ease-in-out;}
        #map.full-width { margin-left:0;width:100%; }
        #sidebarToggle { position: fixed; top: 55px; left: 436px; background: #c41e3a; color: white; padding: 10px 15px; border: none; cursor: pointer; z-index:1001; font-size:1.2rem; font-weight:bold; border-bottom-right-radius:8px; border-top-right-radius:8px; box-shadow:2px 0 10px rgba(0,0,0,0.5); transition:left .4s ease-in-out;}
        #sidebarToggle.moved { left:0; }
        .stats{background:linear-gradient(135deg,#1a1a1a,#0f0f0f);padding:18px;border-radius:16px;margin-bottom:18px;border:1px solid #333;box-shadow:0 8px 32px rgba(196,30,58,0.15);}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
        .stat-item{text-align:center;padding:16px 10px;border-radius:14px;background:rgba(255,255,255,0.07);cursor:pointer;transition:all .25s;border:2px solid transparent;}
        .stat-item.active{border-color:#c41e3a;background:rgba(196,30,58,0.25);transform:scale(1.05);}
        .stat-num{font-size:2rem;font-weight:800;margin-bottom:6px;}
        .total .stat-num{color:#c41e3a;}
        .pending .stat-num{color:#e74c3c;}
        .going .stat-num{color:#2980b9;}
        .completed .stat-num{color:#27ae60;}
        .rescue .stat-num{color:#ffb300;}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        .blink{animation:blink .6s ease-in-out 4}
        #alertBar{position:fixed;top:55px;left:0;right:0;height:0;background:#e74c3c;color:#fff;font-weight:900;font-size:1.5rem;text-align:center;padding:0 20px;display:flex;align-items:center;justify-content:center;z-index:9999;overflow:hidden;transition:height .7s cubic-bezier(0.68,-0.55,0.27,1.55);box-shadow:0 10px 30px rgba(231,76,60,0.8);}
        #alertBar.show{height:70px}
        .case,.rescue-card{background:#fff;color:#222;border-radius:12px;margin-bottom:11px;box-shadow:0 4px 15px rgba(0,0,0,0.4);cursor:pointer;transition:all .25s;border-left:7px solid #ccc;display:none;}
        .case.show,.rescue-card.show{display:block;}
        .case.new{border-left:12px solid #ff1744 !important;}
        .rescue-card{border-left-color:#ffb300 !important;}
        .case:hover,.rescue-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.5);}
        .case.active,.rescue-card.active{box-shadow:0 0 0 5px rgba(196,30,58,0.4);transform:scale(1.02);}
        .case-header,.rescue-header{padding:13px 16px 8px;background:rgba(0,0,0,0.04);}
        .req-id,.team-name{font-size:1.35rem;font-weight:800;color:#c41e3a;}
        .team-name{color:#ffb300;}
        .case-body,.rescue-body{padding:0 16px 14px;}
        .line{margin:9px 0;font-size:0.98rem;display:flex;align-items:center;}
        .label{color:#444;font-weight:600;width:100px;}
        .value{flex:1;font-weight:500;color:#111;}
        .status-line{margin:12px 0 14px;padding:10px 12px;border-radius:10px;background:#f8f9fa;font-weight:700;border-left:5px solid;}
        .status-line.pending{background:#fdeaea;border-left-color:#e74c3c;color:#c41e3a;}
        .status-line.going{background:#e8f4fd;border-left-color:#2980b9;color:#1e6ca8;}
        .status-line.acknowledged{background:#fff4e5;border-left-color:#e67e22;color:#d35400;}
        .status-line.completed{background:#eaf7ec;border-left-color:#27ae60;color:#1e8449;}
        .note-line{background:#ffebee;padding:12px 14px;border-radius:10px;margin:10px 0;border-left:6px solid #e74c3c;color:#c41e3a;font-weight:700;font-size:1rem;}
        .status-btns{display:flex;gap:7px;margin-top:12px;}
        .status-btn{flex:1;padding:11px 6px;font-size:0.88rem;font-weight:700;border-radius:10px;border:none;cursor:pointer;color:#fff;background:#777;transition:all 0.3s;}
        .status-btn.active{transform:scale(1.08);box-shadow:0 4px 15px rgba(0,0,0,0.4);}
        .status-btn.pending.active{background:#e74c3c;}
        .status-btn.going.active{background:#2980b9;}
        .status-btn.acknowledged.active{background:#e67e22;}
        .status-btn.completed.active{background:#27ae60;}
        .btn-group{display:none;}
        .popup-btn-group{display:flex;gap:8px;margin-top:12px;}
        .popup-btn{padding:10px 14px;background:#333;color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;flex:1;}
        .popup-btn.tel{background:#25d366;}
        .popup-btn.nav{background:#ffb300;color:#000;}
        .pulse-ring { position: absolute; top: 50%; left: 50%; width: 48px; height: 48px; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 0 0 #ff1744; animation: pulse-effect 5.5s infinite; }
        @keyframes pulse-effect { 0% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 23, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0); } }

        /* small screens */
        @media (max-width: 800px){
            .sidebar{width:100%;left:0;transform:translateY(0);height:50vh;}
            #map{margin-left:0;width:100%;height:50vh;bottom:0;top:50vh;}
            #sidebarToggle{left:calc(100% - 70px);top:65px;}
        }
    </style>
</head>
<body>
    <div class="header">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</div>
    <button id="sidebarToggle" onclick="toggleSidebar()">¬´ ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π</button>
    <div id="alertBar">‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà‡∏î‡πà‡∏ß‡∏ô! #ABC123 ‚Äì ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤</div>

    <div class="sidebar" id="sidebar">
        <div class="stats">
            <div style="text-align:center;font-weight:700;margin-bottom:12px;">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div class="stats-grid">
                <div class="stat-item total active" data-filter="all"><div class="stat-num" id="countAll">0</div><div>‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                <div class="stat-item pending" data-filter="pending"><div class="stat-num" id="countPending">0</div><div>‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div></div>
                <div class="stat-item going" data-filter="going"><div class="stat-num" id="countGoing">0</div><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ</div></div>
                <div class="stat-item completed" data-filter="completed"><div class="stat-num" id="countCompleted">0</div><div>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div></div>
                <div class="stat-item rescue" data-filter="rescue"><div class="stat-num" id="countRescue">0</div><div>‡∏ó‡∏µ‡∏°‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢</div></div>
            </div>
        </div>
        <div id="list"></div>
    </div>

    <div id="map"></div>

    <audio id="alertSound" src="https://cdn.jsdelivr.net/gh/napsterking/alert-sound@master/alert.mp3" preload="auto"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
    /* ====== Configuration & Globals ====== */
    const map = L.map('map').setView([13.94678, 100.56125], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const typeColors = {
        '‡∏ô‡πâ‡∏≥':'#3498db','‡∏≠‡∏≤‡∏´‡∏≤‡∏£':'#2ecc71','‡∏¢‡∏≤':'#9b59b6','‡πÄ‡∏£‡∏∑‡∏≠':'#e67e22','‡πÄ‡∏Æ‡∏•‡∏¥‡∏Ñ‡∏≠‡∏õ‡πÄ‡∏ï‡∏≠‡∏£‡πå':'#e74c3c',
        '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢':'#f1c40f','‡πÑ‡∏ü‡∏â‡∏≤‡∏¢':'#1abc9c','‡∏≠‡∏∑‡πà‡∏ô‡πÜ':'#95a5a6','default':'#ff6b6b',
        '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥':'#2ecc71','‡∏°‡∏µ‡πÄ‡∏î‡πá‡∏Å':'#9b59b6','‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏':'#e67e22','‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà':'#95a5a6',
        '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏°‡∏ô‡πâ‡∏≥':'#e74c3c','‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á':'#1abc9c','‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢':'#3498db'
    };
    const statusColor = {pending:'#ff1744',going:'#2980b9',acknowledged:'#e67e22',completed:'#27ae60'};
    const statusName = {pending:'‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢',going:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ',acknowledged:'‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',completed:'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'};
    const priority = {pending:4,going:3,acknowledged:2,completed:1};

    // Firebase-ish endpoints (‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏î‡∏¥‡∏°)
    const SOS_DB = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests';
    const RESCUE_DB = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/rescue_teams';

    const listEl = document.getElementById('list');
    const alertBar = document.getElementById('alertBar');
    const alertSound = document.getElementById('alertSound');
    const sidebar = document.getElementById('sidebar');
    const mapEl = document.getElementById('map');
    const toggleBtn = document.getElementById('sidebarToggle');

    let currentFilter = 'all';
    let previousIds = new Set();
    let allSosMarkers = {};       // { id: marker }
    let rescueTeamMarkers = {};   // { id: marker }
    let rescueTrails = {};        // { id: polyline }
    let openPopupId = null;       // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á popup ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (SOS ‡∏´‡∏£‡∏∑‡∏≠ Rescue) ‚Äî ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô popup ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
    let openPopupType = null;     // 'sos' ‡∏´‡∏£‡∏∑‡∏≠ 'rescue' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏∏‡∏î‡πÑ‡∏´‡∏ô

    /* Marker Cluster */
    let lastSpiderfiedCluster = null;
    const sosCluster = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        maxClusterRadius: 70,
        zoomToBoundsOnClick: false,
        iconCreateFunction: c => {
            let highestPrio = 0, col = statusColor.completed;
            c.getAllChildMarkers().forEach(m => {
                if (m.options.prio > highestPrio) {
                    highestPrio = m.options.prio;
                    col = statusColor[m.options.status] || m.options.typeColor;
                }
            });
            const n = c.getChildCount();
            const s = n < 10 ? 52 : n < 100 ? 62 : 72;
            return L.divIcon({
                html: `<div style="background:${col};width:${s}px;height:${s}px;border-radius:50%;border:5px solid #fff;box-shadow:0 6px 30px rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:${s/2.5}px;color:#fff;text-shadow:0 2px 8px #000;">${n}</div>`,
                className: 'custom-cluster',
                iconSize: [s, s]
            });
        }
    });

    sosCluster.on('clusterclick', function(a) {
        if (lastSpiderfiedCluster && lastSpiderfiedCluster !== a.layer) {
            lastSpiderfiedCluster.unspiderfy();
        }
        a.layer.spiderfy();
        lastSpiderfiedCluster = a.layer;
    });

    const rescueLayer = L.layerGroup();
    map.addLayer(sosCluster);
    map.addLayer(rescueLayer);

    /* ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ */
    const rescueIcon = L.divIcon({
        html: `<div style="position:relative;width:50px;height:50px;">
                <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:#ffb300;border-radius:50%;box-shadow:0 0 25px #ffb300, 0 6px 30px rgba(0,0,0,0.8);"></div>
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;">üë©üèæ‚Äçüöí</div>
               </div>`,
        className: '',
        iconSize: [50,50],
        iconAnchor: [25,25]
    });

    /* ====== Helpers ====== */
    function toggleSidebar(){
        const isHidden = sidebar.classList.toggle('hidden');
        mapEl.classList.toggle('full-width', isHidden);
        toggleBtn.classList.toggle('moved', isHidden);
        toggleBtn.innerHTML = isHidden ? '¬ª ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π' : '¬´ ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π';
        setTimeout(()=>map.invalidateSize(), 400);
    }
    window.toggleSidebar = toggleSidebar;

    function formatTime(ts){
        if(!ts) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
        const d = (Date.now() - ts) / 60000;
        if(d < 1) return '‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ';
        if(d < 60) return `${Math.floor(d)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        if(d < 1440) return `${Math.floor(d/60)} ‡∏ä‡∏°.`;
        return `${Math.floor(d/1440)} ‡∏ß‡∏±‡∏ô`;
    }

    function getMainType(t){
        if(!t||!Array.isArray(t)) return 'default';
        const order = ['‡πÄ‡∏Æ‡∏•‡∏¥‡∏Ñ‡∏≠‡∏õ‡πÄ‡∏ï‡∏≠‡∏£‡πå','‡πÄ‡∏£‡∏∑‡∏≠','‡∏¢‡∏≤','‡∏ô‡πâ‡∏≥','‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢','‡πÑ‡∏ü‡∏â‡∏≤‡∏¢','‡∏≠‡∏∑‡πà‡∏ô‡πÜ','‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥','‡∏°‡∏µ‡πÄ‡∏î‡πá‡∏Å','‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏','‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏°‡∏ô‡πâ‡∏≥','‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á','‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢'];
        for(let x of order) if(t.includes(x)) return x;
        return 'default';
    }

    function triggerAlert(id,name,note){
        alertBar.textContent = `‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà‡∏î‡πà‡∏ß‡∏ô! #${id} ‚Äì ${name}${note?` ‚Äì ${note}`:''}`;
        alertBar.classList.add('show');
        alertSound.play().catch(()=>{});
        document.getElementById('countPending').classList.add('blink');
        setTimeout(()=>{ alertBar.classList.remove('show'); document.getElementById('countPending').classList.remove('blink'); }, 10000);
    }

    /* ====== Create Markers ====== */
    function createSOSMarker(lat, lng, status, typeColor, reqId, name, types, note, timeAgo, phone, id){
        const isPending = status === 'pending';
        const isCompleted = status === 'completed';
        const borderColor = statusColor[status] || '#999';
        const innerColor = typeColor || '#777';
        const symbol = isCompleted ? '‚úì' : '‚ùóÔ∏è';

        const html = `
            ${isPending ? '<div class="pulse-ring"></div>' : ''}
            <div style="position:relative;width:48px;height:48px;">
                <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:${innerColor};border-radius:50%;box-shadow:0 6px 25px rgba(0,0,0,0.8);"></div>
                <div style="position:absolute;top:0;left:0;right:0;bottom:0;border:6px solid ${borderColor};border-radius:50%;box-shadow:0 0 25px ${borderColor};"></div>
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:22px;font-weight:900;text-shadow:0 2px 10px rgba(0,0,0,0.9);">
                    ${symbol}
                </div>
            </div>
        `;

        const icon = L.divIcon({html, className:'', iconSize:[48,48], iconAnchor:[24,24]});
        const marker = L.marker([lat,lng], {icon, prio: priority[status], typeColor, status});
        const typeText = Array.isArray(types) && types.length ? types.join(', ') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

        marker.bindPopup(`
            <div style="font-family:'Sarabun',sans-serif;padding:6px;">
                <b style="font-size:1.5rem;color:#c41e3a;">#${reqId}</b><br>
                <b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${name||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                ${phone?`<b>‡πÇ‡∏ó‡∏£:</b> <a href="tel:${phone}" style="color:#25d366;font-weight:bold;">${phone}</a><br>`:''}
                <b>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</b> ${typeText}<br>
                <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> <span style="color:${borderColor};font-weight:bold;">${statusName[status]||status}</span><br>
                ${note?`<b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> <span style="color:#e74c3c;font-weight:bold;">${note}</span><br>`:''}
                <b>‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á:</b> ${timeAgo} ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
                <div class="popup-btn-group">
                    ${phone?`<button class="popup-btn tel" onclick="window.location.href='tel:${phone}'">‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</button>`:''}
                    ${lat&&lng?`<button class="popup-btn nav" onclick="window.open('http://maps.google.com/?q=${lat},${lng}')">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>`:''}
                </div>
            </div>
        `, {
            maxWidth:360,
            autoClose:false,
            closeOnClick:false,
            closeButton:true
        });

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ popup ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
        marker.on('popupopen', () => {
            openPopupId = id;
            openPopupType = 'sos';
            if (allSosMarkers[id]) allSosMarkers[id].isPopupOpen = true;
        });
        marker.on('popupclose', () => {
            if (openPopupId === id && openPopupType === 'sos') {
                openPopupId = null;
                openPopupType = null;
            }
            if (allSosMarkers[id]) allSosMarkers[id].isPopupOpen = false;
        });

        return marker;
    }

    function createRescueMarker(lat, lng, name, vehicle, speed, phone, id){
        const marker = L.marker([lat,lng], {icon: rescueIcon});
        marker.bindPopup(`
            <div style="font-family:'Sarabun',sans-serif;padding:6px;">
                <div style="font-weight:bold;color:#ffb300;font-size:1.4rem;">‡∏ó‡∏µ‡∏°: ${name}</div>
                <b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> ${vehicle||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                <b>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß:</b> ${speed}<br>
                ${phone?`<b>‡πÇ‡∏ó‡∏£:</b> <a href="tel:${phone}">${phone}</a><br>`:''}
                <div class="popup-btn-group">
                    ${phone?`<button class="popup-btn tel" onclick="window.location.href='tel:${phone}'">‡πÇ‡∏ó‡∏£</button>`:''}
                    <button class="popup-btn nav" onclick="window.open('http://maps.google.com/?q=${lat},${lng}')">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
                </div>
            </div>
        `, {
            maxWidth:360,
            autoClose:false,
            closeOnClick:false,
            closeButton:true
        });

        marker.on('popupopen', () => {
            openPopupId = id;
            openPopupType = 'rescue';
            if (rescueTeamMarkers[id]) rescueTeamMarkers[id].isPopupOpen = true;
        });
        marker.on('popupclose', () => {
            if (openPopupId === id && openPopupType === 'rescue') {
                openPopupId = null;
                openPopupType = null;
            }
            if (rescueTeamMarkers[id]) rescueTeamMarkers[id].isPopupOpen = false;
        });

        return marker;
    }

    /* ====== Filter & Apply UI ====== */
    function applyFilter(){
        document.querySelectorAll('.case,.rescue-card').forEach(el=>{
            const show = currentFilter === 'all' ||
                currentFilter === el.dataset.status ||
                (currentFilter === 'rescue' && el.classList.contains('rescue-card'));
            el.classList.toggle('show', show);
        });

        if (lastSpiderfiedCluster) { lastSpiderfiedCluster.unspiderfy(); lastSpiderfiedCluster = null; }

        sosCluster.clearLayers();
        if (currentFilter !== 'rescue'){
            if (!map.hasLayer(sosCluster)) map.addLayer(sosCluster);
            if (map.hasLayer(rescueLayer)) map.removeLayer(rescueLayer);
            Object.values(allSosMarkers).forEach(m => {
                if (currentFilter === 'all' || m.options.status === currentFilter) sosCluster.addLayer(m);
            });
        } else {
            if (map.hasLayer(sosCluster)) map.removeLayer(sosCluster);
            if (!map.hasLayer(rescueLayer)) map.addLayer(rescueLayer);
            const b = rescueLayer.getBounds();
            if (b && b.isValid()) map.fitBounds(b.pad(0.4));
        }
    }

    /* ====== Load & Render Data ====== */
    async function loadAll(){
        // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á popup ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏Å‡πà‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á)
        const currentlyOpenId = openPopupId;
        const currentlyOpenType = openPopupType;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SOS
        let data = {};
        try {
            const res = await fetch(SOS_DB + '.json?t=' + Date.now());
            data = await res.json() || {};
        } catch (e) {
            console.error('SOS Error:', e);
            data = {};
        }

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        const counts = {all:0,pending:0,going:0,acknowledged:0,completed:0};
        const frag = document.createDocumentFragment();
        const currentIds = new Set();
        let newestCase = null;

        // ‡∏•‡πâ‡∏≤‡∏á cluster ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà)
        sosCluster.clearLayers();
        allSosMarkers = {};

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° timestamp ‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°)
        Object.entries(data)
            .sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0))
            .forEach(([id,r])=>{
                const status = r.status||'pending';
                const types = r.types||[];
                const mainType = getMainType(types);
                const typeColor = typeColors[mainType] || typeColors.default;
                counts.all++; counts[status] = (counts[status] || 0) + 1;

                const lat = r.location?.lat;
                const lng = r.location?.lng;
                const hasLoc = !!(lat && lng);
                const reqId = r.requestId || id.slice(-6).toUpperCase();
                const timeAgo = formatTime(r.timestamp);
                const note = r.note ? r.note.trim() : '';
                const typeText = types.length ? types.join(', ') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const phone = r.phone || '';
                currentIds.add(id);

                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏£‡∏ì‡∏µ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡πÉ‡∏ô previousIds ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô pending)
                if (!previousIds.has(id) && status === 'pending') {
                    newestCase = {id, reqId, name: r.name || r.fullname || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', note};
                    triggerAlert(reqId, newestCase.name, note);
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î
                const card = document.createElement('div');
                card.className = `case ${status}${newestCase?.id === id ? ' new' : ''}`;
                card.dataset.status = status;
                if (status !== 'pending' && status !== 'new') {
                    card.style.borderLeftColor = typeColor;
                }
                card.innerHTML = `
                    <div class="case-header"><div class="req-id">#${reqId}</div></div>
                    <div class="case-body">
                        <div class="line"><span class="label">‡∏ä‡∏∑‡πà‡∏≠:</span><span class="value">${r.name||r.fullname||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span></div>
                        ${phone?`<div class="line"><span class="label">‡πÇ‡∏ó‡∏£:</span><span class="value"><a href="tel:${phone}" style="color:#25d366;font-weight:bold;">${phone}</a></span></div>`:''}
                        <div class="line"><span class="label">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</span><span class="value">${typeText}</span></div>
                        <div class="line"><span class="label">‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á:</span><span class="value">${timeAgo} ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span></div>
                        ${note?`<div class="note-line">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${note}</div>`:''}
                        <div class="status-line ${status}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusName[status] || status}</div>
                        <div class="status-btns">
                            <button class="status-btn pending ${status==='pending'?'active':''}" onclick="event.stopPropagation();confirmStatus('${id}','pending')">‡∏£‡∏≠‡∏ä‡πà‡∏ß‡∏¢</button>
                            <button class="status-btn going ${status==='going'?'active':''}" onclick="event.stopPropagation();confirmStatus('${id}','going')">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ</button>
                            <button class="status-btn acknowledged ${status==='acknowledged'?'active':''}" onclick="event.stopPropagation();confirmStatus('${id}','acknowledged')">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
                            <button class="status-btn completed ${status==='completed'?'active':''}" onclick="event.stopPropagation();confirmStatus('${id}','completed')">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                        </div>
                    </div>
                `;
                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå
                card.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
                    document.querySelectorAll('.case,.rescue-card').forEach(c=>c.classList.remove('active'));
                    card.classList.add('active');
                    if (hasLoc) {
                        map.closePopup();
                        map.setView([lat,lng], 18);
                        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î popup (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á)
                        if (allSosMarkers[id]) {
                            allSosMarkers[id].openPopup();
                        }
                    }
                });
                frag.appendChild(card);

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î
                if (hasLoc) {
                    const m = createSOSMarker(lat, lng, status, typeColor, reqId, r.name || r.fullname, types, note, timeAgo, phone, id);
                    allSosMarkers[id] = m;

                    // ‡∏Ñ‡∏•‡∏¥‡∏Ñ‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡πÉ‡∏´‡πâ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                    m.on('click', () => {
                        document.querySelectorAll('.case,.rescue-card').forEach(c=>c.classList.remove('active'));
                        card.classList.add('active');
                        card.scrollIntoView({behavior:'smooth', block:'start'});
                    });

                    // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ popup ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏Ñ‡∏∑‡∏ô
                    if (id === currentlyOpenId && currentlyOpenType === 'sos') {
                        // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ marker ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô cluster ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î popup
                        setTimeout(()=> {
                            m.openPopup();
                        }, 200);
                    }

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á cluster (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏î‡∏¢ applyFilter)
                    sosCluster.addLayer(m);
                }
            });

        // ===== ‡∏ó‡∏µ‡∏°‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ =====
        let activeTeams = 0;
        rescueLayer.clearLayers();
        const newRescueTeamMarkers = {};
        const newRescueTrails = {};

        try {
            const rres = await fetch(RESCUE_DB + '.json?t=' + Date.now());
            const rdata = await rres.json() || {};
            Object.entries(rdata).forEach(([id,t])=>{
                if (!t || !t.lat || !t.lng || !t.active) return;
                activeTeams++;
                const name = t.name || '‡∏ó‡∏µ‡∏°‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢';
                const speed = t.speed ? parseFloat(t.speed).toFixed(1) + ' ‡∏Å‡∏°./‡∏ä‡∏°.' : '‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á';
                const vehicle = t.vehicle || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const phone = t.phone || '';

                let m, trail;
                if (rescueTeamMarkers[id]) {
                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á marker ‡πÄ‡∏î‡∏¥‡∏°
                    m = rescueTeamMarkers[id];
                    m.setLatLng([t.lat, t.lng]);
                    trail = rescueTrails[id];
                    if (trail) {
                        trail.addLatLng([t.lat, t.lng]);
                        // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏±‡πâ‡∏ô ‡πÜ
                        const latlngs = trail.getLatLngs();
                        if (latlngs.length > 50) latlngs.shift();
                    }
                } else {
                    m = createRescueMarker(t.lat, t.lng, name, vehicle, speed, phone, id);
                    trail = L.polyline([[t.lat, t.lng]], {color:'#ffb300', weight:5, opacity:0.8});
                }

                newRescueTeamMarkers[id] = m;
                newRescueTrails[id] = trail;

                rescueLayer.addLayer(m);
                rescueLayer.addLayer(trail);

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡∏°‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢
                const rc = document.createElement('div');
                rc.className = 'rescue-card';
                rc.dataset.status = 'rescue';
                rc.innerHTML = `
                    <div class="rescue-header"><div class="team-name">‡∏ó‡∏µ‡∏°: ${name}</div></div>
                    <div class="rescue-body">
                        <div class="line"><span class="label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span><span class="value">${vehicle}</span></div>
                        <div class="line"><span class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß:</span><span class="value">${speed}</span></div>
                        ${phone?`<div class="line"><span class="label">‡πÄ‡∏ö‡∏≠‡∏£‡πå:</span><span class="value"><a href="tel:${phone}" style="color:#25d366;font-weight:bold;">${phone}</a></span></div>`:''}
                    </div>
                `;
                rc.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
                    document.querySelectorAll('.case,.rescue-card').forEach(c=>c.classList.remove('active'));
                    rc.classList.add('active');
                    map.closePopup();
                    map.setView([t.lat, t.lng], 16);
                    if (m) m.openPopup();
                });
                frag.appendChild(rc);

                m.on('click', () => {
                    document.querySelectorAll('.case,.rescue-card').forEach(c=>c.classList.remove('active'));
                    rc.classList.add('active');
                    rc.scrollIntoView({behavior:'smooth', block:'start'});
                });

                // ‡∏Ñ‡∏∑‡∏ô popup ‡∏ñ‡πâ‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ popup ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                if (id === currentlyOpenId && currentlyOpenType === 'rescue') {
                    setTimeout(()=> { m.openPopup(); }, 200);
                }
            });

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
            rescueTeamMarkers = newRescueTeamMarkers;
            rescueTrails = newRescueTrails;
        } catch (e) {
            console.error('Rescue Error:', e);
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ UI
        document.getElementById('countAll').textContent = counts.all;
        document.getElementById('countPending').textContent = counts.pending;
        document.getElementById('countGoing').textContent = counts.going;
        document.getElementById('countCompleted').textContent = counts.completed;
        document.getElementById('countRescue').textContent = activeTeams;

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô sidebar
        listEl.innerHTML = '';
        listEl.appendChild(frag);

        // apply filter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏° marker ‡∏•‡∏á map ‡∏ï‡∏≤‡∏° filter ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        applyFilter();

        // ‡πÄ‡∏Å‡πá‡∏ö previousIds ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        previousIds = currentIds;
    }

    /* ====== Change Status ====== */
    function confirmStatus(id, st){
        if (!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${statusName[st]||st}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
        fetch(`${SOS_DB}/${id}.json`, {
            method:'PATCH',
            body: JSON.stringify({status:st, updatedAt: Date.now()}),
            headers: { 'Content-Type': 'application/json' }
        }).then(()=>loadAll()).catch(e=>{console.error('PATCH error', e);});
    }

    /* ====== UI Event Bindings ====== */
    document.querySelectorAll('.stat-item').forEach(item=>{
        item.addEventListener('click', () => {
            document.querySelectorAll('.stat-item').forEach(i=>i.classList.remove('active'));
            item.classList.add('active');
            currentFilter = item.dataset.filter || 'all';
            applyFilter();
        });
    });

    if (window.innerWidth < 800) toggleSidebar();

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á interval ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
    loadAll();
    setInterval(loadAll, 3000);
    setTimeout(()=>map.invalidateSize(), 500);
    window.addEventListener('resize', ()=>{ setTimeout(()=>map.invalidateSize(), 500); });
    </script>
</body>
</html>

