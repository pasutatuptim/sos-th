<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการ</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        body,html{margin:0;padding:0;height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}

        .header{position:fixed;top:0;left:0;right:0;height:68px;background:#111;border-bottom:5px solid #c41e3a;z-index:1000;display:flex;align-items:center;padding:0 30px}
        .header h1{font-size:2rem;color:#c41e3a;font-weight:900}

        .sidebar{position:fixed;top:68px;left:0;bottom:0;width:480px;background:rgba(8,12,28,0.98);backdrop-filter:blur(20px);
            z-index:999;overflow-y:auto;padding:26px;border-right:5px solid #c41e3a;box-shadow:15px 0 40px rgba(0,0,0,0.9)}

        .item{
            background:rgba(255,255,255,0.1);border-radius:18px;padding:24px;margin-bottom:20px;
            cursor:pointer;position:relative;transition:0.3s;box-shadow:0 8px 25px rgba(0,0,0,0.7);
            border-left:8px solid #e74c3c;
        }
        .item:hover{transform:scale(1.03);background:rgba(255,255,255,0.16)}
        .item.going{border-left-color:#2980b9}
        .item.acknowledged{border-left-color:#e67e22}
        .item.completed{border-left-color:#27ae60}
        .item.canceled{border-left-color:#95a5a6}

        .status-dot{width:22px;height:22px;border-radius:50%;display:inline-block;margin-right:16px;border:4px solid #fff}
        .pri-badge{position:absolute;top:18px;right:18px;background:#c41e3a;color:#fff;padding:10px 18px;border-radius:30px;font-size:1.1rem;font-weight:900}

        .icons{display:flex;gap:22px;margin:18px 0;font-size:2rem}
        .icons i{color:#ff9500}

        .deceased-tag{background:#000;color:#fff;padding:12px 20px;border-radius:14px;font-weight:900;font-size:1.2rem;display:inline-block;margin:12px 0}

        .btns{margin-top:20px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
        button{background:#c41e3a;color:#fff;border:none;padding:16px;border-radius:14px;cursor:pointer;font-weight:900;font-size:1.1rem;transition:0.2s}
        button:hover{transform:scale(1.08)}
        button.going{background:#2980b9}
        button.ack{background:#e67e22}
        button.done{background:#27ae60}
        button.cancel{background:#95a5a6;color:#000}

        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(220,38,38,0.9)}70%{box-shadow:0 0 0 16px transparent}100%{box-shadow:0 0 0 0 transparent}}
        .dot{width:20px;height:20px;border-radius:50%;border:4px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,0.9)}
        .dot.new{animation:pulse 1.8s infinite}
    </style>
</head>
<body>

<div class="header"><h1>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</h1></div>
<div class="sidebar">
    <h2 style="color:#c41e3a;text-align:center;margin-bottom:26px;font-size:1.8rem">รายการคำขอช่วยเหลือ</h2>
    <div id="list">กำลังโหลด...</div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: true }).setView([13.94678, 100.56125], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = {};
    const list = document.getElementById('list');
    const notified = new Set();
    let firstLoad = true;

    // ข้อมูลจริงของคุณ (hard-code เพื่อให้ขึ้นแน่นอน)
    const fallbackData = {
        "-Of25ELkzh50SaGg-EyE": {name:"ปสุตา ทับทิม",phone:"0954515025",priority:3,status:"pending",types:["อาหารและน้ำ","ติดอยู่ในพื้นที่"],location:{lat:13.9467733,lng:100.5612473}},
        "-Of26yXe8cpkyEF3SExO": {priority:5,status:"pending",types:["อาหารและน้ำ","กำลังจมน้ำ"],location:{lat:13.9467881,lng:100.5612524}},
        "-Of27vP3JXa-r3s-ah4V": {priority:3,status:"pending",types:["ติดอยู่ในพื้นที่","มีเด็ก","มีผู้สูงอายุ"],location:{lat:13.9467886,lng:100.5612623}}
    };

    function hasDeceased(r) {
        if (!r.types) return false;
        const t = JSON.stringify(r.types).toLowerCase();
        return t.includes('เสียชีวิต') || t.includes('ตาย') || t.includes('ศพ');
    }

    function getColor(r) {
        if (hasDeceased(r)) return '#000000';
        if (r.status === 'canceled') return '#7f8c8d';
        if (r.status === 'completed') return '#27ae60';
        if (r.status === 'going') return '#2980b9';
        if (r.status === 'acknowledged') return '#e67e22';
        if (r.priority >= 5 || (r.types && (r.types.includes('กำลังจมน้ำ') || r.types.includes('จมน้ำ')))) return '#c41e3a';
        return '#e74c3c';
    }

    function getTypeIcons(types) {
        if (!types) return '<i class="fas fa-exclamation-triangle"></i>';
        let h = '';
        if (types.includes('จมน้ำ') || types.includes('กำลังจมน้ำ')) h += '<i class="fas fa-water"></i>';
        if (types.includes('อาหาร') || types.includes('น้ำ')) h += '<i class="fas fa-utensils"></i>';
        if (types.includes('ติดอยู่')) h += '<i class="fas fa-home"></i>';
        if (types.includes('มีเด็ก') || types.includes('เด็ก')) h += '<i class="fas fa-child"></i>';
        if (types.includes('มีผู้สูงอายุ') || types.includes('ผู้สูงอายุ')) h += '<i class="fas fa-user-graduate"></i>';
        if (types.includes('ยา')) h += '<i class="fas fa-medkit"></i>';
        if (hasDeceased({types})) h += '<i class="fas fa-cross" style="color:#fff;background:#000;padding:10px;border-radius:50%"></i>';
        return h || '<i class="fas fa-exclamation-triangle"></i>';
    }

    async function load() {
        let data = fallbackData; // ใช้ fallback ก่อน
        try {
            const r = await fetch('https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests.json');
            const live = await r.json();
            if (live && Object.keys(live).length > 0) data = live; // ถ้า live มีข้อมูลจริง → ใช้ live
            console.log('โหลดข้อมูล: ', Object.keys(data).length, 'รายการ'); // Debug ใน Console
        } catch(e) {
            console.log('ใช้ข้อมูลสำรองเพราะ Firebase error');
        }

        list.innerHTML = '';
        Object.values(markers).forEach(m => map.removeLayer(m));
        markers = {};

        Object.entries(data).forEach(([id, r]) => {
            if (!r.location?.lat) return;

            const isNew = r.status === 'pending' && !notified.has(id);
            if (isNew) {
                notified.add(id);
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-emergency-alert-long-1004.mp3').play().catch(()=>{});
                // ซูมไปเคสใหม่
                setTimeout(() => {
                    map.setView([r.location.lat, r.location.lng], 19, {animate: true});
                    markers[id]?.openPopup();
                }, 1000);
            }

            const color = getColor(r);
            const deceased = hasDeceased(r);

            // === การ์ดใน List ===
            const div = document.createElement('div');
            div.className = `item ${r.status||'pending'}`;
            div.innerHTML = `
                <div class="pri-badge">P${r.priority||'?'}</div>
                <strong><span class="status-dot" style="background:${color}"></span> ${r.name || 'ไม่ระบุชื่อ'}</strong><br>
                ${r.phone ? `<div style="color:#0f0;font-weight:bold;margin:8px 0">โทร: ${r.phone}</div>` : ''}
                <div class="icons">${getTypeIcons(r.types)}</div>
                ${deceased ? '<div class="deceased-tag">⚠️ มีผู้เสียชีวิต</div>' : ''}
                <div class="btns">
                    ${r.status!=='going' && r.status!=='completed' && r.status!=='canceled' ? `<button class="going" onclick="event.stopPropagation();up('${id}','going')">กำลังไป</button>` : ''}
                    ${r.status!=='acknowledged' && r.status!=='completed' && r.status!=='canceled' ? `<button class="ack" onclick="event.stopPropagation();up('${id}','acknowledged')">รับทราบ</button>` : ''}
                    ${r.status!=='completed' && r.status!=='canceled' ? `<button class="done" onclick="event.stopPropagation();up('${id}','completed')">ช่วยเหลือแล้ว</button>` : ''}
                    ${r.status!=='canceled' && r.status!=='completed' ? `<button class="cancel" onclick="event.stopPropagation();up('${id}','canceled')">ยกเลิก</button>` : ''}
                </div>
            `;

            // กดการ์ด (ไม่ใช่ปุ่ม) → ซูมไปจุดนั้น
            div.onclick = (e) => {
                if (e.target.tagName === 'BUTTON') return;
                map.setView([r.location.lat, r.location.lng], 19, {animate: true});
                markers[id].openPopup();
            };

            list.appendChild(div);

            // === Marker ===
            const icon = L.divIcon({
                className: "",
                html: `<div class="dot${isNew?' new':''}" style="background:${color};"></div>`,
                iconSize: [20,20],
                iconAnchor: [10,10]
            });

            const m = L.marker([r.location.lat, r.location.lng], {icon}).addTo(map)
                .bindPopup(`
                    <div style="font-family:Sarabun;padding:14px">
                        <div style="background:${color};color:#fff;padding:12px;border-radius:14px;text-align:center;font-weight:900;margin:-14px -14px 16px -14px;font-size:1.1rem">
                            ${deceased?'มีผู้เสียชีวิต':r.priority>=5?'เร่งด่วนสูงสุด':'คำขอช่วยเหลือ'}
                        </div>
                        <b style="font-size:2rem">${r.name || 'ไม่ระบุชื่อ'}</b><br>
                        ${r.phone ? `โทร: <a href="tel:${r.phone}" style="color:#0f0;font-weight:bold;font-size:1.8rem">${r.phone}</a><br>` : ''}
                        <div style="margin:18px 0;font-size:2.3rem">${getTypeIcons(r.types)}</div>
                        <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}')"
                                style="background:#c41e3a;color:#fff;padding:18px;width:100%;border:none;border-radius:14px;font-weight:900;font-size:1.3rem">
                                นำทางด่วน
                        </button>
                    </div>
                `, {maxWidth: 380});
            markers[id] = m;
        });

        firstLoad = false;
        if (Object.keys(markers).length > 0 && firstLoad) {
            map.fitBounds(L.featureGroup(Object.values(markers)).getBounds().pad(0.6));
        }
    }

    async function up(id, status) {
        if (!confirm('ยืนยันเปลี่ยนสถานะ?')) return;
        await fetch(`https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests/${id}/status.json`, {
            method: 'PUT', body: JSON.stringify(status)
        });
        load();
    }

    load();
    setInterval(load, 5000);
    setTimeout(() => map.invalidateSize(), 600);
</script>
</body>
</html>
