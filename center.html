<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}
        .header{position:fixed;top:0;left:0;right:0;height:55px;background:#c41e3a;z-index:1000;
            display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;
            box-shadow:0 4px 20px rgba(0,0,0,0.6);}
        .sidebar{position:fixed;top:55px;left:0;bottom:0;width:430px;background:#0f0f0f;
            border-right:6px solid #c41e3a;z-index:999;overflow-y:auto;padding:14px;}
        .stats{background:linear-gradient(135deg,#1a1a1a,#0f0f0f);padding:18px;border-radius:16px;margin-bottom:18px;
            border:1px solid #333;box-shadow:0 8px 32px rgba(196,30,58,0.15);}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
        .stat-item{
            text-align:center;padding:16px 10px;border-radius:14px;background:rgba(255,255,255,0.07);
            cursor:pointer;transition:all .25s;border:2px solid transparent;
        }
        .stat-item.active{border-color:#c41e3a;background:rgba(196,30,58,0.25);transform:scale(1.05);}
        .stat-num{font-size:2rem;font-weight:800;margin-bottom:6px;}
        .total .stat-num{color:#c41e3a;}
        .pending .stat-num{color:#e74c3c;}
        .going .stat-num{color:#2980b9;}
        .completed .stat-num{color:#27ae60;}

        .case{background:#fff;color:#222;border-radius:12px;margin-bottom:11px;
            box-shadow:0 4px 15px rgba(0,0,0,0.4);cursor:pointer;transition:all .25s;
            border-left:7px solid #ccc;}
        .case.pending   {border-left-color:#e74c3c;}
        .case.going     {border-left-color:#2980b9;}
        .case.acknowledged {border-left-color:#e67e22;}
        .case.completed {border-left-color:#27ae60;}
        .case:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.5);}
        .case.active{box-shadow:0 0 0 5px rgba(196,30,58,0.4);transform:scale(1.02);}
        .case-header{padding:13px 16px 8px;background:rgba(0,0,0,0.04);}
        .req-id{font-size:1.35rem;font-weight:800;color:#c41e3a;}
        .case-body{padding:0 16px 14px;}
        .line{margin:9px 0;font-size:0.98rem;display:flex;align-items:center;}
        .label{color:#444;font-weight:600;width:88px;}
        .value{flex:1;font-weight:500;color:#111;}
        .status-line{margin:12px 0 14px;padding:10px 12px;border-radius:10px;
            background:#f8f9fa;font-weight:700;border-left:5px solid;}
        .status-line.pending   {background:#fdeaea;border-left-color:#e74c3c;color:#c41e3a;}
        .status-line.going     {background:#e8f4fd;border-left-color:#2980b9;color:#1e6ca8;}
        .status-line.acknowledged {background:#fff4e5;border-left-color:#e67e22;color:#d35400;}
        .status-line.completed {background:#eaf7ec;border-left-color:#27ae60;color:#1e8449;}
        .status-btns{display:flex;gap:7px;margin-top:10px;}
        .status-btn{flex:1;padding:11px 6px;font-size:0.88rem;font-weight:700;
            border-radius:10px;border:none;cursor:pointer;color:#fff;}
        .status-btn:not(.active){background:#999 !important;}
        .btn-pending.active{background:#e74c3c;}
        .btn-going.active{background:#2980b9;}
        .btn-ack.active{background:#e67e22;}
        .btn-done.active{background:#27ae60;}
    </style>
</head>
<body>
<div class="header">ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</div>

<div class="sidebar">
    <div class="stats">
        <div style="text-align:center;font-weight:700;margin-bottom:12px;">สรุปสถานการณ์ล่าสุด</div>
        <div class="stats-grid">
            <div class="stat-item total active" data-filter="all"><div class="stat-num" id="countAll">0</div><div>ทั้งหมด</div></div>
            <div class="stat-item pending" data-filter="pending"><div class="stat-num" id="countPending">0</div><div>รอช่วย</div></div>
            <div class="stat-item going" data-filter="going"><div class="stat-num" id="countGoing">0</div><div>กำลังไป</div></div>
            <div class="stat-item completed" data-filter="completed"><div class="stat-num" id="countCompleted">0</div><div>เสร็จสิ้น</div></div>
        </div>
    </div>
    <div id="list"></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    const map = L.map('map').setView([13.94678, 100.56125], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const sosMarkers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        maxClusterRadius: 70,
        iconCreateFunction: function(cluster) {
            return L.divIcon({
                html: `<div style="background:#c41e3a;color:#fff;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;border:4px solid #fff;box-shadow:0 4px 15px #000;">
                        ${cluster.getChildCount()}
                       </div>`,
                className: '', iconSize: [50,50]
            });
        }
    });

    const rescueMarkers = L.layerGroup();
    map.addLayer(sosMarkers);
    map.addLayer(rescueMarkers);

    const statusColor = { pending:'#e74c3c', going:'#2980b9', acknowledged:'#e67e22', completed:'#27ae60' };
    const statusName = { pending:'รอช่วย', going:'กำลังไป', acknowledged:'รับทราบ', completed:'เสร็จสิ้น' };

    const SOS_DB = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests';
    const RESCUE_DB = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/rescue_teams';
    const list = document.getElementById('list');

    function formatTime(ts){
        const diff = (Date.now() - ts) / 60000;
        if (diff < 60) return `${Math.floor(diff)} นาทีที่แล้ว`;
        if (diff < 1440) return `${Math.floor(diff/60)} ชม.ที่แล้ว`;
        return `${Math.floor(diff/1440)} วันที่แล้ว`;
    }

    async function loadAll(){
        let data = {};
        try { data = await (await fetch(SOS_DB+'.json?t='+Date.now())).json() || {}; }
        catch { list.innerHTML='<div style="color:#f66;padding:100px;text-align:center">เชื่อมต่อไม่ได้</div>'; return; }

        const counts = {all:0,pending:0,going:0,acknowledged:0,completed:0};
        const frag = document.createDocumentFragment();
        sosMarkers.clearLayers();

        Object.entries(data).sort((a,b)=> (b[1].timestamp||0) - (a[1].timestamp||0)).forEach(([id,r])=>{
            const status = r.status || 'pending';
            counts.all++; counts[status]++;

            const lat = r.location?.lat;
            const lng = r.location?.lng;
            const hasLoc = lat && lng;
            const reqId = r.requestId || id.slice(-6).toUpperCase();
            const timeAgo = formatTime(r.timestamp);

            const card = document.createElement('div');
            card.className = `case ${status}`;
            card.dataset.status = status;
            card.innerHTML = `
                <div class="case-header"><div class="req-id">#${reqId}</div></div>
                <div class="case-body">
                    <div class="line"><span class="label">ชื่อ:</span><span class="value">${r.name || r.fullname || 'ไม่ระบุ'}</span></div>
                    <div class="line"><span class="label">ต้องการ:</span><span class="value">${(r.types||[]).join(', ') || '-'}</span></div>
                    <div class="line"><span class="label">รับแจ้ง:</span><span class="value">${timeAgo}</span></div>
                    <div class="status-line ${status}">สถานะ: ${statusName[status]}</div>
                    <div class="status-btns">
                        <button class="status-btn btn-pending ${status==='pending'?'active':''}" onclick="event.stopPropagation(); confirmStatus('${id}','pending')">รอช่วย</button>
                        <button class="status-btn btn-going ${status==='going'?'active':''}" onclick="event.stopPropagation(); confirmStatus('${id}','going')">กำลังไป</button>
                        <button class="status-btn btn-ack ${status==='acknowledged'?'active':''}" onclick="event.stopPropagation(); confirmStatus('${id}','acknowledged')">รับทราบ</button>
                        <button class="status-btn btn-done ${status==='completed'?'active':''}" onclick="event.stopPropagation(); confirmStatus('${id}','completed')">เสร็จสิ้น</button>
                    </div>
                </div>
            `;

            card.onclick = (e) => {
                if(e.target.tagName==='BUTTON') return;
                document.querySelectorAll('.case').forEach(c=>c.classList.remove('active'));
                card.classList.add('active');
                if(hasLoc) map.setView([lat,lng], 18);
            };

            frag.appendChild(card);

            if(hasLoc){
                const icon = L.divIcon({
                    html: `<div style="background:${statusColor[status]};color:#fff;padding:6px 12px;border-radius:12px;
                            font-weight:800;font-size:13px;border:3px solid #fff;box-shadow:0 0 15px #000;">
                            #${reqId}<br><small>${timeAgo}</small>
                           </div>`,
                    className: '', iconSize: [100, 50], iconAnchor: [50, 25]
                });

                const m = L.marker([lat,lng], {icon});
                m.bindPopup(`
                    <b style="font-size:1.2rem;color:#c41e3a">#${reqId}</b><br>
                    <b>ชื่อ:</b> ${r.name||'-'}<br>
                    <b>โทร:</b> ${r.phone?`<a href="tel:${r.phone}">${r.phone}</a>`:'-'}<br>
                    <b>ต้องการ:</b> ${(r.types||[]).join(', ')}<br>
                    <b>รับแจ้ง:</b> ${timeAgo}<br><br>
                    <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${lat},${lng}')"
                        style="width:100%;padding:10px;background:#c41e3a;color:#fff;border:none;border-radius:8px;font-weight:bold">
                        นำทางด่วน
                    </button>
                `,{maxWidth:320});
                sosMarkers.addLayer(m);
            }
        });

        document.getElementById('countAll').textContent = counts.all;
        document.getElementById('countPending').textContent = counts.pending;
        document.getElementById('countGoing').textContent = counts.going;
        document.getElementById('countCompleted').textContent = counts.completed;
        list.innerHTML=''; list.appendChild(frag);

        // ทีมกู้ภัย
        try {
            const rdata = await (await fetch(RESCUE_DB+'.json?t='+Date.now())).json();
            rescueMarkers.clearLayers();
            if(rdata){
                Object.entries(rdata).forEach(([id, t])=>{
                    if(!t.lat || !t.lng) return;
                    const color = t.vehicle?.includes('พยาบาล') ? '#c41e3a' : '#2c3e50';
                    const icon = L.divIcon({
                        html: `<div style="background:${color};color:#fff;padding:8px 16px;border-radius:12px;
                                font-weight:800;font-size:14px;border:3px solid #fff;box-shadow:0 0 15px #000;">
                                ${t.name || 'ทีมกู้ภัย'}
                               </div>`,
                        className: '', iconSize: [140, 50], iconAnchor: [70, 25]
                    });
                    L.marker([t.lat, t.lng], {icon}).addTo(rescueMarkers);
                });
            }
        } catch(e) {}
    }

    function confirmStatus(id, newStatus){
        if(confirm(`เปลี่ยนเป็น "${statusName[newStatus]}" ใช่หรือไม่?`)){
            fetch(`${SOS_DB}/${id}.json`, {
                method: 'PATCH',
                body: JSON.stringify({status: newStatus, updatedAt: Date.now()})
            }).then(()=>loadAll());
        }
    }

    document.querySelectorAll('.stat-item').forEach(item => {
        item.onclick = () => {
            document.querySelectorAll('.stat-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            const f = item.dataset.filter;
            document.querySelectorAll('.case').forEach(c => {
                c.style.display = (f==='all' || c.dataset.status===f) ? 'block' : 'none';
            });
        };
    });

    loadAll();
    setInterval(loadAll, 8000);
    setTimeout(() => map.invalidateSize(), 500);
</script>
</body>
</html>
