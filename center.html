<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}
        .header{position:fixed;top:0;left:0;right:0;height:50px;background:#0a0a0a;border-bottom:5px solid #c41e3a;z-index:1000;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:700;color:#c41e3a}
        .sidebar{position:fixed;top:50px;left:0;bottom:0;width:420px;background:#0c0c1f;z-index:999;overflow-y:auto;padding:10px;border-right:5px solid #c41e3a}

        .stats-bar{background:#c41e3a;border-radius:10px;padding:10px;margin-bottom:10px;text-align:center;font-weight:700;font-size:0.95rem}
        .filter-bar{display:flex;gap:6px;margin:10px 0;flex-wrap:wrap}
        .filter-btn{padding:8px 12px;border-radius:30px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);font-size:0.85rem;font-weight:600;cursor:pointer;transition:all .2s}
        .filter-btn.active{background:#c41e3a;border-color:#c41e3a;box-shadow:0 0 15px rgba(196,30,58,0.6)}

        /* การ์ดเล็กสุด ๆ แต่ยังสวยและอ่านง่าย */
        .case{
            background:rgba(255,255,255,0.07);
            border-radius:10px;
            padding:10px;
            margin-bottom:8px;
            cursor:pointer;
            transition:all .2s;
            border-left:3px solid transparent;
            font-size:0.92rem;
        }
        .case:hover{background:rgba(255,255,255,0.12)}
        .case.active{background:rgba(196,30,58,0.25);border-left-color:#c41e3a}
        .case.new{animation:newCase .8s 2}
        @keyframes newCase{0%,100%{border-left-color:transparent}50%{border-left-color:#c41e3a;border-left-width:6px}}

        .case-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .case-name{font-weight:700;font-size:1rem}
        .priority{width:26px;height:26px;border-radius:50%;background:#c41e3a;color:#fff;font-size:0.75rem;font-weight:bold;display:flex;align-items:center;justify-content:center}
        .priority.low{background:#27ae60}.priority.med{background:#e67e22}.priority.high{background:#c41e3a}.priority.critical{background:#000;border:2px solid #c41e3a;color:#c41e3a}

        .case-phone{margin:3px 0;font-size:0.9rem;color:#0ff}
        .tags{display:flex;flex-wrap:wrap;gap:5px;margin:6px 0}
        .tag{padding:3px 8px;border-radius:15px;font-size:0.75rem;font-weight:600;display:flex;align-items:center;gap:4px}
        .tag i{font-size:0.8rem}
        .tag.food{background:#27ae60}.tag.trapped{background:#e74c3c}.tag.child{background:#9b59b6}
        .tag.elderly{background:#f39c12}.tag.med{background:#e67e22}.tag.pet{background:#3498db}
        .tag.drowning{background:#c41e3a;color:#fff;animation:pulse 2s infinite}
        .tag.death{background:#000;color:#fff;border:1px solid #c41e3a}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}

        .case-note{margin:5px 0;padding:6px;background:rgba(255,255,255,0.08);border-radius:6px;font-size:0.82rem;color:#ddd}
        .no-location-notice{padding:6px;background:rgba(231,76,60,0.2);border-radius:6px;text-align:center;font-size:0.8rem;color:#e74c3c}

        .case-footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:0.8rem}
        .case-time{color:#aaa;background:rgba(255,255,255,0.1);padding:3px 8px;border-radius:15px}
        .status-btn{padding:5px 10px;border:none;border-radius:20px;color:#fff;font-size:0.78rem;font-weight:600;cursor:pointer}
        .status-btn.pending{background:#e74c3c}.status-btn.going{background:#2980b9}
        .status-btn.acknowledged{background:#e67e22}.status-btn.completed{background:#27ae60}

        /* Popup บน Marker – เล็กลง อ่านง่าย */
        .leaflet-popup-content-wrapper{
            background:rgba(10,10,25,0.98)!important;color:#fff!important;
            border-radius:14px!important;border:3px solid #c41e3a!important;
            box-shadow:0 8px 30px rgba(196,30,58,0.7)!important;
            max-width:300px!important;
        }
        .leaflet-popup-content{margin:14px!important;padding:0!important;line-height:1.5;font-size:0.95rem}
        .popup-name{font-size:1.35rem;font-weight:800;color:#c41e3a;text-align:center;margin-bottom:8px}
        .popup-priority{display:block;text-align:center;margin:8px 0;padding:6px 12px;border-radius:25px;background:#c41e3a;color:#fff;font-weight:bold;font-size:0.9rem}
        .popup-phone{text-align:center;margin:10px 0}
        .popup-phone a{color:#0ff;font-weight:bold;text-decoration:none;padding:6px 12px;background:rgba(0,255,255,0.15);border-radius:20px}
        .popup-tags{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:12px 0}
        .popup-tag{padding:6px 10px;border-radius:20px;font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:6px}
        .popup-tag i{font-size:1rem}
        .popup-note{background:rgba(255,255,255,0.1);padding:8px;border-radius:8px;margin:10px 0;font-size:0.9rem}
        .popup-time{text-align:center;color:#aaa;font-size:0.85rem;margin:8px 0}
        .popup-nav-btn{
            background:#c41e3a;color:#fff;border:none;width:100%;padding:14px;font-size:1.1rem;
            font-weight:800;border-radius:0 0 11px 11px;cursor:pointer;margin-top:10px
        }
        .leaflet-popup-tip{background:#c41e3a!important}

        .tiny-marker div{background:var(--color)!important;width:15px!important;height:15px!important;border:3px solid #fff!important;border-radius:50%!important}
        .tiny-marker.active div{transform:scale(2.5)!important}
        .tiny-marker.new div{animation:blink 1.2s infinite}
        @keyframes blink{0%,100%{transform:scale(1)}50%{transform:scale(3.5)}}
    </style>
</head>
<body>
<div class="header">ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</div>
<div class="sidebar">
    <div class="stats-bar" id="stats">กำลังโหลด...</div>
    <div class="filter-bar">
        <div class="filter-btn active" data-filter="all">ทั้งหมด</div>
        <div class="filter-btn" data-filter="pending">รอช่วยเหลือ</div>
        <div class="filter-btn" data-filter="going">กำลังไป</div>
        <div class="filter-btn" data-filter="acknowledged">รับทราบแล้ว</div>
        <div class="filter-btn" data-filter="completed">เสร็จสิ้น</div>
    </div>
    <div id="list"></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([13.94678, 100.56125], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markers = {}; const cards = {}; const list = document.getElementById('list');
    const statsEl = document.getElementById('stats'); const notified = new Set();
    let currentFilter = 'all';
    const DB_URL = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests.json';
    const statusMap = { pending:'รอช่วยเหลือ', going:'กำลังไป', acknowledged:'รับทราบแล้ว', completed:'เสร็จสิ้น', canceled:'ยกเลิก' };

    function formatTime(t) {
        const d = new Date(t);
        const diff = Math.floor((Date.now() - d) / 60000);
        const ago = diff < 1 ? 'สักครู่' : diff < 60 ? `${diff} นาที` : diff < 1440 ? `${Math.floor(diff/60)} ชม.` : `${Math.floor(diff/1440)} วัน`;
        return `${d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})} • ${ago}ที่แล้ว`;
    }

    function getColor(r) {
        if (r.types?.some(t=>/เสียชีวิต|ศพ/.test(t))) return '#000';
        if (r.status==='completed') return '#27ae60';
        if (r.status==='going') return '#2980b9';
        if (r.status==='acknowledged') return '#e67e22';
        if (r.priority>=5 || r.types?.some(t=>/จมน้ำ/.test(t))) return '#c41e3a';
        return '#e74c3c';
    }

    function getTag(t) {
        if (/อาหาร|น้ำ/.test(t)) return {i:'utensils', txt:'อาหาร', c:'food'};
        if (/ติดอยู่|ชั้น/.test(t)) return {i:'home', txt:'ติดอยู่', c:'trapped'};
        if (/เด็ก/.test(t)) return {i:'child', txt:'เด็ก', c:'child'};
        if (/สูงอายุ|ผู้สูง/.test(t)) return {i:'wheelchair', txt:'สูงอายุ', c:'elderly'};
        if (/ยา|เวช/.test(t)) return {i:'pills', txt:'ยา', c:'med'};
        if (/สัตว์เลี้ยง/.test(t)) return {i:'paw', txt:'สัตว์', c:'pet'};
        if (/จมน้ำ/.test(t)) return {i:'water', txt:'จมน้ำ!!', c:'drowning'};
        if (/เสียชีวิต|ศพ/.test(t)) return {i:'skull-crossbones', txt:'เสียชีวิต', c:'death'};
        return {i:'hands-helping', txt:t.slice(0,8), c:''};
    }

    function getPriorityClass(p) {
        if (!p) return 'med';
        return p >= 7 ? 'critical' : p >= 5 ? 'high' : p >= 3 ? 'med' : 'low';
    }

    function updateStats(c) {
        statsEl.innerHTML = `ทั้งหมด ${c.all} • รอ ${c.pending} • ไป ${c.going} • รับทราบ ${c.acknowledged} • เสร็จ ${c.completed}`;
    }

    function filterCases(f) {
        currentFilter = f;
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.toggle('active',b.dataset.filter===f));
        document.querySelectorAll('.case').forEach(c=>c.style.display=(f==='all'||c.dataset.status===f)?'block':'none');
        Object.keys(markers).forEach(id=> {
            const m = markers[id]; const s = m.options.status || 'pending';
            (f==='all'||s===f) ? m.addTo(map) : map.removeLayer(m);
        });
    }

    function highlight(id) {
        document.querySelectorAll('.case').forEach(c=>c.classList.remove('active'));
        document.querySelectorAll('.tiny-marker').forEach(m=>m.classList.remove('active'));
        cards[id]?.classList.add('active');
        markers[id]?._icon?.classList.add('active');
        cards[id]?.scrollIntoView({behavior:'smooth',block:'nearest'});
    }

    async function load() {
        let data = {};
        try { data = await (await fetch(DB_URL + '?t=' + Date.now())).json() || {}; }
        catch { list.innerHTML = '<div style="text-align:center;padding:80px;color:#f66">เชื่อมต่อไม่ได้<br><button onclick="location.reload()" style="margin-top:15px;background:#c41e3a;padding:10px 25px;border:none;border-radius:30px;color:#fff">รีเฟรช</button></div>'; return; }

        if (!Object.keys(data).length) {
            list.innerHTML = '<div style="text-align:center;padding:100px;color:#888">ยังไม่มีคำขอช่วยเหลือ</div>';
            updateStats({all:0,pending:0,going:0,acknowledged:0,completed:0});
            return;
        }

        const counts = {all:0,pending:0,going:0,acknowledged:0,completed:0};
        const newIds = new Set();
        const fragment = document.createDocumentFragment();
        const sorted = Object.entries(data).sort(([,a],[,b])=>b.timestamp-a.timestamp);
        const keys = new Set(Object.keys(data));

        sorted.forEach(([id, r]) => {
            const status = r.status || 'pending';
            const color = getColor(r);
            const hasLoc = r.location?.lat && r.location?.lng;

            counts.all++; counts[status]++;
            if (status==='pending' && !notified.has(id)) {
                notified.add(id); newIds.add(id);
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-emergency-alert-loop-2979.mp3').play().catch(()=>{});
                navigator.vibrate?.([200,100,200]);
            }

            // Card เล็ก
            let card = cards[id] || document.createElement('div');
            card.className = 'case' + (newIds.has(id)?' new':'');
            card.dataset.status = status;
            card.onclick = () => { highlight(id); if(hasLoc) { map.setView([r.location.lat, r.location.lng], 17); markers[id].openPopup(); }};
            if (!cards[id]) cards[id] = card;

            let tags = '';
            if (r.types?.length) r.types.forEach(t => { const tg = getTag(t); tags += `<span class="tag ${tg.c}"><i class="fas fa-${tg.i}"></i>${tg.txt}</span>`; });
            else tags = '<span class="tag"><i class="fas fa-hands-helping"></i>ทั่วไป</span>';

            card.innerHTML = `
                <div class="case-top"><div class="case-name">${r.name||'ไม่ระบุ'}</div><div class="priority ${getPriorityClass(r.priority)}">P${r.priority||'?'}</div></div>
                ${r.phone ? `<div class="case-phone">${r.phone}</div>` : ''}
                <div class="tags">${tags}</div>
                ${r.note ? `<div class="case-note">${r.note}</div>` : ''}
                ${!hasLoc ? '<div class="no-location-notice">ไม่มีพิกัด</div>' : ''}
                <div class="case-footer"><div class="case-time">${formatTime(r.timestamp)}</div>
                    <button class="status-btn ${status}" onclick="event.stopPropagation();changeStatus('${id}','${status}')">${statusMap[status]}</button>
                </div>
            `;
            fragment.appendChild(card);

            // Marker + Popup เล็ก
            if (hasLoc) {
                const icon = L.divIcon({className:'tiny-marker'+(newIds.has(id)?' new':''), html:`<div style="--color:${color}"></div>`, iconSize:[15,15]});
                if (!markers[id]) markers[id] = L.marker([r.location.lat, r.location.lng], {icon, status}).addTo(map);
                else { markers[id].setIcon(icon); markers[id].options.status = status; markers[id].setLatLng([r.location.lat, r.location.lng]); }

                const popupHTML = `
                    <div class="popup-name">${r.name||'ไม่ระบุชื่อ'}</div>
                    <div class="popup-priority ${getPriorityClass(r.priority)}">P${r.priority||'?'}</div>
                    ${r.phone ? `<div class="popup-phone"><a href="tel:${r.phone}">โทร ${r.phone}</a></div>` : ''}
                    <div class="popup-tags">${tags}</div>
                    ${r.note ? `<div class="popup-note">${r.note}</div>` : ''}
                    <div class="popup-time">${formatTime(r.timestamp)}</div>
                    <button class="popup-nav-btn" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}&travelmode=driving')">
                        นำทางด่วน
                    </button>
                `;
                markers[id].bindPopup(popupHTML, {closeButton:false, autoClose:false, maxWidth:300});
                markers[id].off('click').on('click', () => { markers[id].openPopup(); map.setView([r.location.lat, r.location.lng], 17); highlight(id); });
                if (newIds.has(id)) setTimeout(() => { map.setView([r.location.lat, r.location.lng], 17); markers[id].openPopup(); }, 600);
            } else if (markers[id]) { map.removeLayer(markers[id]); delete markers[id]; }
        });

        Object.keys(cards).forEach(id => !keys.has(id) && (cards[id].remove(), delete cards[id], notified.delete(id), markers[id] && (map.removeLayer(markers[id]), delete markers[id])));
        list.innerHTML = ''; list.appendChild(fragment);
        updateStats(counts); filterCases(currentFilter);
    }

    function changeStatus(id, cur) {
        const menu = document.createElement('div');
        menu.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:25px;border:4px solid #c41e3a;border-radius:14px;z-index:99999;width:300px;text-align:center';
        menu.innerHTML = '<h3 style="color:#c41e3a;margin-bottom:15px">เปลี่ยนสถานะ</h3>';
        ['pending','going','acknowledged','completed','canceled'].forEach(s => {
            if (s===cur) return;
            const b = document.createElement('button');
            b.textContent = statusMap[s];
            b.style.cssText = `background:${s==='pending'?'#e74c3c':s==='going'?'#2980b9':s==='acknowledged'?'#e67e22':s==='completed'?'#27ae60':'#666'};color:#fff;border:none;padding:12px;margin:5px 0;width:100%;border-radius:30px;font-weight:bold;cursor:pointer`;
            b.onclick = () => fetch(`https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests/${id}/status.json`, {method:'PUT', body:JSON.stringify(s)})
                .then(() => { load(); menu.remove(); });
            menu.appendChild(b);
        });
        const close = document.createElement('button');
        close.textContent = 'ปิด'; close.style.cssText = 'margin-top:15px;background:#444;color:#fff;padding:10px 30px;border:none;border-radius:30px;cursor:pointer';
        close.onclick = () => menu.remove();
        menu.appendChild(close);
        document.body.appendChild(menu);
    }
    window.changeStatus = changeStatus;

    document.querySelectorAll('.filter-btn').forEach(b=>b.addEventListener('click',()=>filterCases(b.dataset.filter)));
    load();
    setInterval(load, 6000);
    setTimeout(()=>map.invalidateSize(),400);
</script>
</body>
</html>
