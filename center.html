<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ศูนย์กู้ภัยแห่งชาติ • แผนที่ Real-time</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100%; }
    .header { position: fixed; top: 0; left: 0; right: 0; background: #c62828; color: #fff; padding: 12px; font-size: 1.4rem; font-weight: bold; text-align: center; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    #alert { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: #ff1744; color: #fff; padding: 16px 40px; border-radius: 12px; font-size: 1.8rem; font-weight: bold; z-index: 9999; display: none; animation: shake 0.5s infinite; box-shadow: 0 0 30px #ff1744; }
    @keyframes shake { 0%, 100% { transform: translateX(-50%) rotate(0); } 25% { transform: translateX(-52%) rotate(-3deg); } 75% { transform: translateX(-48%) rotate(3deg); } }
    #stopAlert { position: fixed; top: 160px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 10px 30px; border: 2px solid #ff1744; border-radius: 10px; font-weight: bold; z-index: 9999; cursor: pointer; display: none; }
  </style>
</head>
<body>
  <div class="header">ศูนย์กู้ภัยแห่งชาติ • กด Marker เพื่อดูข้อมูล</div>
  <div id="alert">เคสด่วนระดับ 5 เข้ามา!</div>
  <button id="stopAlert" onclick="stopAlert()">หยุดเสียง</button>
  <div id="map"></div>

  <audio id="alarm" src="https://cdn.jsdelivr.net/gh/nzbin/three-dots@master/dist/audio/alert-critical.mp3" preload="auto" loop></audio>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.2/dist/leaflet.markercluster.js"></script>

  <script>
    // Firebase Init
    const firebaseConfig = { databaseURL: "https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref("sos_requests");
    console.log('Firebase initialized');

    // Map Setup
    const map = L.map('map').setView([13.9468, 100.5613], 16);  // ซูมไปที่ข้อมูลจริงของคุณ
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup({
      maxClusterRadius: 50,
      iconCreateFunction: function(cluster) {
        return L.divIcon({
          html: `<div style="background:#c62828;color:#fff;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:3px solid #fff;box-shadow:0 0 10px #000">${cluster.getChildCount()}</div>`,
          iconSize: [40, 40],
          className: 'cluster-icon'
        });
      }
    });
    map.addLayer(markers);

    // Colors for priority
    function getColor(priority) {
      if (priority >= 5) return '#ff1744';
      if (priority >= 4) return '#ff9100';
      return '#43a047';
    }

    // Alert function
    let isAlerting = false;
    function triggerAlert(name, priority) {
      if (isAlerting) return;
      isAlerting = true;
      document.getElementById('alert').innerHTML = `เคสด่วนระดับ ${priority}! <br>ชื่อ: ${name || 'ไม่ระบุ'}`;
      document.getElementById('alert').style.display = 'block';
      document.getElementById('stopAlert').style.display = 'block';
      const audio = document.getElementById('alarm');
      audio.play().catch(e => console.log('Audio error:', e));
      if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
      setTimeout(() => {
        audio.pause();
        audio.currentTime = 0;
        document.getElementById('alert').style.display = 'none';
        document.getElementById('stopAlert').style.display = 'none';
        isAlerting = false;
      }, 10000);  // หยุดอัตโนมัติหลัง 10 วินาที
    }

    function stopAlert() {
      const audio = document.getElementById('alarm');
      audio.pause();
      audio.currentTime = 0;
      document.getElementById('alert').style.display = 'none';
      document.getElementById('stopAlert').style.display = 'none';
      isAlerting = false;
    }

    // Firebase Listeners
    db.on('child_added', (snapshot) => {
      const id = snapshot.key;
      const data = snapshot.val();
      console.log('New case added:', id, data);  // Debug log

      if (!data || !data.location || !data.lat || !data.lng) {
        console.log('Invalid location for', id);
        return;
      }

      const lat = data.location.lat || data.lat;
      const lng = data.location.lng || data.lng;
      const priority = data.priority || 3;
      const status = data.status || 'pending';

      if (status === 'completed') return;

      // Create marker
      const icon = L.divIcon({
        html: `<div style="background:${getColor(priority)};color:#fff;width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:18px;border:3px solid #fff;box-shadow:0 0 15px ${getColor(priority)}aa">${priority}</div>`,
        iconSize: [44, 44],
        iconAnchor: [22, 22],
        className: 'custom-marker'
      });

      const marker = L.marker([lat, lng], { icon });
      markers.addLayer(marker);

      // Popup content
      const types = Array.isArray(data.types) ? data.types.join(', ') : 'ไม่ระบุ';
      const popupContent = `
        <div style="font-family:Arial,sans-serif;min-width:250px;padding:10px">
          <h3 style="color:${getColor(priority)};margin:0 0 10px 0">ด่วนระดับ ${priority}</h3>
          <b style="font-size:1.1rem">${data.name || 'ไม่ระบุชื่อ'}</b><br><br>
          ${data.phone ? `<a href="tel:${data.phone}" style="color:#fff;background:#1b5e20;padding:6px 12px;text-decoration:none;border-radius:4px">โทร ${data.phone}</a><br><br>` : ''}
          <strong>ประเภท:</strong> ${types}<br>
          <strong>เวลา:</strong> ${new Date(data.timestamp).toLocaleString('th-TH')}<br><br>
          <a href="https://maps.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" 
             style="background:#1565c0;color:#fff;padding:8px 12px;text-decoration:none;border-radius:6px;display:inline-block">
            นำทางไปยังจุด
          </a>
        </div>
      `;
      marker.bindPopup(popupContent, { maxWidth: 300 });

      // Trigger alert for high priority
      if (priority >= 4) {
        triggerAlert(data.name, priority);
      }
    });

    db.on('child_changed', (snapshot) => {
      const id = snapshot.key;
      const data = snapshot.val();
      console.log('Case changed:', id, data);

      if (markers.getLayers().some(layer => layer._leaflet_id === id)) {
        // Update marker status
        if (data.status === 'completed') {
          markers.removeLayer(markers.getLayers().find(layer => layer._leaflet_id === id));
        }
      }
    });

    // Initial load
    console.log('Map ready, waiting for data...');
  </script>
</body>
</html>
