<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}
        .header{position:fixed;top:0;left:0;right:0;height:55px;background:#c41e3a;z-index:1000;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;box-shadow:0 4px 20px rgba(0,0,0,0.6);}
        .sidebar{position:fixed;top:55px;left:0;bottom:0;width:430px;background:#0f0f0f;border-right:6px solid #c41e3a;z-index:999;overflow-y:auto;padding:14px;}
        .stats{background:linear-gradient(135deg,#1a1a1a,#0f0f0f);padding:18px;border-radius:16px;margin-bottom:18px;border:1px solid #333;box-shadow:0 8px 32px rgba(196,30,58,0.15);}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
        .stat-item{text-align:center;padding:16px 10px;border-radius:14px;background:rgba(255,255,255,0.07);cursor:pointer;transition:all .25s;border:2px solid transparent;}
        .stat-item.active{border-color:#c41e3a;background:rgba(196,30,58,0.25);transform:scale(1.05);}
        .stat-num{font-size:2rem;font-weight:800;margin-bottom:6px;}
        .total .stat-num{color:#c41e3a;}
        .pending .stat-num{color:#e74c3c;}
        .going .stat-num{color:#2980b9;}
        .completed .stat-num{color:#27ae60;}
        .rescue .stat-num{color:#ffb300;}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        .blink{animation:blink .6s ease-in-out 4}
        @keyframes pulse{0%{transform:scale(0.8);opacity:0.8}50%{transform:scale(1.3);opacity:0.4}100%{transform:scale(1.8);opacity:0}}
        #alertBar{position:fixed;top:55px;left:0;right:0;height:0;background:#e74c3c;color:#fff;font-weight:900;font-size:1.5rem;text-align:center;padding:0 20px;display:flex;align-items:center;justify-content:center;z-index:9999;overflow:hidden;transition:height .7s cubic-bezier(0.68,-0.55,0.27,1.55);box-shadow:0 10px 30px rgba(231,76,60,0.8);}
        #alertBar.show{height:70px}
        .case,.rescue-card{background:#fff;color:#222;border-radius:12px;margin-bottom:11px;box-shadow:0 4px 15px rgba(0,0,0,0.4);cursor:pointer;transition:all .25s;border-left:7px solid #ccc;display:none;}
        .case.show,.rescue-card.show{display:block;}
        .case.new{border-left:12px solid #ff1744 !important;}
        .rescue-card{border-left-color:#ffb300 !important;}
        .case:hover,.rescue-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.5);}
        .case.active,.rescue-card.active{box-shadow:0 0 0 5px rgba(196,30,58,0.4);transform:scale(1.02);}
        .case-header,.rescue-header{padding:13px 16px 8px;background:rgba(0,0,0,0.04);}
        .req-id,.team-name{font-size:1.35rem;font-weight:800;color:#c41e3a;}
        .team-name{color:#ffb300;}
        .case-body,.rescue-body{padding:0 16px 14px;}
        .line{margin:9px 0;font-size:0.98rem;display:flex;align-items:center;}
        .label{color:#444;font-weight:600;width:100px;}
        .value{flex:1;font-weight:500;color:#111;}
        .status-line{margin:12px 0 14px;padding:10px 12px;border-radius:10px;background:#f8f9fa;font-weight:700;border-left:5px solid;}
        .status-line.pending{background:#fdeaea;border-left-color:#e74c3c;color:#c41e3a;}
        .status-line.going{background:#e8f4fd;border-left-color:#2980b9;color:#1e6ca8;}
        .status-line.acknowledged{background:#fff4e5;border-left-color:#e67e22;color:#d35400;}
        .status-line.completed{background:#eaf7ec;border-left-color:#27ae60;color:#1e8449;}
        .note-line{background:#ffebee;padding:12px 14px;border-radius:10px;margin:10px 0;border-left:6px solid #e74c3c;color:#c41e3a;font-weight:700;font-size:1rem;}
        .status-btns{display:flex;gap:7px;margin-top:12px;}
        .status-btn{flex:1;padding:11px 6px;font-size:0.88rem;font-weight:700;border-radius:10px;border:none;cursor:pointer;color:#fff;background:#777;transition:all 0.3s;}
        .status-btn.active{transform:scale(1.08);box-shadow:0 4px 15px rgba(0,0,0,0.4);}
        .status-btn.pending.active{background:#e74c3c;}
        .status-btn.going.active{background:#2980b9;}
        .status-btn.acknowledged.active{background:#e67e22;}
        .status-btn.completed.active{background:#27ae60;}
        .btn-group{display:flex;gap:8px;margin-top:12px;}
        .btn-small{padding:10px 14px;background:#333;color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;}
        .btn-small.tel{background:#25d366;}
        .btn-small.nav{background:#ffb300;color:#000;}
    </style>
</head>
<body>
<div class="header">ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</div>
<div id="alertBar">มีเคสใหม่ด่วน! #ABC123 – อยู่บนหลังคา</div>
<div class="sidebar">
    <div class="stats">
        <div style="text-align:center;font-weight:700;margin-bottom:12px;">สรุปสถานการณ์ล่าสุด</div>
        <div class="stats-grid">
            <div class="stat-item total active" data-filter="all"><div class="stat-num" id="countAll">0</div><div>เคสทั้งหมด</div></div>
            <div class="stat-item pending" data-filter="pending"><div class="stat-num" id="countPending">0</div><div>รอช่วยเหลือ</div></div>
            <div class="stat-item going" data-filter="going"><div class="stat-num" id="countGoing">0</div><div>กำลังไป</div></div>
            <div class="stat-item completed" data-filter="completed"><div class="stat-num" id="countCompleted">0</div><div>เสร็จสิ้น</div></div>
            <div class="stat-item rescue" data-filter="rescue"><div class="stat-num" id="countRescue">0</div><div>ทีมกู้ภัย</div></div>
        </div>
    </div>
    <div id="list"></div>
</div>
<div id="map"></div>
<audio id="alertSound" src="https://cdn.jsdelivr.net/gh/napsterking/alert-sound@master/alert.mp3" preload="auto"></audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    const map = L.map('map').setView([13.94678, 100.56125], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const typeColors = {
        'น้ำ':'#3498db','อาหาร':'#2ecc71','ยา':'#9b59b6','เรือ':'#e67e22','เฮลิคอปเตอร์':'#e74c3c',
        'ที่พักอาศัย':'#f1c40f','ไฟฉาย':'#1abc9c','อื่นๆ':'#95a5a6','default':'#ff6b6b', // สีแดง fallback เด่น
        'อาหารและน้ำ':'#2ecc71','มีเด็ก':'#9b59b6','มีผู้สูงอายุ':'#e67e22','ติดอยู่ในพื้นที่':'#95a5a6',
        'กำลังจมน้ำ':'#e74c3c','สัตว์เลี้ยง':'#1abc9c','เจ็บป่วย':'#3498db' // เพิ่ม types จริงจากข้อมูล
    };
    const statusColor = {pending:'#e74c3c',going:'#2980b9',acknowledged:'#e67e22',completed:'#27ae60'};
    const statusName = {pending:'รอช่วย',going:'กำลังไป',acknowledged:'รับทราบ',completed:'เสร็จสิ้น'};
    const priority = {pending:4,going:3,acknowledged:2,completed:1};

    const sosCluster = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        maxClusterRadius: 70,
        iconCreateFunction: c => {
            let highestPrio = 0, col = '#95a5a6';
            c.getAllChildMarkers().forEach(m => {
                if (m.options.prio > highestPrio) {
                    highestPrio = m.options.prio;
                    col = m.options.status === 'pending' ? '#e74c3c' : m.options.typeColor;
                }
            });
            const n = c.getChildCount();
            const s = n < 10 ? 52 : n < 100 ? 62 : 72;
            return L.divIcon({
                html: `<div style="background:${col};width:${s}px;height:${s}px;border-radius:50%;border:5px solid #fff;box-shadow:0 6px 30px rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:${s/2.5}px;color:#fff;text-shadow:0 2px 8px #000;">${n}</div>`,
                className: 'custom-cluster',
                iconSize: [s, s]
            });
        }
    });

    const rescueLayer = L.layerGroup();
    map.addLayer(sosCluster);
    map.addLayer(rescueLayer);

    const SOS_DB = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests';
    const RESCUE_DB = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/rescue_teams';
    const list = document.getElementById('list');
    const alertBar = document.getElementById('alertBar');
    const alertSound = document.getElementById('alertSound');
    const pendingEl = document.getElementById('countPending');
    let currentFilter = 'all';
    let previousIds = new Set();
    let allSosMarkers = {};
    let rescueTeamMarkers = {};
    let rescueTrails = {};

    const rescueIcon = L.divIcon({
        html: `<div style="position:relative;width:50px;height:50px;">
                 <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:#ffb300;border-radius:50%;box-shadow:0 0 25px #ffb300, 0 6px 30px rgba(0,0,0,0.8);"></div>
                 <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;">⚡</div>
               </div>`,
        className: '',
        iconSize: [50,50],
        iconAnchor: [25,25]
    });

    function formatTime(ts){
        const d = (Date.now() - ts) / 60000;
        if(d<60) return `${Math.floor(d)} นาที`;
        if(d<1440) return `${Math.floor(d/60)} ชม.`;
        return `${Math.floor(d/1440)} วัน`;
    }

    function getMainType(t){
        if(!t||!Array.isArray(t)) return 'default';
        // ขยาย order ให้ครอบคลุม types จริงจากข้อมูล
        const order = [
            'เฮลิคอปเตอร์','เรือ','ยา','น้ำ','อาหาร','ที่พักอาศัย','ไฟฉาย','อื่นๆ',
            'อาหารและน้ำ','มีเด็ก','มีผู้สูงอายุ','ติดอยู่ในพื้นที่','กำลังจมน้ำ','สัตว์เลี้ยง','เจ็บป่วย'
        ];
        for(let x of order) if(t.includes(x)) return x;
        return 'default';
    }

    function triggerAlert(id,name,note){
        alertBar.textContent=`มีเคสใหม่ด่วน! #${id} – ${name}${note?` – ${note}`:''}`;
        alertBar.classList.add('show');
        alertSound.play().catch(()=>{});
        pendingEl.classList.add('blink');
        setTimeout(()=>{alertBar.classList.remove('show');pendingEl.classList.remove('blink');},10000);
    }

    function createSOSMarker(lat, lng, status, typeColor, reqId, name, types, note, timeAgo){
        const isPending = status === 'pending';
        const pulse = isPending ? `<div style="position:absolute;top:-15px;left:-15px;right:-15px;bottom:-15px;border:5px solid #ff1744;border-radius:50%;animation:pulse 1.8s infinite;opacity:0.9;"></div>` : '';
        
        const html = `
            <div style="position:relative;width:48px;height:48px;">
                ${pulse}
                <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:${typeColor};border-radius:50%;box-shadow:0 6px 25px rgba(0,0,0,0.8);"></div>
                <div style="position:absolute;top:0;left:0;right:0;bottom:0;border:6px solid ${isPending?'#ff1744':statusColor[status]};border-radius:50%;box-shadow:0 0 25px ${isPending?'#ff1744':statusColor[status]};"></div>
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:22px;font-weight:900;text-shadow:0 2px 10px rgba(0,0,0,0.9);">
                    ${isPending ? '!' : '●'}
                </div>
            </div>
        `;

        const icon = L.divIcon({html, className: '', iconSize: [48,48], iconAnchor: [24,24]});
        const marker = L.marker([lat,lng], {icon, prio: priority[status], typeColor, status});
        
        const typeText = types.length ? types.join(', ') : 'ไม่ระบุ';
        marker.bindPopup(`
            <div style="font-family:'Sarabun',sans-serif;padding:6px;">
                <b style="font-size:1.5rem;color:#c41e3a;">#${reqId}</b><br>
                <b>ชื่อ:</b> ${name||'ไม่ระบุ'}<br>
                <b>ต้องการ:</b> ${typeText}<br>
                <b>สถานะ:</b> <span style="color:${isPending?'#e74c3c':statusColor[status]};font-weight:bold;">${statusName[status]}</span><br>
                ${note?`<b>หมายเหตุ:</b> <span style="color:#e74c3c;font-weight:bold;">${note}</span><br>`:''}
                <b>รับแจ้ง:</b> ${timeAgo}ที่แล้ว
            </div>`, {maxWidth:360});

        return marker;
    }

    function applyFilter(){
        document.querySelectorAll('.case,.rescue-card').forEach(el=>{
            const show = currentFilter==='all' || 
                        currentFilter===el.dataset.status || 
                        (currentFilter==='rescue' && el.classList.contains('rescue-card'));
            el.classList.toggle('show',show);
        });

        sosCluster.clearLayers();
        if(currentFilter !== 'rescue'){
            Object.values(allSosMarkers).forEach(m=>{
                if(currentFilter==='all' || m.options.status===currentFilter){
                    sosCluster.addLayer(m);
                }
            });
        } else {
            const b = rescueLayer.getBounds();
            if(b.isValid()) map.fitBounds(b.pad(0.4));
        }
    }

    async function loadAll(){
        let data = {};
        try{data = await (await fetch(SOS_DB+'.json?t='+Date.now())).json()||{};}catch(e){console.error('SOS Error:', e);}
        allSosMarkers = {};
        const counts = {all:0,pending:0,going:0,acknowledged:0,completed:0};
        const frag = document.createDocumentFragment();
        const currentIds = new Set();
        let newestCase = null;

        Object.entries(data)
            .sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0))
            .forEach(([id,r])=>{
                const status = r.status||'pending';
                const types = r.types||[];
                const mainType = getMainType(types);
                const typeColor = typeColors[mainType] || typeColors.default; // Fallback ชัดเจน
                counts.all++; counts[status]++;

                const lat = r.location?.lat;
                const lng = r.location?.lng;
                const hasLoc = lat&&lng;
                const reqId = r.requestId||id.slice(-6).toUpperCase();
                const timeAgo = formatTime(r.timestamp);
                const note = r.note ? r.note.trim() : '';
                const typeText = types.length?types.join(', '):'ไม่ระบุ';
                currentIds.add(id);

                if(!previousIds.has(id) && status==='pending'){
                    newestCase = {id, reqId, name: r.name||r.fullname||'ไม่ระบุ', note};
                    triggerAlert(reqId, newestCase.name, note);
                }

                // Card SOS เต็มรูปแบบ
                const card = document.createElement('div');
                card.className = `case ${status}${newestCase?.id===id?' new':''}`;
                card.dataset.status = status;
                card.style.borderLeftColor = typeColor;
                card.innerHTML = `
                    <div class="case-header"><div class="req-id">#${reqId}</div></div>
                    <div class="case-body">
                        <div class="line"><span class="label">ชื่อ:</span><span class="value">${r.name||r.fullname||'ไม่ระบุ'}</span></div>
                        <div class="line"><span class="label">ต้องการ:</span><span class="value">${typeText}</span></div>
                        <div class="line"><span class="label">รับแจ้ง:</span><span class="value">${timeAgo}ที่แล้ว</span></div>
                        ${note?`<div class="note-line">หมายเหตุ: ${note}</div>`:''}
                        <div class="status-line ${status}">สถานะ: ${statusName[status]}</div>
                        <div class="status-btns">
                            <button class="status-btn pending ${status==='pending'?'active':''}" onclick="event.stopPropagation();confirmStatus('${id}','pending')">รอช่วย</button>
                            <button class="status-btn going ${status==='going'?'active':''}" onclick="event.stopPropagation();confirmStatus('${id}','going')">กำลังไป</button>
                            <button class="status-btn acknowledged ${status==='acknowledged'?'active':''}" onclick="event.stopPropagation();confirmStatus('${id}','acknowledged')">รับทราบ</button>
                            <button class="status-btn completed ${status==='completed'?'active':''}" onclick="event.stopPropagation();confirmStatus('${id}','completed')">เสร็จสิ้น</button>
                        </div>
                    </div>`;
                card.onclick = e=>{
                    if(e.target.tagName==='BUTTON') return;
                    document.querySelectorAll('.case,.rescue-card').forEach(c=>c.classList.remove('active'));
                    card.classList.add('active');
                    if(hasLoc) map.setView([lat,lng],18);
                };
                frag.appendChild(card);

                if(hasLoc){
                    const m = createSOSMarker(lat, lng, status, typeColor, reqId, r.name||r.fullname, types, note, timeAgo);
                    allSosMarkers[id] = m;
                }
            });

        // === ทีมกู้ภัย (แก้ให้แน่นอน) ===
        let activeTeams = 0;
        try{
            const rdata = await (await fetch(RESCUE_DB+'.json?t='+Date.now())).json()||{};
            Object.entries(rdata).forEach(([id,t])=>{
                if(!t.lat || !t.lng || !t.active){
                    if(rescueTeamMarkers[id]) rescueLayer.removeLayer(rescueTeamMarkers[id]);
                    if(rescueTrails[id]) rescueLayer.removeLayer(rescueTrails[id]);
                    delete rescueTeamMarkers[id]; delete rescueTrails[id];
                    return;
                }
                activeTeams++;
                const name = t.name || "ทีมกู้ภัย";
                const speed = t.speed ? parseFloat(t.speed).toFixed(1) + ' กม./ชม.' : 'หยุดนิ่ง';

                if(rescueTeamMarkers[id]){
                    rescueTeamMarkers[id].setLatLng([t.lat, t.lng]);
                    if(rescueTrails[id]){
                        rescueTrails[id].addLatLng([t.lat, t.lng]);
                        if(rescueTrails[id].getLatLngs().length > 50) rescueTrails[id].getLatLngs().shift();
                    }
                } else {
                    const m = L.marker([t.lat, t.lng], {icon: rescueIcon}).addTo(rescueLayer);
                    m.bindPopup(`
                        <div style="font-weight:bold;color:#ffb300;font-size:1.4rem;">ทีม: ${name}</div>
                        <b>ประเภท:</b> ${t.vehicle||'ไม่ระบุ'}<br>
                        <b>ความเร็ว:</b> ${speed}<br>
                        ${t.phone?`<b>โทร:</b> <a href="tel:${t.phone}">${t.phone}</a><br>`:''}
                        <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${t.lat},${t.lng}')" style="margin-top:8px;width:100%;padding:12px;background:#ffb300;color:#000;border:none;border-radius:10px;font-weight:bold">นำทางไปหาทีม</button>
                    `, {maxWidth:360});
                    rescueTeamMarkers[id] = m;
                    rescueTrails[id] = L.polyline([[t.lat, t.lng]], {color:'#ffb300', weight:5, opacity:0.8}).addTo(rescueLayer);
                }

                // Card ทีมกู้ภัย เต็มรูปแบบ
                const rc = document.createElement('div');
                rc.className = 'rescue-card';
                rc.dataset.status = 'rescue';
                rc.innerHTML = `
                    <div class="rescue-header"><div class="team-name">ทีม: ${name}</div></div>
                    <div class="rescue-body">
                        <div class="line"><span class="label">ประเภท:</span><span class="value">${t.vehicle||'ไม่ระบุ'}</span></div>
                        <div class="line"><span class="label">ความเร็ว:</span><span class="value">${speed}</span></div>
                        ${t.phone?`<div class="line"><span class="label">เบอร์:</span><span class="value">${t.phone}</span></div>`:''}
                        <div class="btn-group">
                            ${t.phone?`<button class="btn-small tel" onclick="window.location.href='tel:${t.phone}'">โทร</button>`:''}
                            <button class="btn-small nav" onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${t.lat},${t.lng}')">นำทาง</button>
                        </div>
                    </div>`;
                rc.onclick = ()=>{document.querySelectorAll('.case,.rescue-card').forEach(c=>c.classList.remove('active'));rc.classList.add('active');map.setView([t.lat,t.lng],16);};
                frag.appendChild(rc);
            });
        }catch(e){console.error('Rescue Error:', e);}

        document.getElementById('countAll').textContent = counts.all;
        document.getElementById('countPending').textContent = counts.pending;
        document.getElementById('countGoing').textContent = counts.going;
        document.getElementById('countCompleted').textContent = counts.completed;
        document.getElementById('countRescue').textContent = activeTeams;

        list.innerHTML = '';
        list.appendChild(frag);
        applyFilter(); // เรียก applyFilter เพื่อ add marker ตาม filter
        previousIds = currentIds;
    }

    function confirmStatus(id,st){
        if(confirm(`เปลี่ยนสถานะเป็น "${statusName[st]}" ใช่หรือไม่?`)){
            fetch(`${SOS_DB}/${id}.json`,{
                method:'PATCH',
                body:JSON.stringify({status:st,updatedAt:Date.now()})
            }).then(()=>loadAll());
        }
    }

    document.querySelectorAll('.stat-item').forEach(item=>{
        item.onclick=()=>{
            document.querySelectorAll('.stat-item').forEach(i=>i.classList.remove('active'));
            item.classList.add('active');
            currentFilter = item.dataset.filter || 'all';
            applyFilter();
        };
    });

    loadAll();
    setInterval(loadAll, 3000);
    setTimeout(()=>map.invalidateSize(), 500);
</script>
</body>
</html>
