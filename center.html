<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ศูนย์สั่งการรับเรื่อง</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
    body{background:#000;color:#fff;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    #map{flex:1}
    .header{background:#c62828;padding:15px;text-align:center;font-weight:900;font-size:1.5rem;position:relative}
    .count{position:absolute;right:15px;top:13px;background:#fff;color:#c62828;padding:6px 12px;border-radius:20px;font-size:0.9rem;font-weight:900}
    .sound{position:absolute;left:15px;top:13px;background:#333;padding:6px 12px;border-radius:20px;font-size:0.8rem;cursor:pointer}
    .container{display:flex;flex:1;overflow:hidden}
    #sidebar{width:100%;max-width:380px;background:#111;overflow-y:auto;padding:8px 0}
    .case{background:#1a1a1a;margin:6px 10px;padding:10px 14px;border-radius:12px;border-left:5px solid #ff1744;
         box-shadow:0 3px 10px rgba(0,0,0,0.6);transition:0.2s;cursor:pointer;font-size:0.92rem}
    .case:hover{background:#222;transform:translateY(-1px)}
    .case-id{font-size:1.25rem;font-weight:900;color:#fff;background:#c62828;padding:3px 10px;border-radius:10px;display:inline-block}
    .types{color:#ff9800;font-weight:700;margin:4px 0}
    .info{line-height:1.4;opacity:0.95}
    .noloc{color:#ff6b6b;font-size:0.85rem}
    .btns{margin-top:8px;display:flex;flex-wrap:wrap;gap:5px}
    .btn{padding:6px 12px;border:none;border-radius:16px;font-weight:900;font-size:0.8rem}
    .going{background:#ff9800;color:#000}
    .success{background:#4caf50;color:#fff}
    .cannot{background:#f44336;color:#fff}
    .nav{background:#2196f3;color:#fff}
    .call{background:#00c853;color:#fff}
    .alert{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#ff1744;color:#fff;padding:14px 40px;border-radius:50px;font-size:1.4rem;font-weight:900;z-index:9999;animation:a 0.7s}
    @keyframes a{0%{opacity:0;transform:translateX(-50%) translateY(-100px)}100%{opacity:1;transform:translateX(-50%) translateY(0)}}
    @media(max-width:900px){.container{flex-direction:column}#sidebar{height:45%}}
  </style>
</head>
<body>

<div class="header">
  ศูนย์สั่งการรับเรื่องกู้ภัย
  <div class="count" id="count">0</div>
  <div class="sound" id="soundBtn" onclick="soundEnabled=!soundEnabled;this.textContent=soundEnabled?'เปิดเสียง':'ปิดเสียง';this.style.background=soundEnabled?'#4caf50':'#666'">เปิดเสียง</div>
</div>

<div class="container">
  <div id="sidebar">กำลังโหลด...</div>
  <div id="map"></div>
</div>

<script>
const map = L.map('map').setView([13.7563, 100.5018], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let soundEnabled = true;
const beep = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-emergency-alert-alarm-1001.mp3');
function alertNew(t){const d=document.createElement('div');d.className='alert';d.textContent=t;document.body.appendChild(d);setTimeout(()=>d.remove(),4500);if(soundEnabled)beep.play();if(navigator.vibrate)navigator.vibrate([500,200,500]);new Notification("เคสใหม่!", {body:t});}
Notification.requestPermission();

setTimeout(()=>{
  const s1=document.createElement('script');s1.src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js";document.head.appendChild(s1);
  s1.onload=()=>{
    const s2=document.createElement('script');s2.src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js";document.head.appendChild(s2);
    s2.onload=main;
  };
},1000);

function main(){
  firebase.initializeApp({databaseURL:"https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app"});
  const ref = firebase.database().ref("sos_requests").orderByChild("timestamp");

  const sidebar = document.getElementById('sidebar');
  sidebar.innerHTML='';
  let n=1;

  ref.on('child_added',s=>{
    const d=s.val(), k=s.key;
    const caseId = `เคส #${String(n++).padStart(3,'0')}`;
    const types = Array.isArray(d.types)?d.types.join(' • '):d.types||'ขอความช่วยเหลือ';

    alertNew(caseId + ' – ' + types);

    const card = document.createElement('div');
    card.className='case';
    card.innerHTML = `
      <div class="case-id">${caseId}</div>
      <div class="types">${types}</div>
      <div class="info">
        ${d.name?`ชื่อ: ${d.name}<br>`:''}
        ${d.phone?`เบอร์: ${d.phone}<br>`:''}
        ${d.note?`หมายเหตุ: ${d.note}`:'ไม่มีหมายเหตุ'}
        ${!d.location?'<div class="noloc">ไม่มี GPS</div>':''}
      </div>
      <div class="btns">
        <button class="btn going" onclick="set('${k}','going')">กำลังไป</button>
        <button class="btn success" onclick="set('${k}','success')">สำเร็จ</button>
        <button class="btn cannot" onclick="set('${k}','cannot')">ไม่สามารถ</button>
        ${d.location?`<button class="btn nav" onclick="window.open('https://maps.google.com?q=${d.location.lat},${d.location.lng}')">นำทาง</button>`:''}
        ${d.phone?`<button class="btn call" onclick="location.href='tel:${d.phone}'">โทร</button>`:''}
      </div>
    `;

    if(d.location){
      card.onclick=e=>{if(e.target.tagName!=='BUTTON')map.setView([d.location.lat,d.location.lng],18);};
      L.marker([d.location.lat,d.location.lng],{icon:L.divIcon({html:'<div style="background:#ff1744;width:20px;height:20px;border-radius:50%;box-shadow:0 0 20px 15px #ff1744"></div>',iconSize:[20,20]})}).addTo(map);
    }else{
      card.onclick=()=>{alert('ไม่มีตำแหน่ง GPS\nกรุณาโทรติดต่อ: '+(d.phone||'ไม่มีเบอร์'));}
    }

    sidebar.insertBefore(card, sidebar.firstChild);
    document.getElementById('count').textContent = n-1;
  });

  window.set=(k,st)=>firebase.database().ref("sos_requests/"+k).update({status:st});
}
</script>
</body>
</html>

