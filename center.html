<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body,html{margin:0;padding:0;height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}
        .header{position:fixed;top:0;left:0;right:0;height:68px;background:#111;border-bottom:5px solid #c41e3a;z-index:1000;display:flex;align-items:center;justify-content:center}
        .header h1{font-size:1.95rem;color:#c41e3a;font-weight:800}
        .sidebar{position:fixed;top:68px;left:0;bottom:0;width:520px;background:rgba(10,15,35,0.98);backdrop-filter:blur(20px);z-index:999;overflow-y:auto;padding:24px;border-right:6px solid #c41e3a}
        .item{background:linear-gradient(135deg,rgba(255,255,255,0.08),rgba(255,255,255,0.03));border-radius:20px;padding:26px;margin-bottom:22px;cursor:pointer;position:relative;transition:all 0.4s;box-shadow:0 10px 30px rgba(0,0,0,0.6);border-left:8px solid transparent}
        .item:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(196,30,58,0.4)}
        .item.highlight{background:linear-gradient(135deg,rgba(196,30,58,0.4),rgba(196,30,58,0.2))!important;border:3px solid #c41e3a!important;box-shadow:0 0 40px rgba(196,30,58,0.8)!important;transform:scale(1.03)!important}
        .pri-badge{position:absolute;top:18px;right:18px;background:#c41e3a;color:#fff;padding:12px 22px;border-radius:40px;font-weight:900;font-size:1.1rem}
        .status-dot{width:26px;height:26px;border-radius:50%;display:inline-block;margin-right:14px;border:5px solid #fff;box-shadow:0 4px 15px rgba(0,0,0,0.7)}
        .name{font-size:1.7rem;font-weight:700;margin-bottom:8px}
        .phone{font-size:1.3rem;color:#0ff;font-weight:bold;margin:10px 0}
        .types{font-size:1.2rem;color:#ffdd00;line-height:1.7;margin:14px 0;padding:14px;background:rgba(255,255,255,0.05);border-radius:14px}
        .timestamp{margin:14px 0;padding:12px;background:rgba(255,215,0,0.2);border-radius:12px;border-left:5px solid #ffdd00;font-weight:bold;text-align:center}
        .status-btn{background:#c41e3a;color:#fff;padding:18px;border:none;border-radius:16px;font-weight:900;width:100%;margin-top:18px;cursor:pointer;font-size:1.2rem}
        .status-btn:hover{background:#e74c3c;transform:scale(1.05)}
        .loading{color:#c41e3a;text-align:center;padding:80px;font-size:1.6rem}
        .error{color:#ff6b6b;background:#300;padding:20px;border-radius:16px;margin:20px;text-align:center}
        .marker-pin{width:36px;height:36px;border-radius:50% 50% 50% 0;background:var(--color);transform:rotate(-45deg);border:5px solid #fff;box-shadow:0 4px 20px rgba(0,0,0,0.8)}
        .marker-pin::after{content:'';width:16px;height:16px;background:#fff;border-radius:50%;position:absolute;top:10px;left:10px}
        .marker-pin.new{animation:pulse 2s infinite}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(220,38,38,0.9)}70%{box-shadow:0 0 0 30px transparent}}
    </style>
</head>
<body>

<div class="header"><h1>ศูนย์บัญชาการช่วยเหลือผู้ประสบภัย</h1></div>

<div class="sidebar">
    <h2 style="color:#c41e3a;text-align:center;margin-bottom:28px;font-size:2.1rem">รายการคำขอความช่วยเหลือ</h2>
    <div id="list"><div class="loading">กำลังเชื่อมต่อฐานข้อมูล...</div></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([13.94678, 100.56125], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = {};
    const cards = {};
    const list = document.getElementById('list');
    const notified = new Set();
    let hasZoomed = false;

    // สำรอง: ถ้า Firebase ช้าเกิน 8 วินาที ให้ลองรีโหลดอัตโนมัติ
    async function load() {
        list.innerHTML = `<div class="loading">กำลังโหลดข้อมูล... <span id="dot">...</span></div>`;
        const dot = document.getElementById('dot');
        let dots = 0;
        const dotInterval = setInterval(() => { dots = (dots+1)%4; dot.textContent = '.'.repeat(dots); }, 500);

        let data = {};
        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 9000); // ตั้งเวลา 9 วิ

            const res = await fetch('https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests.json', {signal: controller.signal});
            clearTimeout(timeout);

            if (!res.ok) throw new Error('เชื่อมต่อไม่ได้');
            data = await res.json();
            if (data === null) data = {};

        } catch (e) {
            clearInterval(dotInterval);
            list.innerHTML = `<div class="error">
                เชื่อมต่อฐานข้อมูลไม่สำเร็จ<br><br>
                <button onclick="location.reload()" style="background:#c41e3a;padding:16px 32px;border:none;border-radius:12px;color:#fff;font-weight:bold;cursor:pointer">รีเฟรชใหม่</button>
            </div>`;
            return;
        }

        clearInterval(dotInterval);

        if (Object.keys(data).length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:100px;color:#666;font-size:1.5rem">ยังไม่มีคำขอช่วยเหลือ</div>';
            return;
        }

        list.innerHTML = '';
        const newIds = new Set();

        Object.entries(data).forEach(([id, r]) => {
            if (!r.location?.lat || !r.location?.lng) return;

            // แจ้งเตือนจุดใหม่
            if ((r.status || 'pending') === 'pending' && !notified.has(id)) {
                notified.add(id);
                newIds.add(id);
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-emergency-alert-long-1004.mp3').play().catch(()=>{});
            }

            const color = (() => {
                if (r.types && r.types.some(t => /เสียชีวิต|ตาย|ศพ/.test(t))) return '#000000';
                if (r.status === 'completed') return '#27ae60';
                if (r.status === 'going') return '#2980b9';
                if (r.status === 'acknowledged') return '#e67e22';
                if (r.priority >= 5 || (r.types && r.types.some(t => /จมน้ำ/.test(t)))) return '#c41e3a';
                return '#e74c3c';
            })();

            const isNew = newIds.has(id);

            const div = document.createElement('div');
            div.className = `item ${r.status || 'pending'}`;
            div.innerHTML = `
                <div class="pri-badge">P${r.priority || '?'}</div>
                <div class="name"><span class="status-dot" style="background:${color}"></span>${r.name || 'ไม่ระบุชื่อ'}</div>
                ${r.phone ? `<div class="phone">โทร: ${r.phone}</div>` : ''}
                <div class="types">${r.types ? r.types.join(' • ') : 'ขอความช่วยเหลือทั่วไป'}</div>
                <div class="timestamp">แจ้งเมื่อ: ${new Date(r.timestamp).toLocaleString('th-TH')}</div>
                <button class="status-btn">เปลี่ยนสถานะ</button>
            `;

            div.onclick = (e) => {
                if (e.target.classList.contains('status-btn')) return;
                map.setView([r.location.lat, r.location.lng], 18);
                markers[id].openPopup();
                highlightCard(id);
            };

            div.querySelector('.status-btn').onclick = (e) => {
                e.stopPropagation();
                showStatusMenu(id, r.status || 'pending');
            };

            div.onmouseenter = () => highlightCard(id);
            div.onmouseleave = () => clearHighlight();

            list.appendChild(div);
            cards[id] = div;

            // Marker สวย
            const icon = L.divIcon({
                className: '',
                html: `<div class="marker-pin${isNew?' new':''}" style="--color:${color}"></div>`,
                iconSize: [36,36],
                iconAnchor: [18,36],
                popupAnchor: [0,-36]
            });

            if (markers[id]) {
                markers[id].setLatLng([r.location.lat, r.location.lng]).setIcon(icon);
            } else {
                markers[id] = L.marker([r.location.lat, r.location.lng], {icon}).addTo(map);
            }

            markers[id].bindPopup(`
                <div style="font-family:Sarabun;padding:20px;min-width:340px">
                    <div style="background:${color};color:#fff;padding:16px;border-radius:16px;text-align:center;font-weight:900;margin-bottom:16px;font-size:1.4rem">
                        P${r.priority||'?'} • ${r.priority>=5?'เร่งด่วนมาก':''}
                    </div>
                    <b style="font-size:2rem">${r.name||'ไม่ระบุชื่อ'}</b><br>
                    ${r.phone ? `โทร: <a href="tel:${r.phone}" style="color:#0f0;font-size:1.8rem;font-weight:bold">${r.phone}</a><br>` : ''}
                    <div style="margin:16px 0;padding:16px;background:rgba(255,255,255,0.1);border-radius:14px;color:#ffdd00">
                        ${r.types ? r.types.join(' • ') : 'ขอความช่วยเหลือทั่วไป'}
                    </div>
                    <div style="margin:14px 0;padding:14px;background:rgba(255,215,0,0.2);border-radius:12px;border-left:5px solid gold;font-weight:bold">
                        แจ้งเมื่อ: ${new Date(r.timestamp).toLocaleString('th-TH')}
                    </div>
                    <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}')"
                        style="margin-top:16px;background:#c41e3a;color:#fff;padding:20px;width:100%;border:none;border-radius:16px;font-weight:900;font-size:1.5rem">
                        นำทางไปยังจุดนี้ทันที
                    </button>
                </div>
            `);

            markers[id].on('mouseover', () => highlightCard(id));
            markers[id].on('mouseout', clearHighlight);
        });

        if (!hasZoomed && Object.keys(markers).length > 0) {
            hasZoomed = true;
            setTimeout(() => map.fitBounds(L.featureGroup(Object.values(markers)).getBounds().pad(0.6)), 800);
        }
    }

    function highlightCard(id) {
        Object.values(cards).forEach(c => c.classList.remove('highlight'));
        cards[id]?.classList.add('highlight');
        cards[id]?.scrollIntoView({behavior:'smooth', block:'center'});
    }

    function clearHighlight() {
        Object.values(cards).forEach(c => c.classList.remove('highlight'));
    }

    function showStatusMenu(id, current) {
        // (เหมือนเดิม)
        const menu = document.createElement('div');
        menu.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;border:5px solid #c41e3a;border-radius:20px;padding:35px;z-index:99999;min-width:400px;box-shadow:0 0 50px rgba(196,30,58,0.9)';
        menu.innerHTML = `<h2 style="color:#c41e3a;text-align:center;margin-bottom:25px">เปลี่ยนสถานะ</h2>`;
        const opts = [
            {s:'going', l:'กำลังเข้าช่วยเหลือ', c:'#2980b9'},
            {s:'acknowledged', l:'รับทราบแล้ว', c:'#e67e22'},
            {s:'completed', l:'ช่วยเหลือเสร็จสิ้น', c:'#27ae60'},
            {s:'canceled', l:'ยกเลิกคำขอ', c:'#95a5a6'}
        ];
        opts.forEach(o => {
            if (o.s === current) return;
            const b = document.createElement('div');
            b.textContent = o.l;
            b.style.cssText = `background:${o.c};color:#fff;padding:20px;margin:12px 0;border-radius:16px;text-align:center;font-weight:900;font-size:1.3rem;cursor:pointer`;
            b.onclick = () => {
                if (confirm(`เปลี่ยนเป็น "${o.l}" ?`)) {
                    fetch(`https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests/${id}/status.json`, {
                        method:'PUT', body:JSON.stringify(o.s)
                    }).then(()=>load());
                    document.body.removeChild(menu);
                }
            };
            menu.appendChild(b);
        });
        const close = document.createElement('div');
        close.textContent = 'ปิด';
        close.style.cssText = 'background:#444;color:#fff;padding:16px;margin-top:20px;border-radius:16px;text-align:center;cursor:pointer;font-weight:bold';
        close.onclick = () => document.body.removeChild(menu);
        menu.appendChild(close);
        document.body.appendChild(menu);
    }

    // โหลดทันที + ทุก 5 วินาที
    load();
    setInterval(load, 5000);
    setTimeout(() => map.invalidateSize(), 600);
</script>
</body>
</html>
