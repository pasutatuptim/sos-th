<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ SOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body,html{margin:0;padding:0;height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}
        .header{position:fixed;top:0;left:0;right:0;height:68px;background:#111;border-bottom:5px solid #c41e3a;z-index:1000;display:flex;align-items:center;justify-content:center}
        .header h1{font-size:1.95rem;color:#c41e3a;font-weight:800}
        .sidebar{position:fixed;top:68px;left:0;bottom:0;width:500px;background:rgba(8,12,28,0.98);backdrop-filter:blur(16px);z-index:999;overflow-y:auto;padding:24px;border-right:4px solid #c41e3a}
        .item{background:rgba(255,255,255,0.09);border-radius:16px;padding:24px;margin-bottom:20px;cursor:pointer;position:relative;transition:all .3s;box-shadow:0 8px 25px rgba(0,0,0,.7);border-left:8px solid transparent}
        .item:hover{transform:translateY(-6px);background:rgba(255,255,255,0.16)}
        .item.pending{border-left-color:#e74c3c}.item.going{border-left-color:#2980b9}.item.acknowledged{border-left-color:#e67e22}.item.completed{border-left-color:#27ae60}
        .pri-badge{position:absolute;top:16px;right:16px;background:#c41e3a;color:#fff;padding:10px 20px;border-radius:30px;font-weight:bold}
        .status-dot{width:22px;height:22px;border-radius:50%;display:inline-block;margin-right:12px;border:4px solid #fff}
        .timestamp-line{margin:12px 0;padding:10px;background:rgba(255,215,0,0.2);border-radius:10px;border-left:4px solid gold;font-weight:bold}
        .status-btn{background:#c41e3a;color:#fff;padding:14px;border:none;border-radius:12px;font-weight:bold;width:100%;margin-top:16px;cursor:pointer}
        .status-btn:hover{background:#e74c3c}
        .zoom-hint{margin-top:12px;padding-top:12px;border-top:1px dashed #555;color:#bbb;text-align:center;font-size:0.95rem}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(220,38,38,.9)}70%{box-shadow:0 0 0 28px transparent}100%{box-shadow:0 0 0 0 transparent}}
        .dot{width:20px;height:20px;border-radius:50%;border:4px solid #fff;background:#e74c3c;box-shadow:0 3px 14px rgba(0,0,0,.9)}
        .dot.new{animation:pulse 1.8s infinite}
        .loading{text-align:center;padding:50px;font-size:1.5rem;color:#c41e3a}
    </style>
</head>
<body>
<div class="header"><h1>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢</h1></div>
<div class="sidebar">
    <h2 style="color:#c41e3a;text-align:center;margin-bottom:24px;font-size:1.9rem">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
    <div id="list"><div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([13.94678, 100.56125], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markers = {}, cards = {}, list = document.getElementById('list'), notified = new Set();

    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) - ‡πÅ‡∏ó‡∏ô Firebase
    const TEST_DATA = {
        "-Of2YAoyi4WBPwZDI15_": {
            "location": {"lat": 13.946758, "lng": 100.5612429},
            "name": "‡∏õ‡∏™‡∏∏‡∏ï‡∏≤ ‡∏ó‡∏±‡∏ö‡∏ó‡∏¥‡∏°",
            "priority": 3,
            "status": "pending",
            "timestamp": Date.now() - 1200000, // 20 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
            "types": ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥", "‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà", "‡∏°‡∏µ‡πÄ‡∏î‡πá‡∏Å", "‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏"]
        }
    };

    function formatTime(ts) {
        const diff = Date.now() - ts;
        if (diff < 60000) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
        if (diff < 3600000) return `${Math.floor(diff/60000)} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
        return new Date(ts).toLocaleString('th-TH', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
    }

    function getColor(r) {
        if (r.priority >= 5) return '#c41e3a';
        if (r.status === 'completed') return '#27ae60';
        if (r.status === 'going') return '#2980b9';
        return '#e74c3c';
    }

    function getTypeText(types) {
        const map = {'‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥':'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£+‡∏ô‡πâ‡∏≥','‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà':'‡∏ï‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà','‡∏°‡∏µ‡πÄ‡∏î‡πá‡∏Å':'‡∏°‡∏µ‡πÄ‡∏î‡πá‡∏Å','‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏':'‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏'};
        return types.map(t => map[t] || t).join(' ‚Ä¢ ');
    }

    async function load() {
        list.innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
        
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô (‡πÅ‡∏ó‡∏ô Firebase)
        const data = TEST_DATA;
        
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏•‡∏≠‡∏á Firebase ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ Rules ‡πÅ‡∏•‡πâ‡∏ß) ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ:
        // try {
        //     const res = await fetch('https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests.json');
        //     if (res.ok) data = await res.json();
        // } catch(e) {
        //     console.log('‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô');
        // }

        if (Object.keys(data).length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:50px;color:#666">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            return;
        }

        list.innerHTML = '';
        const newIds = new Set();

        Object.entries(data).forEach(([id, r]) => {
            if (!r.location?.lat) return;

            if (r.status === 'pending' && !notified.has(id)) {
                notified.add(id);
                newIds.add(id);
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-emergency-alert-long-1004.mp3').play().catch(()=>{});
            }

            const color = getColor(r);
            const isNew = newIds.has(id);

            const div = document.createElement('div');
            div.className = `item ${r.status || 'pending'}`;
            div.innerHTML = `
                <div class="pri-badge">P${r.priority || '?'}</div>
                <strong><span class="status-dot" style="background:${color}"></span> ${r.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</strong>
                <div style="margin:8px 0">‡πÇ‡∏ó‡∏£: <span style="color:#0ff;font-weight:bold">${r.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span></div>
                <div style="margin:8px 0"><strong>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</strong> ${getTypeText(r.types)}</div>
                <div class="timestamp-line">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatTime(r.timestamp)}</div>
                <div class="zoom-hint">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                <button class="status-btn">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
            `;

            div.onclick = e => {
                if (e.target.classList.contains('status-btn')) return;
                map.setView([r.location.lat, r.location.lng], 18);
                markers[id]?.openPopup();
            };
            
            div.querySelector('.status-btn').onclick = e => {
                e.stopPropagation();
                alert('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô" ‡πÉ‡∏ô popup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
            };

            list.appendChild(div);
            cards[id] = div;

            const icon = L.divIcon({
                html: `<div class="dot${isNew?' new':''}" style="background:${color}"></div>`,
                iconSize: [20,20], iconAnchor: [10,10]
            });

            if (!markers[id]) {
                markers[id] = L.marker([r.location.lat, r.location.lng], {icon}).addTo(map);
            } else {
                markers[id].setLatLng([r.location.lat, r.location.lng]).setIcon(icon);
            }

            markers[id].bindPopup(`
                <div style="font-family:Sarabun;padding:16px;min-width:300px">
                    <b style="font-size:1.8rem">${r.name}</b><br>
                    <div style="margin:12px 0;padding:12px;background:#222;border-radius:10px;color:#ffdd00">
                        ${getTypeText(r.types)}
                    </div>
                    <div class="timestamp-line">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatTime(r.timestamp)}</div>
                    <button onclick="window.open('https://maps.google.com/maps/dir/?api=1&destination=${r.location.lat},${r.location.lng}')"
                        style="margin-top:12px;background:#c41e3a;color:#fff;padding:16px;width:100%;border:none;border-radius:12px;font-weight:bold">
                        üö® ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô
                    </button>
                </div>
            `);

            if (isNew) {
                map.setView([r.location.lat, r.location.lng], 18);
                setTimeout(() => markers[id].openPopup(), 800);
            }
        });

        if (Object.keys(markers).length > 0 && !map._loaded) {
            setTimeout(() => map.fitBounds(L.featureGroup(Object.values(markers)).getBounds().pad(0.5)), 1000);
        }
    }

    load();
    setInterval(load, 10000);
    setTimeout(() => map.invalidateSize(), 500);
</script>
</body>
</html>
