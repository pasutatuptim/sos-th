<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#c62828">
  <title>แจ้งเหตุด่วน</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#c62828;color:#fff;font-family:-apple-system,system-ui,sans-serif;min-height:100dvh;display:flex;flex-direction:column;overflow:hidden}
    .header{text-align:center;padding:2.8rem 1.5rem 2rem;background:rgba(0,0,0,0.25);border-radius:0 0 30px 30px}
    .header h1{font-size:2.8rem;font-weight:900}
    .header p{font-size:1.35rem;margin-top:8px;opacity:0.95}

    #gpsBtn{margin:1.5rem 2rem;padding:1.8rem;background:#ffeb3b;color:#c62828;border-radius:30px;font-size:1.8rem;font-weight:900;text-align:center;box-shadow:0 12px 30px rgba(0,0,0,0.5);cursor:pointer;animation:pulse-y 2s infinite}
    @keyframes pulse-y{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}

    .info{margin:1rem 1.5rem 0;padding:1.5rem;background:rgba(255,255,255,0.18);border-radius:25px;border:4px dashed rgba(255,255,255,0.4);text-align:center}
    .info p{font-size:1.25rem;margin-bottom:1rem;color:#ffeeee}
    input,textarea{width:100%;padding:16px;margin:10px 0;border:none;border-radius:16px;font-size:1.25rem;background:rgba(255,255,255,0.22);color:#fff}
    input::placeholder,textarea::placeholder{color:#ffaaaa}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:16px;flex:1;overflow-y:auto}
    .btn{background:rgba(255,255,255,0.28);border:8px solid #fff;border-radius:32px;padding:28px 12px;font-size:1.35rem;font-weight:900;text-align:center;box-shadow:0 12px 30px rgba(0,0,0,0.5);transition:all 0.25s;cursor:pointer}
    .btn i{font-size:3.8rem;margin-bottom:12px;display:block}
    .btn:active{transform:scale(0.94)}
    .btn.selected{background:#fff;color:#c62828;box-shadow:0 0 60px rgba(255,255,255,0.9);transform:scale(0.97)}

    #send{margin:2rem 2rem 3rem;padding:32px;background:#4caf50;color:#fff;font-size:3.8rem;font-weight:900;text-align:center;border-radius:40px;box-shadow:0 20px 50px rgba(0,0,0,0.7);animation:pulse 2s infinite;cursor:pointer}
    #send.disabled{background:#666;color:#333;animation:none;opacity:0.6;cursor:not-allowed}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

    /* หน้า สำเร็จ – เต็มจอ สวยสุดในไทย */
    #success{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,#1b5e20,#2e7d32);
      display:none;flex-direction:column;align-items:center;justify-content:center;
      z-index:99999;color:#fff;text-align:center;
      animation:fadeIn 0.8s ease-out;
    }
    #success.show{display:flex}
    @keyframes fadeIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
    
    #success i{
      font-size:18rem;color:#4caf50;margin-bottom:3rem;
      animation:checkBounce 2s infinite;
    }
    @keyframes checkBounce{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-30px)}
    }
    
    #success h2{
      font-size:6rem;font-weight:900;margin:1rem 2rem;line-height:1.2;
      text-shadow:0 10px 30px rgba(0,0,0,0.8);
    }
    #success p{
      font-size:2.8rem;margin:2rem 3rem 4rem;opacity:0.95;
    }
    #success button{
      background:#fff;color:#1b5e20;padding:1.8rem 4rem;
      border:none;border-radius:50px;font-size:2.2rem;font-weight:900;
      box-shadow:0 15px 40px rgba(0,0,0,0.6);cursor:pointer;
      transition:0.3s;
    }
    #success button:active{transform:scale(0.92)}
  </style>
</head>
<body>

  <div class="header">
    <h1>แจ้งเหตุด่วน</h1>
    <p>กดปุ่มเหลืองเพื่อเปิดตำแหน่ง</p>
  </div>

  <div id="gpsBtn">
    <i class="fas fa-location-arrow"></i><br>
    กดเพื่อเปิดตำแหน่ง
  </div>

  <div class="info">
    <p>หรือใส่เบอร์โทรก็แจ้งได้ทันที</p>
    <input type="text" id="name" placeholder="ชื่อ-นามสกุล (ไม่บังคับ)">
    <input type="tel" id="phone" placeholder="เบอร์โทรศัพท์">
    <textarea id="note" rows="2" placeholder="รายละเอียดเพิ่มเติม"></textarea>
  </div>

  <div class="grid">
    <div class="btn" data-type="อาหารและน้ำ"><i class="fas fa-utensils"></i>อาหาร/น้ำ</div>
    <div class="btn" data-type="ติดอยู่ในพื้นที่"><i class="fas fa-person-walking-arrow-right"></i>ติดอยู่ในพื้นที่</div>
    <div class="btn" data-type="กำลังจมน้ำ"><i class="fas fa-water"></i>กำลังจมน้ำ</div>
    <div class="btn" data-type="เจ็บป่วย"><i class="fas fa-heartbeat"></i>เจ็บป่วย</div>
    <div class="btn" data-type="มีเด็ก"><i class="fas fa-baby"></i>มีเด็ก</div>
    <div class="btn" data-type="มีผู้สูงอายุ"><i class="fas fa-user"></i>มีผู้สูงอายุ</div>
    <div class="btn" data-type="สัตว์เลี้ยง"><i class="fas fa-dog"></i>สัตว์เลี้ยง</div>
    <div class="btn" data-type="มีผู้เสียชีวิต"><i class="fas fa-cross"></i>มีผู้เสียชีวิต</div>
  </div>

  <div id="send" class="disabled">แจ้งเหตุ</div>

  <!-- หน้า สำเร็จ – เต็มจอ สวยมาก -->
  <div id="success">
    <i class="fas fa-check-circle"></i>
    <h2>แจ้งสำเร็จแล้ว!</h2>
    <p>ทีมกู้ภัยกำลังเดินทางไปช่วยเหลือคุณทันที</p>
    <button onclick="location.reload()">กลับหน้าหลัก</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script>
    firebase.initializeApp({ databaseURL: "https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app" });
    const db = firebase.database();

    const gpsBtn = document.getElementById('gpsBtn');
    const send = document.getElementById('send');
    const phone = document.getElementById('phone');
    const success = document.getElementById('success');
    let pos = null;
    let types = [];

    gps.onclick = () => {
      gps.innerHTML = '<i class="fas fa-spinner fa-spin"></i><br>กำลังขอตำแหน่ง...';
      navigator.geolocation.getCurrentPosition(
        p => {
          pos = {lat:p.coords.latitude, lng:p.coords.longitude};
          gps.innerHTML = '<i class="fas fa-check-circle"></i><br>ตำแหน่งพร้อมแล้ว!';
          gps.style.background = '#4caf50'; gps.style.color = '#fff';
          check();
        },
        () => {
          gps.innerHTML = '<i class="fas fa-location-arrow"></i><br>กดอีกครั้งเพื่อเปิดตำแหน่ง';
          alert("กรุณากด \"อนุญาต\" เมื่อ Safari ถามตำแหน่ง");
        },
        {enableHighAccuracy:true, timeout:15000}
      );
    };

    document.querySelectorAll('.btn').forEach(b => b.onclick = () => {
      b.classList.toggle('selected');
      types = Array.from(document.querySelectorAll('.btn.selected')).map(x=>x.dataset.type);
    });

    function check(){ send.classList.toggle('disabled', !(pos || phone.value.trim().length>=9)); }
    phone.addEventListener('input', check);

    send.onclick = () => {
      if(send.classList.contains('disabled')) return;

      const data = {
        types: types.length ? types : ["ขอความช่วยเหลือด่วน"],
        priority: types.includes("มีผู้เสียชีวิต")||types.includes("กำลังจมน้ำ") ? 5 :
                  types.includes("เจ็บป่วย") ? 4 : 3,
        timestamp: Date.now(),
        status: "pending"
      };
      if(pos){ data.location = pos; data.address = "พิกัดจากโทรศัพท์"; }
      if(document.getElementById('name').value.trim()) data.name = document.getElementById('name').value.trim();
      if(phone.value.trim()) data.phone = phone.value.trim();
      if(document.getElementById('note').value.trim()) data.note = document.getElementById('note').value.trim();

      db.ref("sos_requests").push(data);
      
      // เสียง + สั่น + หน้าเต็มจอ
      success.classList.add('show');
      if('vibrate' in navigator) navigator.vibrate([800,400,800,400,1200]);
      const audio = new Audio('https://cdn.jsdelivr.net/gh/tonlove/sos-sound/success.mp3');
      audio.play().catch(()=>{}); // เล่นเสียงสำเร็จ
    };
  </script>
</body>
</html>

