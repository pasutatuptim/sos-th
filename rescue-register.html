<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนทีมกู้ภัย</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sarabun Font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Custom red shadow for the card */
        .card-shadow {
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3); /* Based on tailwind's red-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

<div class="container max-w-md mx-auto bg-gray-800 p-8 rounded-3xl card-shadow w-full">
    <h1 class="text-3xl font-bold text-red-500 text-center mb-8">ลงทะเบียนทีมกู้ภัย</h1>

    <!-- Registration Form -->
    <div id="registration-form">
        <input type="text" id="teamName" placeholder="ชื่อทีม / ชื่อหน่วย (เช่น ทีมเรือเร็ว 1)" required
               class="w-full p-4 my-3 rounded-xl border border-gray-700 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500 text-lg">
        
        <input type="tel" id="phone" placeholder="เบอร์โทร (เช่น 0812345678)"
               class="w-full p-4 my-3 rounded-xl border border-gray-700 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500 text-lg">
        
        <select id="vehicle"
                class="w-full p-4 my-3 rounded-xl border border-gray-700 bg-gray-700 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-red-500 text-lg">
            <option value="รถยนต์">รถยนต์กู้ภัย</option>
            <option value="เรือ">เรือช่วยเหลือ</option>
            <option value="รถพยาบาล">รถพยาบาล</option>
            <option value="ดับเพลิง">รถดับเพลิง</option>
            <option value="อาสาสมัคร">อาสาสมัครเดินเท้า</option>
        </select>
        
        <button id="registerButton" onclick="registerTeam()"
                class="w-full p-4 my-3 rounded-xl bg-red-600 text-white font-extrabold cursor-pointer transition duration-300 transform hover:bg-red-700 hover:scale-[1.02] text-xl uppercase tracking-wider shadow-lg shadow-red-600/50">
            เริ่มส่งตำแหน่งเรียลไทม์
        </button>
    </div>

    <!-- Status Message Display -->
    <div id="status" class="mt-6 p-4 rounded-xl text-center font-bold transition-all duration-300 hidden">
        กำลังเชื่อมต่อ...
    </div>

    <!-- Optional: Display User ID for debugging/sharing in collaborative environment -->
    <div class="mt-6 pt-4 border-t border-gray-700 text-sm text-gray-500 text-center">
        รหัสผู้ใช้ (User ID): <span id="displayUserId" class="font-mono text-gray-400">...</span>
    </div>
</div>

<script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, getDoc, collection, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global Firebase variables
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;

    // --- Global Canvas Variables (Mandatory Use) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firestore paths
    const RESCUE_TEAMS_COLLECTION_PATH = `artifacts/${appId}/public/data/rescue_teams`;

    // Geolocation Watcher ID
    let watchId = null;

    // DOM Elements
    const statusEl = document.getElementById("status");
    const registerButton = document.getElementById("registerButton");
    const teamNameInput = document.getElementById("teamName");
    const phoneInput = document.getElementById("phone");
    const vehicleSelect = document.getElementById("vehicle");
    const displayUserIdEl = document.getElementById("displayUserId");

    // --- Utility Functions ---

    /**
     * @param {string} message 
     * @param {'success' | 'error' | 'loading'} type 
     */
    function showStatus(message, type = 'loading') {
        statusEl.textContent = message;
        statusEl.classList.remove('hidden', 'bg-red-600', 'bg-green-600', 'bg-blue-600');
        
        let bgColor;
        if (type === 'success') {
            bgColor = 'bg-green-600';
        } else if (type === 'error') {
            bgColor = 'bg-red-600';
        } else {
            bgColor = 'bg-blue-600'; // Using blue for loading/info
        }
        statusEl.classList.add(bgColor);
    }
    
    // --- Firebase Initialization and Auth ---

    /**
     * Initializes Firebase and authenticates the user.
     */
    async function initFirebase() {
        // เพิ่ม Logging เพื่อตรวจสอบ Config ที่ได้รับ
        console.log("Canvas App ID:", appId);
        console.log("Raw __firebase_config:", typeof __firebase_config !== 'undefined' ? __firebase_config : 'undefined');
        console.log("Parsed firebaseConfig:", firebaseConfig);

        try {
            // **การตรวจสอบและตั้งค่า Firebase**
            // ถ้า firebaseConfig ว่างเปล่าหรือไม่มี Project ID, จะโยนข้อผิดพลาดเพื่อให้เข้าสู่ catch block
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                console.error("Firebase config is missing, empty, or lacks Project ID.");
                // โยนข้อผิดพลาดที่กำหนดเองเพื่อระบุว่าเป็นปัญหาจาก Canvas Config
                throw new Error("Canvas environment did not provide a valid Firebase configuration.");
            }

            // 1. Initialize App and Services
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Enable Firestore logging

            // 2. Set Auth State Persistence
            await setPersistence(auth, browserSessionPersistence);
            
            // 3. Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    displayUserIdEl.textContent = userId;
                    console.log("Authenticated with user ID:", userId);
                    await loadTeamData(userId);
                } else {
                    // Try to sign in
                    await handleSignIn();
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            
            // ตรวจสอบข้อผิดพลาดที่โยนออกมาเพื่อแสดงข้อความที่เหมาะสมที่สุด
            const errorMessage = error.message.includes("valid Firebase configuration") 
                ? "เกิดข้อผิดพลาด: การตั้งค่า Firebase ไม่ถูกต้อง (โปรดตรวจสอบ Canvas Config)"
                : "เกิดข้อผิดพลาดในการเริ่มต้นระบบ: " + error.message;

            showStatus(errorMessage, 'error');
            registerButton.disabled = true;
        }
    }

    /**
     * Handles sign-in logic (Custom Token if available, otherwise Anonymous).
     */
    async function handleSignIn() {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Sign-in failed:", error);
            showStatus("ไม่สามารถเข้าสู่ระบบ: " + error.message, 'error');
            registerButton.disabled = true;
        }
    }

    // --- Firestore Data Operations ---

    /**
     * Loads existing team data for the current user.
     * @param {string} docId The document ID (which is the userId)
     */
    async function loadTeamData(docId) {
        try {
            const teamDocRef = doc(db, RESCUE_TEAMS_COLLECTION_PATH, docId);
            const teamDoc = await getDoc(teamDocRef);

            if (teamDoc.exists()) {
                const data = teamDoc.data();
                teamNameInput.value = data.name || "";
                phoneInput.value = data.phone || "";
                vehicleSelect.value = data.vehicle || "รถยนต์";
                
                showStatus("โหลดข้อมูลทีมเรียบร้อย – เริ่มส่งตำแหน่งได้เลย", 'success');
                // Auto-start location tracking if data exists
                registerTeam(true); 
            } else {
                showStatus("กรุณากรอกข้อมูลทีมเพื่อเริ่มต้น", 'loading');
            }
        } catch (error) {
            console.error("Error loading team data:", error);
            showStatus("เกิดข้อผิดพลาดในการโหลดข้อมูล: " + error.message, 'error');
        }
    }

    /**
     * Updates the location in Firestore.
     * @param {GeolocationPosition} position 
     */
    async function updateLocation(position) {
        if (!userId || !db) {
            console.warn("Cannot update location: User not authenticated or Firestore not ready.");
            return;
        }

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const speed = position.coords.speed ? (position.coords.speed * 3.6) : 0; // Convert m/s to km/h

        try {
            const teamDocRef = doc(db, RESCUE_TEAMS_COLLECTION_PATH, userId);
            
            // Only update the location and timestamp fields
            await updateDoc(teamDocRef, {
                lat: lat,
                lng: lng,
                speed: parseFloat(speed.toFixed(1)),
                timestamp: Date.now()
            });

            const teamName = teamNameInput.value.trim();
            showStatus(`กำลังส่งตำแหน่ง... (${lat.toFixed(4)}, ${lng.toFixed(4)}) ความเร็ว: ${speed.toFixed(1)} กม./ชม.`, 'loading');

        } catch (e) {
            console.error("Error updating location:", e);
            // Don't change status to error permanently, just log it.
        }
    }

    // --- Main Registration and Tracking Logic ---

    /**
     * Registers the team data and starts real-time location tracking.
     * @param {boolean} isInitialLoad If true, skips form validation.
     */
    window.registerTeam = async function(isInitialLoad = false) {
        if (!isAuthReady || !userId) {
            showStatus("กำลังเตรียมระบบ... กรุณารอสักครู่", 'loading');
            return;
        }

        const teamName = teamNameInput.value.trim();
        const phone = phoneInput.value.trim();
        const vehicle = vehicleSelect.value;

        if (!teamName) {
            showStatus("กรุณากรอกชื่อทีม/หน่วย", 'error');
            return;
        }
        
        showStatus("กำลังขอตำแหน่ง GPS...", 'loading');
        registerButton.disabled = true;

        if (navigator.geolocation) {
            // Function to handle location success and start watchPosition
            const startWatching = (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                const teamData = {
                    name: teamName,
                    phone: phone || null,
                    vehicle: vehicle,
                    lat: lat,
                    lng: lng,
                    timestamp: Date.now(),
                    active: true,
                    userId: userId, // Store userId for clarity
                    appId: appId
                };

                const saveTeamData = async () => {
                    try {
                        const teamDocRef = doc(db, RESCUE_TEAMS_COLLECTION_PATH, userId);
                        
                        // Use setDoc to create or fully replace the document
                        await setDoc(teamDocRef, teamData, { merge: true });

                        // Stop any previous watch
                        if (watchId) navigator.geolocation.clearWatch(watchId);

                        // Start continuous location update
                        watchId = navigator.geolocation.watchPosition(updateLocation, 
                            (error) => {
                                console.error("Geolocation watch error:", error);
                                showStatus("ไม่สามารถติดตามตำแหน่งได้", 'error');
                            }, 
                            { 
                                enableHighAccuracy: true, 
                                maximumAge: 0, 
                                timeout: 15000 
                            }
                        );

                        showStatus(`เชื่อมต่อแล้ว – กำลังส่งตำแหน่งเรียลไทม์ ชื่อทีม: ${teamName}`, 'success');
                        registerButton.disabled = false;
                        registerButton.textContent = "อัปเดตข้อมูลและส่งตำแหน่งต่อ";
                    } catch (e) {
                        console.error("Firestore save failed:", e);
                        showStatus("บันทึกข้อมูลไม่สำเร็จ: " + e.message, 'error');
                        registerButton.disabled = false;
                    }
                };

                saveTeamData();
            };

            // Function to handle location error
            const handleGeoError = (error) => {
                console.error("Geolocation error:", error);
                showStatus("กรุณาเปิด GPS และอนุญาตตำแหน่งเพื่อส่งตำแหน่ง", 'error');
                registerButton.disabled = false;
            };

            // Get initial position before starting the watch
            navigator.geolocation.getCurrentPosition(startWatching, handleGeoError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });

        } else {
            showStatus("เบราว์เซอร์นี้ไม่รองรับ Geolocation", 'error');
            registerButton.disabled = false;
        }
    }
    
    // --- Start the Application ---
    initFirebase();

</script>
</body>
</html>
