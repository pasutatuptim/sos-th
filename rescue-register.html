<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢‡πÅ‡∏•‡∏∞ Responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Font Sarabun */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

<div id="appContainer" class="w-full max-w-lg bg-gray-800 p-8 rounded-xl shadow-2xl border-t-4 border-amber-500">
    <h1 class="text-3xl font-bold text-center text-amber-500 mb-6">
        ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡∏°‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢
    </h1>
    <p id="userIdDisplay" class="text-sm text-center text-gray-400 mb-4">
        ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
    </p>

    <div class="space-y-4">
        <input type="text" id="teamName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° / ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡πá‡∏ß 1)" required
               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-amber-500 focus:ring-amber-500 text-lg">
        
        <input type="tel" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ø)"
               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-amber-500 focus:ring-amber-500 text-lg">
        
        <select id="vehicle" 
                class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-amber-500 focus:ring-amber-500 text-lg appearance-none">
            <option value="‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå">‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢</option>
            <option value="‡πÄ‡∏£‡∏∑‡∏≠">‡πÄ‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</option>
            <option value="‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•">‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
            <option value="‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á">‡∏£‡∏ñ‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á</option>
            <option value="‡∏≠‡∏≤‡∏™‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£">‡∏≠‡∏≤‡∏™‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤</option>
            <option value="‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô">‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô / ‡πÇ‡∏î‡∏£‡∏ô</option>
        </select>
        
        <button id="startButton" onclick="startReporting()" disabled
                class="w-full py-3 mt-4 text-xl font-bold rounded-lg transition duration-300 shadow-lg 
                       bg-amber-600 hover:bg-amber-500 text-gray-900 disabled:bg-gray-600 disabled:text-gray-400">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        </button>
    </div>

    <!-- ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
    <div id="statusContainer" class="mt-6">
        <div id="statusMessage" 
             class="p-4 rounded-lg text-center font-medium bg-gray-700 text-gray-300">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Log Level ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firestore
    setLogLevel('debug'); 

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≤‡∏Å Canvas Environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Firebase Services
    let db, auth, userId = null;
    let watchId = null;
    let isAuthReady = false;

    // Elements
    const statusMessageEl = document.getElementById('statusMessage');
    const userIdDisplayEl = document.getElementById('userIdDisplay');
    const teamNameEl = document.getElementById('teamName');
    const phoneEl = document.getElementById('phone');
    const vehicleEl = document.getElementById('vehicle');
    const startButtonEl = document.getElementById('startButton');

    // ----------------------------------------------------
    // 1. UTILITY FUNCTIONS
    // ----------------------------------------------------

    /**
     * ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏ô UI
     * @param {string} message - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á
     * @param {'success'|'error'|'waiting'|'info'} type - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
     */
    function showStatus(message, type = 'info') {
        const baseClass = "p-4 rounded-lg text-center font-medium";
        let colorClass;

        switch (type) {
            case 'success':
                colorClass = "bg-green-600 text-white";
                break;
            case 'error':
                colorClass = "bg-red-600 text-white";
                break;
            case 'waiting':
                colorClass = "bg-amber-500 text-gray-900 animate-pulse";
                break;
            case 'info':
            default:
                colorClass = "bg-gray-700 text-gray-300";
                break;
        }
        statusMessageEl.className = `${baseClass} ${colorClass}`;
        statusMessageEl.textContent = message;
    }

    /**
     * ‡∏î‡∏∂‡∏á Path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Document ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
     */
    function getTeamDocRef() {
        if (!userId) throw new Error("User ID is not set.");
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ Viewer ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
        const docPath = `/artifacts/${appId}/public/data/rescue_teams/${userId}`;
        return doc(db, docPath);
    }

    // ----------------------------------------------------
    // 2. FIREBASE & AUTH SETUP
    // ----------------------------------------------------

    async function initializeFirebase() {
        showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase...", 'waiting');
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // 2. ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Auth
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplayEl.textContent = `‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${userId}`;
                    startButtonEl.disabled = false;
                    loadExistingTeamData();
                } else {
                    showStatus("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", 'error');
                }
            });
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            showStatus(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Firebase: ${error.message}`, 'error');
        }
    }

    // ----------------------------------------------------
    // 3. DATA & LOCATION LOGIC
    // ----------------------------------------------------

    /**
     * ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ onSnapshot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
     */
    function loadExistingTeamData() {
        if (!isAuthReady || !userId) return;

        showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÄ‡∏î‡∏¥‡∏°...", 'info');
        const teamDocRef = getTeamDocRef();
        
        // ‡πÉ‡∏ä‡πâ onSnapshot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á Document ‡∏ô‡∏µ‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        onSnapshot(teamDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                teamNameEl.value = data.name || '';
                phoneEl.value = data.phone || '';
                vehicleEl.value = data.vehicle || '‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå';

                // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠
                if (data.active && data.lat && data.lng && !watchId) {
                    showStatus("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡πà‡∏≠...", 'waiting');
                    requestLocationAndStartWatch(true);
                } else if (data.active) {
                    showStatus("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠", 'info');
                }
            } else {
                showStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà", 'info');
            }
        }, (error) => {
            console.error("Error fetching team data:", error);
            showStatus("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°", 'error');
        });
    }

    /**
     * ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
     */
    window.startReporting = function() {
        if (!isAuthReady || !userId) {
            showStatus("‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠", 'waiting');
            return;
        }

        const teamName = teamNameEl.value.trim();
        if (!teamName) {
            showStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°", 'error');
            return;
        }

        // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        if (watchId) navigator.geolocation.clearWatch(watchId);
        requestLocationAndStartWatch(false);
    }

    /**
     * ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ watchPosition
     * @param {boolean} isInitialLoad - ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
     */
    function requestLocationAndStartWatch(isInitialLoad) {
        if (!navigator.geolocation) {
            showStatus("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation", 'error');
            return;
        }

        showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô... ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS", 'waiting');
        
        navigator.geolocation.getCurrentPosition((position) => {
            // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            const teamData = {
                name: teamNameEl.value.trim(),
                phone: phoneEl.value.trim() || null,
                vehicle: vehicleEl.value,
                active: true,
                lat: lat,
                lng: lng,
                timestamp: Date.now(),
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° metadata ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Viewer App ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
                metadata: {
                    appId: appId,
                    userId: userId,
                    createdAt: isInitialLoad ? undefined : Date.now() 
                }
            };

            // ‡πÉ‡∏ä‡πâ setDoc ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö Document ‡∏ó‡∏µ‡πà Path ‡πÄ‡∏â‡∏û‡∏≤‡∏∞
            setDoc(getTeamDocRef(), teamData, { merge: true })
                .then(() => {
                    // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
                    watchId = navigator.geolocation.watchPosition(updateLocation, handleLocationError, {
                        enableHighAccuracy: true,
                        maximumAge: 5000, // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏¥
                        timeout: 10000 
                    });
                    showStatus("üü¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÅ‡∏•‡πâ‡∏ß", 'success');
                })
                .catch(error => {
                    console.error("Error setting initial team data:", error);
                    showStatus("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°", 'error');
                });

        }, handleLocationError, { enableHighAccuracy: true, timeout: 10000 });
    }

    /**
     * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà
     */
    async function updateLocation(position) {
        if (!userId) return;

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) : 0; 
        
        const updateData = {
            lat: lat,
            lng: lng,
            speed: parseFloat(speed),
            timestamp: Date.now()
        };

        const MAX_RETRIES = 3;
        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                // ‡πÉ‡∏ä‡πâ updateDoc ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ field ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                await updateDoc(getTeamDocRef(), updateData);
                showStatus(`üü¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á: ${teamNameEl.value} | ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: ${speed} ‡∏Å‡∏°./‡∏ä‡∏°.`, 'success');
                return; 
            } catch (e) {
                console.error(`Update failed (Attempt ${i+1}):`, e);
                // Retry with exponential backoff
                if (i < MAX_RETRIES - 1) {
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    showStatus("‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", 'error');
                }
            }
        }
    }

    /**
     * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Geolocation
     */
    function handleLocationError(error) {
        console.error("Geolocation Error:", error);
        let message;
        switch (error.code) {
            case error.PERMISSION_DENIED:
                message = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (GPS)";
                break;
            case error.POSITION_UNAVAILABLE:
                message = "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                break;
            case error.TIMEOUT:
                message = "‡∏Ç‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS";
                break;
            default:
                message = "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
        }
        showStatus(`‚ùå ${message}`, 'error');
    }

    // ----------------------------------------------------
    // 4. STARTUP
    // ----------------------------------------------------
    initializeFirebase();
</script>
</body>
</html>
