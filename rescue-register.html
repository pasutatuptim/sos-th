<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนและรายงานตำแหน่ง</title>
    <!-- โหลด Tailwind CSS เพื่อการออกแบบที่ทันสมัยและ Responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ตั้งค่า Font Sarabun */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

<div id="appContainer" class="w-full max-w-lg bg-gray-800 p-8 rounded-xl shadow-2xl border-t-4 border-yellow-500">
    <h1 class="text-3xl font-bold text-center text-yellow-400 mb-6">
        ระบบลงทะเบียนและรายงานสถานะ
    </h1>
    <p id="userIdDisplay" class="text-sm text-center text-gray-400 mb-4 truncate">
        รหัสผู้ใช้งาน: กำลังเชื่อมต่อ...
    </p>

    <div class="space-y-4">
        <!-- Input fields with amber focus style -->
        <input type="text" id="teamName" placeholder="ชื่อทีม / ชื่อหน่วย (เช่น ทีมเรือเร็ว 1)" required
               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:ring-yellow-500 text-lg">
        
        <input type="tel" id="phone" placeholder="เบอร์โทรติดต่อ (สำหรับศูนย์ฯ)"
               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:ring-yellow-500 text-lg">
        
        <select id="vehicle" 
                class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 focus:ring-yellow-500 text-lg appearance-none">
            <option value="รถยนต์">รถยนต์กู้ภัย</option>
            <option value="เรือ">เรือช่วยเหลือ</option>
            <option value="รถพยาบาล">รถพยาบาล</option>
            <option value="ดับเพลิง">รถดับเพลิง</option>
            <option value="อาสาสมัคร">อาสาสมัครเดินเท้า</option>
            <option value="อากาศยาน">อากาศยาน / โดรน</option>
        </select>
        
        <!-- Main action button with amber/yellow color -->
        <button id="startButton" onclick="startReporting()" disabled
                class="w-full py-3 mt-4 text-xl font-bold rounded-lg transition duration-300 shadow-lg 
                       bg-yellow-600 hover:bg-yellow-500 text-gray-900 disabled:bg-gray-600 disabled:text-gray-400">
            เริ่มส่งตำแหน่งเรียลไทม์
        </button>
    </div>

    <!-- แถบสถานะ/ข้อความแจ้งเตือน -->
    <div id="statusContainer" class="mt-6">
        <div id="statusMessage" 
             class="p-4 rounded-lg text-center font-medium bg-gray-700 text-gray-300">
            กำลังเตรียมระบบ...
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURATION SETUP (จัดการกับปัญหา projectId หากรันนอก Canvas) ---
    const MOCK_PROJECT_ID = "pasuta-sos-mock-2025";
    const MOCK_FIREBASE_CONFIG = {
        apiKey: "AIzaSy_MockAPIKey_12345",
        authDomain: `${MOCK_PROJECT_ID}.firebaseapp.com`,
        projectId: MOCK_PROJECT_ID,
        storageBucket: `${MOCK_PROJECT_ID}.appspot.com`,
        messagingSenderId: "1234567890",
        appId: "1:1234567890:web:mockedapp"
    };
    
    // ดึงค่า Global Variables
    const appId = typeof __app_id !== 'undefined' ? __app_id : MOCK_PROJECT_ID;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let firebaseConfig;
    try {
        firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : 'null');
        if (!firebaseConfig || !firebaseConfig.projectId) {
            // ใช้ Mock config หากไม่มี config ที่ถูกต้อง
            firebaseConfig = MOCK_FIREBASE_CONFIG;
        }
    } catch (e) {
        firebaseConfig = MOCK_FIREBASE_CONFIG;
    }
    // ----------------------------------------------------

    // ตัวแปร Firebase Services
    let db, auth, userId = null;
    let watchId = null;
    let isAuthReady = false;

    // Elements
    const statusMessageEl = document.getElementById('statusMessage');
    const userIdDisplayEl = document.getElementById('userIdDisplay');
    const teamNameEl = document.getElementById('teamName');
    const phoneEl = document.getElementById('phone');
    const vehicleEl = document.getElementById('vehicle');
    const startButtonEl = document.getElementById('startButton');

    // ----------------------------------------------------
    // 1. UTILITY FUNCTIONS
    // ----------------------------------------------------

    /**
     * แสดงข้อความสถานะบน UI และใช้โทนสีส้มเหลือง (ยกเว้น error)
     * @param {string} message - ข้อความที่ต้องการแสดง
     * @param {'success'|'error'|'waiting'|'info'} type - ประเภทสถานะ
     */
    function showStatus(message, type = 'info') {
        const baseClass = "p-4 rounded-lg text-center font-medium";
        let colorClass;

        switch (type) {
            case 'success':
                colorClass = "bg-yellow-500 text-gray-900"; // ส้มเหลืองสำหรับ Success
                break;
            case 'error':
                colorClass = "bg-red-700 text-white"; // แดงเข้มสำหรับ Error
                break;
            case 'waiting':
                colorClass = "bg-yellow-600 text-gray-900 animate-pulse";
                break;
            case 'info':
            default:
                colorClass = "bg-gray-700 text-gray-300";
                break;
        }
        statusMessageEl.className = `${baseClass} ${colorClass}`;
        statusMessageEl.textContent = message;
    }

    /**
     * ดึง Path สำหรับ Document ของทีมปัจจุบัน (Firestore)
     */
    function getTeamDocRef() {
        if (!userId) throw new Error("User ID is not set.");
        // บันทึกในคอลเลกชันสาธารณะเพื่อให้แอป Viewer อ่านได้
        const docPath = `/artifacts/${appId}/public/data/rescue_teams/${userId}`;
        return doc(db, docPath);
    }

    // ----------------------------------------------------
    // 2. FIREBASE & AUTH SETUP
    // ----------------------------------------------------

    async function initializeFirebase() {
        showStatus("กำลังเริ่มต้น Firebase...", 'waiting');
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // ตั้งค่า Log Level สำหรับ Firestore

            // 1. ลงชื่อเข้าใช้ (บังคับใช้ Auth)
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // 2. รอการตรวจสอบสถานะ Auth
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplayEl.textContent = `รหัสผู้ใช้งาน: ${userId}`;
                    startButtonEl.disabled = false;
                    loadExistingTeamData();
                } else {
                    showStatus("การเชื่อมต่อล้มเหลว: ไม่ได้รับรหัสผู้ใช้", 'error');
                }
            });
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            showStatus(`ข้อผิดพลาด Firebase: ${error.message}`, 'error');
        }
    }

    // ----------------------------------------------------
    // 3. DATA & LOCATION LOGIC
    // ----------------------------------------------------

    /**
     * โหลดข้อมูลทีมที่มีอยู่แล้ว และตั้งค่า onSnapshot เพื่ออัปเดต UI
     */
    function loadExistingTeamData() {
        if (!isAuthReady || !userId) return;

        showStatus("กำลังดึงข้อมูลทีมเดิม...", 'info');
        const teamDocRef = getTeamDocRef();
        
        // ใช้ onSnapshot เพื่อฟังการเปลี่ยนแปลงของ Document นี้แบบเรียลไทม์
        onSnapshot(teamDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                teamNameEl.value = data.name || '';
                phoneEl.value = data.phone || '';
                vehicleEl.value = data.vehicle || 'รถยนต์';

                // หากมีข้อมูลเดิมและกำลังส่งตำแหน่งอยู่ ให้เริ่มต้นติดตามต่อ
                if (data.active && data.lat && data.lng && !watchId) {
                    showStatus("พบข้อมูลเดิม กำลังเริ่มต้นติดตามตำแหน่งต่อ...", 'waiting');
                    requestLocationAndStartWatch(true);
                } else if (data.active) {
                    showStatus("ข้อมูลพร้อม กด 'เริ่มส่งตำแหน่ง' เพื่อรายงานต่อ", 'info');
                }
            } else {
                showStatus("กรุณากรอกข้อมูลเพื่อลงทะเบียนทีมใหม่", 'info');
            }
        }, (error) => {
            console.error("Error fetching team data:", error);
            showStatus("เกิดข้อผิดพลาดในการโหลดข้อมูลทีม", 'error');
        });
    }

    /**
     * เริ่มกระบวนการส่งตำแหน่ง
     */
    window.startReporting = function() {
        if (!isAuthReady || !userId) {
            showStatus("ระบบยังไม่พร้อม โปรดรอการเชื่อมต่อ", 'waiting');
            return;
        }

        const teamName = teamNameEl.value.trim();
        if (!teamName) {
            // ใช้ Modal/Status แทน alert()
            showStatus("กรุณากรอกชื่อทีม", 'error');
            return;
        }

        // หากมีการติดตามอยู่แล้ว ให้หยุดก่อนแล้วเริ่มใหม่
        if (watchId) navigator.geolocation.clearWatch(watchId);
        requestLocationAndStartWatch(false);
    }

    /**
     * ขอสิทธิ์ตำแหน่งและตั้งค่า watchPosition
     * @param {boolean} isInitialLoad - ใช้สำหรับโหลดข้อมูลเดิม
     */
    function requestLocationAndStartWatch(isInitialLoad) {
        if (!navigator.geolocation) {
            showStatus("เบราว์เซอร์ไม่รองรับ Geolocation", 'error');
            return;
        }

        showStatus("กำลังขอตำแหน่งปัจจุบัน... โปรดอนุญาต GPS", 'waiting');
        
        navigator.geolocation.getCurrentPosition((position) => {
            // สำเร็จในการรับตำแหน่งเริ่มต้น
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // 1. บันทึกข้อมูลทีมเริ่มต้น
            const teamData = {
                name: teamNameEl.value.trim(),
                phone: phoneEl.value.trim() || null,
                vehicle: vehicleEl.value,
                active: true,
                lat: lat,
                lng: lng,
                timestamp: Date.now(),
                metadata: {
                    appId: appId,
                    userId: userId,
                    createdAt: isInitialLoad ? undefined : Date.now() 
                }
            };

            // ใช้ setDoc เพื่อสร้างหรือเขียนทับ Document ที่ Path เฉพาะ
            setDoc(getTeamDocRef(), teamData, { merge: true })
                .then(() => {
                    // 2. เริ่มติดตามตำแหน่งอย่างต่อเนื่อง
                    watchId = navigator.geolocation.watchPosition(updateLocation, handleLocationError, {
                        enableHighAccuracy: true,
                        maximumAge: 5000, 
                        timeout: 10000 
                    });
                    showStatus("✅ เริ่มส่งตำแหน่งเรียลไทม์แล้ว", 'success');
                })
                .catch(error => {
                    console.error("Error setting initial team data:", error);
                    showStatus("❌ ข้อผิดพลาดในการบันทึกข้อมูลทีม", 'error');
                });

        }, handleLocationError, { enableHighAccuracy: true, timeout: 10000 });
    }

    /**
     * อัปเดตตำแหน่งอย่างต่อเนื่องเมื่อมีการเคลื่อนที่
     */
    async function updateLocation(position) {
        if (!userId) return;

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) : 0; 
        
        const updateData = {
            lat: lat,
            lng: lng,
            speed: parseFloat(speed),
            timestamp: Date.now()
        };

        const MAX_RETRIES = 3;
        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                // ใช้ updateDoc เพื่ออัปเดตเฉพาะ field ที่จำเป็น
                await updateDoc(getTeamDocRef(), updateData);
                showStatus(`✅ กำลังส่ง: ${teamNameEl.value} | ความเร็ว: ${speed} กม./ชม.`, 'success');
                return; 
            } catch (e) {
                // Retry with exponential backoff
                if (i < MAX_RETRIES - 1) {
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    showStatus("การอัปเดตตำแหน่งล้มเหลว", 'error');
                }
            }
        }
    }

    /**
     * จัดการข้อผิดพลาด Geolocation
     */
    function handleLocationError(error) {
        console.error("Geolocation Error:", error);
        let message;
        switch (error.code) {
            case error.PERMISSION_DENIED:
                message = "กรุณาอนุญาตให้เข้าถึงตำแหน่ง (GPS)";
                break;
            case error.POSITION_UNAVAILABLE:
                message = "ตำแหน่งไม่พร้อมใช้งาน โปรดลองอีกครั้ง";
                break;
            case error.TIMEOUT:
                message = "ขอตำแหน่งหมดเวลา โปรดตรวจสอบสัญญาณ GPS";
                break;
            default:
                message = "ข้อผิดพลาดที่ไม่ทราบสาเหตุในการขอตำแหน่ง";
        }
        showStatus(`❌ ${message}`, 'error');
    }

    // ----------------------------------------------------
    // 4. STARTUP
    // ----------------------------------------------------
    initializeFirebase();
</script>
</body>
</html>
