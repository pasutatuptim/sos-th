<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ส่งตำแหน่งทีมกู้ภัย (มือถือ)</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#c41e3a">
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\":\"ทีมกู้ภัย Realtime\",
        \"short_name\":\"กู้ภัยGPS\",
        \"start_url\":\".\",
        \"display\":\"standalone\",
        \"background_color\":\"#000\",
        \"theme_color\":\"#c41e3a\",
        \"icons\":[{\"src\":\"https://cdn-icons-png.flaticon.com/128/2993/2993671.png\",\"sizes\":\"192x192\",\"type\":\"image/png\"}]
    }">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        .container{
            height:100vh;
            display:flex;
            flex-direction:column;
            justify-content:space-between;
            padding:20px;
            background:linear-gradient(135deg,#1a0000,#000);
        }
        .top{
            text-align:center;
            padding-top:30px;
        }
        .logo{
            font-size:80px;
            animation:float 4s ease-in-out infinite;
        }
        @keyframes float{
            0%,100%{transform:translateY(0)}
            50%{transform:translateY(-20px)}
        }
        h1{font-size:1.8rem;margin:15px 0 8px;font-weight:800}
        .desc{font-size:1.1rem;opacity:0.9}
        .main{
            flex:1;
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            gap:25px;
        }
        .btn{
            width:90%;
            max-width:420px;
            padding:22px;
            font-size:1.5rem;
            font-weight:800;
            border:none;
            border-radius:20px;
            cursor:pointer;
            box-shadow:0 10px 30px rgba(0,0,0,0.6);
            transition:all 0.3s;
        }
        .btn:active{transform:scale(0.95)}
        .btn-start{background:#27ae60;}
        .btn-stop{background:#e74c3c;}
        .btn-start.disabled{background:#555;cursor:not-allowed}
        .status{
            padding:18px 25px;
            background:rgba(255,255,255,0.1);
            border-radius:15px;
            text-align:center;
            font-size:1.2rem;
            backdrop-filter:blur(10px);
            min-height:80px;
            width:90%;
            max-width:420px;
        }
        .status.success{background:rgba(39,174,96,0.3);border:2px solid #27ae60}
        .status.danger{background:rgba(231,76,60,0.3);border:2px solid #e74c3c}
        .accuracy{margin-top:8px;font-size:1rem;opacity:0.9}
        .team-id{
            position:fixed;
            top:15px;
            right:15px;
            background:rgba(0,0,0,0.7);
            padding:8px 15px;
            border-radius:12px;
            font-size:0.9rem;
            z-index:9999;
        }
    </style>
</head>
<body>

<div class="team-id" id="teamIdDisplay">รหัสทีม: โหลด...</div>

<div class="container">
    <div class="top">
        <div class="logo">กู้ภัย</div>
        <h1>ระบบส่งตำแหน่งเรียลไทม์</h1>
        <div class="desc">สำหรับทีมกู้ภัยน้ำท่วม เปิดทิ้งไว้ตลอดภารกิจ</div>
    </div>

    <div class="main">
        <div class="status" id="statusBox">
            กดปุ่มด้านล่างเพื่อเริ่มส่งตำแหน่ง<br><br>
            <span style="font-size:0.9rem;color:#aaa">ศูนย์บัญชาการจะเห็นคุณทันที</span>
        </div>

        <button class="btn btn-start" id="startBtn">เริ่มส่งตำแหน่ง</button>
        <button class="btn btn-stop" id="stopBtn" style="display:none">หยุดส่งตำแหน่ง</button>
    </div>

    <div style="text-align:center;padding-bottom:30px;opacity:0.7;font-size:0.9rem">
        เวอร์ชัน 2.0 • หน้าจอไม่ดับ • ใช้เน็ตน้อย
    </div>
</div>

<script>
    // ────────────────────────────── แก้แค่ตรงนี้ 4 บรรทัดเท่านั้น! ──────────────────────────────
    const TEAM_ID      = "boat09";           // เปลี่ยนเป็นรหัสทีมของคุณ (ไม่ซ้ำกัน)
    const TEAM_NAME    = "เรือกู้ภัย พระนคร 9"; // ชื่อทีมที่จะโชว์ในศูนย์บัญชาการ
    const VEHICLE      = "เรือยาวไฟเบอร์";      // เรือ, รถยกสูง, เฮลิคอปเตอร์, จิตอาสา ฯลฯ
    const PHONE        = "081-234-5678";          // ใส่หรือเว้นว่างก็ได้
    // ─────────────────────────────────────────────────────────────────────────────────────────────

    const DB = "https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/rescue_teams";

    document.getElementById('teamIdDisplay').textContent = `รหัส: ${TEAM_ID}`;

    const statusBox = document.getElementById('statusBox');
    const startBtn  = document.getElementById('startBtn');
    const stopBtn   = document.getElementById('stopBtn');
    let watchId = null;
    let sending = false;

    function updateStatus(text, type = '') {
        statusBox.innerHTML = text;
        statusBox.className = 'status ' + type;
    }

    function sendLocation(pos) {
        const data = {
            name: TEAM_NAME,
            vehicle: VEHICLE,
            phone: PHONE || null,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: Math.round(pos.coords.accuracy),
            speed: pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            active: true
        };

        fetch(`${DB}/${TEAM_ID}.json`, {
            method: 'PATCH',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(data)
        })
        .then(() => {
            const acc = Math.round(pos.coords.accuracy);
            updateStatus(
                `ส่งตำแหน่งสำเร็จ<br>ความแม่นยำ ±${acc} เมตร<br>อัปเดตล่าสุด ${new Date().toLocaleTimeString('th-TH')}`,
                'success'
            );
        })
        .catch(() => {
            updateStatus('ส่งไม่สำเร็จ – ไม่มีเน็ต?', 'danger');
        });
    }

    function startSending() {
        if (!navigator.geolocation) {
            updateStatus('อุปกรณ์ไม่รองรับ GPS', 'danger');
            return;
        }

        updateStatus('กำลังขอตำแหน่ง... รอสักครู่', 'success');
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';

        watchId = navigator.geolocation.watchPosition(
            pos => {
                if (pos.coords.accuracy > 100) {
                    updateStatus(`ความแม่นยำยังไม่ดี (±${Math.round(pos.coords.accuracy)}ม)<br>รอสัญญาณดีขึ้น...`, 'danger');
                }
                sendLocation(pos);
            },
            err => {
                updateStatus('ไม่สามารถหาตำแหน่งได้<br>' + err.message, 'danger');
            },
            {
                enableHighAccuracy: true,
                maximumAge: 5000,
                timeout: 15000
            }
        );

        sending = true;
    }

    function stopSending() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        fetch(`${DB}/${TEAM_ID}/active.json`, {
            method: 'PATCH',
            body: JSON.stringify(false)
        });
        updateStatus('หยุดส่งตำแหน่งแล้ว', 'danger');
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        sending = false;
    }

    startBtn.onclick = startSending;
    stopBtn.onclick = stopSending;

    // ป้องกันหน้าจอปิด (สำคัญมาก!)
    let wakeLock = null;
    const requestWakeLock = async () => {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
        } catch (e) {}
    };
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) requestWakeLock();
    });
    requestWakeLock();

    // ถ้ามี GPS ดีตั้งแต่แรก ให้เริ่มอัตโนมัติเลย (สะดวกสุด)
    setTimeout(() => {
        if ('geolocation' in navigator && !sending) {
            updateStatus('กำลังเริ่มอัตโนมัติ...', 'success');
            startSending();
        }
    }, 2000);
</script>

</body>
</html>
