<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ส่งตำแหน่งทีมกู้ภัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body,html { margin:0; padding:0; height:100%; background:linear-gradient(135deg, #0f0c29, #302b63, #24243e); font-family:'Sarabun',sans-serif; color:#fff; }
        .container {
            min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
        }
        .card {
            background:rgba(20,20,40,0.95); width:100%; max-width:420px; border-radius:28px; overflow:hidden;
            box-shadow:0 20px 60px rgba(0,0,0,0.8), 0 0 80px rgba(255,179,0,0.3);
            border:4px solid #ffb300; backdrop-filter:blur(10px);
        }
        .header {
            background:linear-gradient(45deg, #c41e3a, #e74c3c); padding:30px 20px; text-align:center;
        }
        .header h1 { margin:0; font-size:2.8rem; font-weight:800; text-shadow:0 4px 10px rgba(0,0,0,0.6); }
        .header p { margin:10px 0 0; font-size:1.3rem; opacity:0.9; }

        .form {
            padding:30px 35px 40px;
        }
        label {
            display:block; margin:18px 0 8px; font-size:1.3rem; font-weight:700; color:#ffb300;
        }
        input, select {
            width:100%; padding:18px 20px; border:none; border-radius:18px; background:#222;
            color:#fff; font-size:1.4rem; font-weight:600; outline:none; transition:0.3s;
            box-shadow:inset 0 4px 10px rgba(0,0,0,0.4);
        }
        input:focus, select:focus {
            background:#333; box-shadow:0 0 20px rgba(255,179,0,0.5), inset 0 4px 10px rgba(0,0,0,0.4);
            transform:scale(1.02);
        }

        .btn {
            width:100%; padding:20px; margin-top:30px; border:none; border-radius:20px;
            font-size:1.6rem; font-weight:800; cursor:pointer; transition:0.3s;
        }
        .btn-start {
            background:#27ae60; color:white; box-shadow:0 10px 30px rgba(39,174,96,0.5);
        }
        .btn-start:active { transform:scale(0.95); }
        .btn-stop {
            background:#e74c3c; color:white; display:none; margin-top:15px;
            box-shadow:0 10px 30px rgba(231,76,60,0.5);
        }

        #status {
            margin-top:25px; text-align:center; font-size:1.8rem; font-weight:800;
            padding:15px; border-radius:15px; background:rgba(0,0,0,0.4);
        }
        .online { color:#27ae60; }
        .offline { color:#e74c3c; }
        .loading { color:#ffb300; animation:blink 1.5s infinite; }
        @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.5} }

        .icon { font-size:3rem; margin-bottom:10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header">
            <h1>ทีมกู้ภัย</h1>
            <p>กรอกรายละเอียดแล้วเริ่มส่งตำแหน่งทันที</p>
        </div>

        <div class="form">
            <label for="teamName">ชื่อทีมกู้ภัย</label>
            <input type="text" id="teamName" placeholder="เช่น ทีมเรือราชประชา 1" required>

            <label for="vehicle">ประเภทยานพาหนะ</label>
            <select id="vehicle" required>
                <option value="">เลือกยานพาหนะ</option>
                <option value="เรือ">เรือ</option>
                <option value="รถยกสูง">รถยกสูง 6 ล้อ</option>
                <option value="เจ็ทสกี">เจ็ทสกี</option>
                <option value="เฮลิคอปเตอร์">เฮลิคอปเตอร์</option>
                <option value="ทีมเดินเท้า">ทีมเดินเท้า / อาสาสมัคร</option>
            </select>

            <label for="phone">เบอร์โทรศัพท์ (ไม่บังคับ)</label>
            <input type="tel" id="phone" placeholder="เช่น 081-234-5678">

            <button class="btn btn-start" onclick="startSending()">เริ่มส่งตำแหน่งทันที</button>
            <button class="btn btn-stop" id="stopBtn" onclick="stopSending()">หยุดส่งตำแหน่ง</button>

            <div id="status" class="offline">ยังไม่ได้เริ่มส่งตำแหน่ง</div>
        </div>
    </div>
</div>

<script>
    const DB_URL = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/rescue_teams';
    let teamId = null;
    let interval = null;

    function startSending() {
        const name = document.getElementById('teamName').value.trim();
        const vehicle = document.getElementById('vehicle').value;
        if (!name || !vehicle) return alert('กรุณากรอกชื่อทีมและเลือกยานพาหนะ');

        teamId = 'team_' + Date.now();

        document.querySelector('.btn-start').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';
        document.getElementById('status').textContent = 'กำลังเปิด GPS...';
        document.getElementById('status').className = 'loading';

        const send = () => {
            navigator.geolocation.getCurrentPosition(pos => {
                const {latitude, longitude, accuracy} = pos.coords;

                fetch(`${DB_URL}/${teamId}.json`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        vehicle: vehicle,
                        phone: document.getElementById('phone').value || '-',
                        lat: latitude,
                        lng: longitude,
                        accuracy: Math.round(accuracy),
                        updatedAt: Date.now(),
                        active: true
                    })
                });

                document.getElementById('status').innerHTML = `
                    <div class="icon">ส่งตำแหน่งเรียบร้อย!</div>
                    <div style="font-size:1.2rem;">อัปเดตล่าสุด ±${Math.round(accuracy)} เมตร</div>
                `;
                document.getElementById('status').className = 'online';

            }, () => {
                document.getElementById('status').textContent = 'หาตำแหน่งไม่ได้ กรุณาเปิด GPS';
                document.getElementById('status').className = 'offline';
            }, {
                enableHighAccuracy: true,
                timeout: 12000
            });
        };

        send();
        interval = setInterval(send, 30000); // ทุก 30 วินาที
    }

    function stopSending() {
        if (confirm('หยุดส่งตำแหน่งและหายจากระบบจริง ๆ นะ?')) {
            clearInterval(interval);
            if (teamId) fetch(`${DB_URL}/${teamId}.json`, {method: 'DELETE'});
            location.reload();
        }
    }

    window.onbeforeunload = () => teamId ? '' : null;
</script>
</body>
</html>
