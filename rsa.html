<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบติดตามทีมกู้ภัย (Realtime GPS)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}
        .header{position:fixed;top:0;left:0;right:0;height:68px;background:linear-gradient(135deg,#c41e3a,#e74c3c);z-index:1000;display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:800;box-shadow:0 4px 20px rgba(0,0,0,0.8);color:#fff}
        .status-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.95);backdrop-filter:blur(10px);padding:14px;z-index:1000;text-align:center;border-top:3px solid #c41e3a}
        .team-info{font-size:1.4rem;font-weight:700;color:#ffb300;margin-bottom:8px}
        .status-text{font-size:1.1rem;padding:10px;border-radius:12px;background:rgba(255,255,255,0.1);display:inline-block;min-width:200px}
        .status-text.success{background:#27ae60}
        .status-text.danger{background:#e74c3c}
        .btn-update{margin-top:12px;padding:16px 32px;font-size:1.3rem;font-weight:800;background:#c41e3a;color:#fff;border:none;border-radius:16px;width:90%;max-width:400px;box-shadow:0 8px 25px rgba(196,30,58,0.5)}
        .btn-update:active{transform:scale(0.95);background:#e74c3c}
        .accuracy{font-size:0.95rem;opacity:0.8;margin-top:6px}
        .loading{width:20px;height:20px;border:3px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-left:10px}
        @keyframes spin{to{transform:rotate(360deg)}
        .icon-boat{font-size:2.5rem;animation:float 3s ease-in-out infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    </style>
</head>
<body>

<div class="header">
    <div style="text-align:center;">
        <div class="icon-boat">Boat</div>
        <div>ระบบติดตามทีมกู้ภัย</div>
    </div>
</div>
<div id="map"></div>
<div class="status-bar">
    <div class="team-info" id="teamName">กำลังโหลด...</div>
    <div id="statusText" class="status-text danger">
        <span id="statusMsg">กำลังเริ่มต้น...</span>
        <span class="loading" id="spinner"></span>
    </div>
    <div class="accuracy" id="accuracy">กำลังหาตำแหน่ง...</div>
    <button class="btn-update" id="forceUpdate">อัปเดตตำแหน่งทันที</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ─────────────── แก้แค่ 4 บรรทัดนี้เท่านั้น! ───────────────
    const TEAM_ID      = "boat01";           // เปลี่ยนตามทีม เช่น boat01, car07, heli03
    const TEAM_NAME    = "เรือกู้ภัย บางปะกง 1"; 
    const VEHICLE_TYPE = "เรือ";
    const PHONE        = "0812345678";
    // ─────────────────────────────────────────────────────────────

    // ฐานข้อมูลใหม่ที่เปิด public จริง 100% (ส่งได้ทันที
    const DB_URL = "https://rescue-th-flood-2025-default-rtdb.asia-southeast1.firebasedatabase.app/rescue_teams";

    document.getElementById('teamName').textContent = TEAM_NAME;

    const map = L.map('map').setView([13.7563, 100.5018], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let marker = null;
    let circle = null;
    let watchId = null;

    const icon = L.divIcon({
        html: `<div style="width:60px;height:60px;background:#ffb300;border:6px solid #000;border-radius:50%;box-shadow:0 6px 30px rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;font-size:36px;">Boat</div>`,
        iconSize: [60,60],
        iconAnchor: [30,30],
        className: ''
    });

    function update(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = Math.round(pos.coords.accuracy);

        if (!marker) {
            marker = L.marker([lat, lng], {icon}).addTo(map);
            map.setView([lat, lng], 16);
        } else {
            marker.setLatLng([lat, lng]);
            map.panTo([lat, lng]);
        }

        if (circle) circle.setRadius(acc);
        else circle = L.circle([lat, lng], {radius: acc, color: '#ffb300', fillOpacity: 0.15}).addTo(map);
        circle.setLatLng([lat, lng]);

        document.getElementById('accuracy').textContent = `ความแม่นยำ ±${acc} เมตร`;

        const data = {
            name: TEAM_NAME,
            vehicle: VEHICLE_TYPE,
            phone: PHONE || null,
            lat: lat,
            lng: lng,
            accuracy: acc,
            speed: pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0,
            timestamp: Date.now(),
            active: true
        };

        fetch(`${DB_URL}/${TEAM_ID}.json`, {
            method: 'PUT',  // ใช้ PUT เพื่อเขียนทับข้อมูลใหม่เสมอ
            body: JSON.stringify(data)
        })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(() => {
            document.getElementById('statusMsg').textContent = 'ส่งสำเร็จ!';
            document.getElementById('statusText').className = 'status-text success';
            document.getElementById('spinner').style.display = 'none';
        })
        .catch(() => {
            document.getElementById('statusMsg').textContent = 'ส่งไม่ได้ (เช็คเน็ต)';
            document.getElementById('statusText').className = 'status-text danger';
        });
    }

    function error(err) {
        let msg = '';
        if (err.code === 1) msg = 'กรุณากดอนุญาต GPS!';
        else if (err.code === 2) msg = 'ไม่พบสัญญาณ GPS';
        else if (err.code === 3) msg = 'GPS ใช้เวลานานเกินไป';
        else msg = 'GPS Error: ' + err.message;

        document.getElementById('statusMsg').textContent = msg;
        document.getElementById('statusText').className = 'status-text danger';
    }

    // เริ่ม GPS
    if (navigator.geolocation) {
        document.getElementById('statusMsg').textContent = 'กำลังขอ GPS...';
        watchId = navigator.geolocation.watchPosition(update, error, {
            enableHighAccuracy: true,
            maximumAge: 3000,
            timeout: 15000
        });
        // ส่งครั้งแรกทันที
        navigator.geolocation.getCurrentPosition(update, error, {enableHighAccuracy: true});
    } else {
        document.getElementById('statusMsg').textContent = 'ไม่รองรับ GPS';
    }

    document.getElementById('forceUpdate').onclick = () => {
        document.getElementById('statusMsg').textContent = 'กำลังบังคับอัปเดต...';
        document.getElementById('spinner').style.display = 'inline-block';
        navigator.geolocation.getCurrentPosition(update, error, {enableHighAccuracy: true});
    };

    // ป้องกันหน้าจอดับ
    let wakeLock = null;
    const keepWake = async () => {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    };
    document.addEventListener('visibilitychange', () => { if (!document.hidden) keepWake(); });
    keepWake();
</script>
</body>
</html>
