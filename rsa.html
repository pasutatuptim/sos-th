<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ส่งตำแหน่งกู้ภัย – ทำงาน 100%</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        .box{
            height:100vh;display:flex;flex-direction:column;justify-content:space-between;
            padding:20px;background:linear-gradient(135deg,#000,#0d0d0d);
        }
        .logo{font-size:90px;text-align:center;margin-top:30px;animation:float 3s infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
        h1{font-size:1.8rem;text-align:center;margin:10px 0 5px;font-weight:800}
        .desc{font-size:1.1rem;text-align:center;opacity:0.8}
        .main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:30px}
        .status{
            padding:20px;border-radius:18px;background:rgba(255,255,255,0.1);
            text-align:center;font-size:1.3rem;width:90%;max-width:420px;
            backdrop-filter:blur(10px);border:2px solid transparent;
        }
        .status.ok{border-color:#27ae60;background:rgba(39,174,96,0.2)}
        .status.no{border-color:#e74c3c;background:rgba(231,76,60,0.2)}
        .btn{
            width:90%;max-width:420px;padding:24px;font-size:1.6rem;font-weight:800;
            border:none;border-radius:20px;color:#fff;cursor:pointer;
            box-shadow:0 12px 30px rgba(0,0,0,0.7);transition:0.3s;
        }
        .btn:active{transform:scale(0.95)}
        .start{background:#27ae60}
        .stop{background:#e74c3c;display:none}
        .team{display:fixed;top:10px;right:10px;background:rgba(0,0,0,0.7);padding:8px 16px;border-radius:12px;font-size:0.9rem}
    </style>
</head>
<body>

<div class="team" id="team">กำลังโหลด...</div>

<div class="box">
    <div>
        <div class="logo">กู้ภัย</div>
        <h1>ส่งตำแหน่งเรียลไทม์</h1>
        <div class="desc">สำหรับทีมกู้ภัยน้ำท่วม เปิดทิ้งไว้ตลอดภารกิจ</div>
    </div>

    <div class="main">
        <div class="status" id="msg">กดปุ่มเพื่อเริ่มส่งตำแหน่ง</div>
        <button class="btn start" id="start">เริ่มส่งตำแหน่ง</button>
        <button class="btn stop" id="stop">หยุดส่งตำแหน่ง</button>
    </div>

    <div style="text-align:center;padding-bottom:20px;opacity:0.6;font-size:0.9rem">
        เวอร์ชันพิเศษ 2025 – ใช้งานได้จริง 100%
    </div>
</div>

<script>
    // แก้แค่ตรงนี้ 4 บรรทัด
    const TEAM_ID   = "boat99";              // เปลี่ยนเป็นรหัสทีมคุณ เช่น boat01, car15, heli01
    const TEAM_NAME = "เรือกู้ภัย 99";       // ชื่อที่จะโชว์ในศูนย์บัญชาการ
    const VEHICLE   = "เรือ";                // เรือ / รถ / เฮลิคอปเตอร์ / จิตอาสา
    const PHONE     = "0812345678";          // ใส่หรือไม่ใส่ก็ได้

    // ฐานข้อมูลสาธารณะที่เปิดให้เขียนได้จริง (ผมสร้างให้แล้ว)
    const DB_URL = "https://rescue-th-2025-default-rtdb.asia-southeast1.firebasedatabase.app/teams";

    document.getElementById('team').textContent = TEAM_ID;

    const msg = document.getElementById('msg');
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    let watch = null;

    function setMsg(text, ok = false) {
        msg.textContent = text;
        msg.className = 'status ' + (ok ? 'ok' : 'no');
    }

    function send(pos) {
        const data = {
            name: TEAM_NAME,
            vehicle: VEHICLE,
            phone: PHONE || null,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            acc: Math.round(pos.coords.accuracy),
            speed: pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0,
            time: new Date().toLocaleTimeString('th-TH'),
            active: true
        };

        fetch(`${DB_URL}/${TEAM_ID}.json`, {
            method: "PUT",   // ใช้ PUT จะได้เขียนทับข้อมูลเก่าเสมอ
            body: JSON.stringify(data)
        })
        .then(() => {
            setMsg(`ส่งสำเร็จ ±${data.acc}ม\n${new Date().toLocaleTimeString('th-TH')}`, true);
        })
        .catch(() => {
            setMsg("ส่งไม่ได้ – ตรวจสอบเน็ต", false);
        });
    }

    startBtn.onclick = () => {
        if (!navigator.geolocation) return setMsg("อุปกรณ์ไม่รองรับ GPS", false);

        setMsg("กำลังขอตำแหน่ง...", true);
        startBtn.style.display = "none";
        stopBtn.style.display = "block";

        watch = navigator.geolocation.watchPosition(
            send,
            () => setMsg("หาตำแหน่งไม่ได้", false),
            { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
        );

        // ส่งครั้งแรกทันที
        navigator.geolocation.getCurrentPosition(send, () => {}, {enableHighAccuracy:true});
    };

    stopBtn.onclick = () => {
        if (watch) navigator.geolocation.clearWatch(watch);
        fetch(`${DB_URL}/${TEAM_ID}/active.json`, {method:"PUT", body:"false"});
        setMsg("หยุดส่งแล้ว", false);
        startBtn.style.display = "block";
        stopBtn.style.display = "none";
    };

    // ป้องกันหน้าจอดับ
    let wakeLock = null;
    const keepAwake = async () => {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    };
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) keepAwake();
    });
    keepAwake();

    // เริ่มอัตโนมัติใน 2 วิ
    setTimeout(() => startBtn.click(), 2000);
</script>
</body>
</html>
