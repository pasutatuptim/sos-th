<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>กู้ภัย GPS Realtime</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body,html{height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        .box{height:100vh;display:flex;flex-direction:column;justify-content:space-between;padding:20px;background:linear-gradient(135deg,#000,#0a1a2e)}
        .logo{font-size:90px;text-align:center;margin-top:40px;animation:float 3s infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
        h1{font-size:1.8rem;text-align:center;margin:15px 0;font-weight:800}
        .main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:30px}
        .status{padding:25px;border-radius:20px;background:rgba(255,255,255,0.12);text-align:center;font-size:1.4rem;width:90%;max-width:420px;backdrop-filter:blur(12px);border:3px solid transparent;min-height:120px}
        .status.ok{border-color:#27ae60;background:rgba(39,174,96,0.25)}
        .status.no{border-color:#e74c3c;background:rgba(231,76,60,0.25)}
        .team{position:fixed;top:15px;right:15px;background:rgba(0,0,0,0.7);padding:10px 18px;border-radius:15px;font-size:1rem;font-weight:bold}
        .acc{font-size:1rem;margin-top:8px;opacity:0.9}
    </style>
</head>
<body>

<div class="team" id="team">ทีม: โหลด...</div>

<div class="box">
    <div>
        <div class="logo">Boat</div>
        <h1>กู้ภัย GPS Realtime</h1>
    </div>

    <div class="main">
        <div class="status" id="msg">กดปุ่มเพื่อเริ่มส่งตำแหน่ง</div>
    </div>

    <div style="text-align:center;padding-bottom:30px;opacity:0.7;font-size:0.9rem">
        เปิดทิ้งไว้ตลอดภารกิจ • หน้าจอไม่ดับ
    </div>
</div>

<script>
    // แก้แค่ 3 บรรทัดนี้ตามทีม
    const urlParams = new URLSearchParams(window.location.search);
    const TEAM_ID = urlParams.get('t') || "boat01";  // เช่น ?t=boat05, car01, heli01
    const TEAM_NAME = urlParams.get('n') || "เรือกู้ภัย " + TEAM_ID.replace(/[^0-9]/g,'');
    const VEHICLE = "เรือ";

    // ฐานข้อมูล public จริง (ส่งได้ทันที)
    const DB = "https://rescue-th-flood-2025-default-rtdb.asia-southeast1.firebasedatabase.app/rescue_teams";

    document.getElementById('team').textContent = TEAM_NAME;

    const msg = document.getElementById('msg');
    function setMsg(text, ok = false) {
        msg.innerHTML = text.replace(/\n/g, '<br>') + '<div class="acc" id="acc"></div>';
        msg.className = 'status ' + (ok ? 'ok' : 'no');
    }

    let watch = null;
    async function send(pos) {
        const data = {
            name: TEAM_NAME,
            vehicle: VEHICLE,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            acc: Math.round(pos.coords.accuracy),
            speed: pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0,
            time: new Date().toISOString(),
            active: true
        };
        try {
            await fetch(`${DB}/${TEAM_ID}.json`, {method:"PUT", body:JSON.stringify(data)});
            setMsg(`ส่งสำเร็จ!<br>ความแม่นยำ ±${data.acc} เมตร<br>${new Date().toLocaleTimeString('th-TH')}`, true);
            document.getElementById('acc').textContent = `ความเร็ว ${data.speed} กม./ชม.`;
        } catch {
            setMsg("ส่งไม่ได้ – ตรวจสอบเน็ต", false);
        }
    }

    function start() {
        if (!navigator.geolocation) return setMsg("ไม่รองรับ GPS", false);
        setMsg("กำลังขอตำแหน่ง...", true);

        navigator.geolocation.getCurrentPosition(send, () => setMsg("กรุณากดอนุญาต GPS!", false), {enableHighAccuracy:true});

        watch = navigator.geolocation.watchPosition(send, () => {}, {
            enableHighAccuracy: true,
            maximumAge: 5000,
            timeout: 15000
        });
    }

    // ป้องกันหน้าจอดับ (สำคัญมาก!)
    let wakeLock = null;
    const keep = async () => {
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    };
    document.addEventListener('visibilitychange', () => { if (!document.hidden) keep(); });
    keep();

    // เริ่มอัตโนมัติทันทีที่โหลด
    setTimeout(start, 1000);
</script>
</body>
</html>
