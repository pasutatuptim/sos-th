<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามทีมกู้ภัย Realtime</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body,html{margin:0;padding:0;height:100%;font-family:'Sarabun',sans-serif;background:#000;color:#fff;overflow:hidden}
        #map{height:100vh;width:100%}
        .header{position:fixed;top:0;left:0;right:0;height:60px;background:#c41e3a;z-index:1000;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:800;box-shadow:0 4px 30px rgba(0,0,0,0.8);}
        .panel{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);padding:16px 24px;border-radius:20px;z-index:1000;border:3px solid #ffb300;box-shadow:0 10px 40px rgba(255,193,7,0.6);text-align:center;max-width:90%;}
        .panel input, .panel select, .panel button{
            padding:12px 16px;margin:6px 4px;border:none;border-radius:12px;font-size:1rem;font-family:'Sarabun',sans-serif;font-weight:700;
        }
        .panel input, .panel select{background:#222;color:#fff;}
        .panel button{background:#ffb300;color:#000;cursor:pointer;transition:0.3s;}
        .panel button:active{transform:scale(0.95);}
        .panel button.stop{background:#e74c3c;color:#fff;}
        #status{text-align:center;margin-top:10px;font-size:1.4rem;font-weight:800;}
        .online{color:#27ae60;}
        .offline{color:#e74c3c;}
    </style>
</head>
<body>

<div class="header">ระบบติดตามทีมกู้ภัย (Realtime)</div>
<div id="map"></div>

<!-- พาเนลสำหรับทีมกู้ภัย -->
<div class="panel" id="teamPanel">
    <div style="margin-bottom:12px;font-size:1.4rem;font-weight:800;color:#ffb300;">
        กรอกข้อมูลทีมแล้วกดเริ่มปฏิบัติการ
    </div>
    <input type="text" id="teamName" placeholder="ชื่อทีม (เช่น ทีมเรือราชประชา 1)" value="">
    <select id="vehicle">
        <option value="เรือ">เรือ</option>
        <option value="รถยกสูง">รถยกสูง</option>
        <option value="เฮลิคอปเตอร์">เฮลิคอปเตอร์</option>
        <option value="เจ็ทสกี">เจ็ทสกี</option>
        <option value="ทีมเดินเท้า">ทีมเดินเท้า</option>
    </select>
    <input type="tel" id="phone" placeholder="เบอร์โทร (ไม่บังคับ)">
    <br>
    <button onclick="startTracking()">เริ่มปฏิบัติการ</button>
    <button onclick="stopTracking()" class="stop" style="display:none;" id="stopBtn">หยุดปฏิบัติการ</button>
    <div id="status" class="offline">ยังไม่ได้เริ่ม</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// === ตั้งค่า Firebase ของคุณที่นี่ ===
const SOS_DB      = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/sos_requests';
const RESCUE_DB   = 'https://pasuta-sos-default-rtdb.asia-southeast1.firebasedatabase.app/rescue_teams';

// ตัวแปร
let map, marker, trail, watchId, teamId;

// สร้างแผนที่
map = L.map('map').setView([13.7563, 100.5018], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ไอคอนทีมกู้ภัย
const rescueIcon = L.divIcon({
    html: `<div style="width:50px;height:50px;background:#ffb300;border:6px solid #000;border-radius:50%;box-shadow:0 6px 30px rgba(0,0,0,0.8);animation:pulse 2s infinite;"></div>`,
    className: '', iconSize: [62,62], iconAnchor: [31,31]
});
const pulseStyle = `
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,193,7,0.8)}100%{box-shadow:0 0 0 20px rgba(255,193,7,0)}}
`;

// เริ่มติดตามตำแหน่ง
function startTracking() {
    const name = document.getElementById('teamName').value.trim();
    const vehicle = document.getElementById('vehicle').value;
    const phone = document.getElementById('phone').value.trim();

    if (!name) {
        alert('กรุณาใส่ชื่อทีม');
        return;
    }

    document.getElementById('teamPanel').style.borderColor = '#27ae60';
    document.getElementById('status').textContent = 'กำลังเชื่อมต่อ GPS...';
    document.getElementById('status').className = 'online';
    document.getElementById('stopBtn').style.display = 'inline-block';

    // สร้าง ID ทีม (สุ่มแต่ไม่ซ้ำ)
    teamId = 'team_' + Date.now() + '_' + Math.random().toString(36).substr(2,5);

    if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(pos => {
            const {latitude, longitude, accuracy, speed} = pos.coords;

            // อัปเดต Firebase
            fetch(`${RESCUE_DB}/${teamId}.json`, {
                method: 'PATCH',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    name, vehicle, phone,
                    lat: latitude,
                    lng: longitude,
                    speed: speed ? (speed * 3.6).toFixed(1) : 0, // m/s → km/h
                    accuracy,
                    active: true,
                    updatedAt: Date.now()
                })
            });

            // อัปเดตแผนที่
            if (!marker) {
                marker = L.marker([latitude, longitude], {icon: rescueIcon}).addTo(map);
                trail = L.polyline([], {color:'#ffb300', weight:6, opacity:0.8}).addTo(map);
                map.setView([latitude, longitude], 16);
            } else {
                marker.setLatLng([latitude, longitude]);
                trail.addLatLng([latitude, longitude]);
                if (trail.getLatLngs().length > 100) trail.getLatLngs().shift();
            }

            document.getElementById('status').innerHTML = `
                ออนไลน์<br>
                <small>ความเร็ว ${speed ? (speed*3.6).toFixed(1) : 0} กม./ชม. • ความแม่นยำ ±${accuracy.toFixed(0)}ม</small>
            `;

        }, err => {
            alert('ไม่สามารถเข้าถึงตำแหน่งได้ เปิด GPS ด้วยนะครับ');
            console.error(err);
        }, {enableHighAccuracy: true, maximumAge: 0, timeout: 10000});
    } else {
        alert('เบราว์เซอร์ไม่รองรับ GPS');
    }
}

// หยุดปฏิบัติการ
function stopTracking() {
    if (confirm('ยืนยันหยุดปฏิบัติการและหายจากศูนย์บัญชาการ?')) {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        if (marker) map.removeLayer(marker);
        if (trail) map.removeLayer(trail);

        // ลบตัวเองออกจากฐานข้อมูล
        fetch(`${RESCUE_DB}/${teamId}.json`, {method: 'DELETE'});

        document.getElementById('teamPanel').style.borderColor = '#ffb300';
        document.getElementById('status').textContent = 'หยุดปฏิบัติการแล้ว';
        document.getElementById('status').className = 'offline';
        document.getElementById('stopBtn').style.display = 'none';
        teamId = null;
    }
}

// ถ้ากลับมาหน้าเว็บแล้วเคยเริ่มไว้ → ดึงข้อมูลเก่ากลับมา
window.onload = () => {
    const style = document.createElement('style');
    style.textContent = pulseStyle;
    document.head.appendChild(style);
};
</script>

</body>
</html>
